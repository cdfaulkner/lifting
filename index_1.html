<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d0b14">
<title>Iron Log</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d0b14;
  --bg2: #13101e;
  --bg3: #1c1828;
  --bg4: #252033;
  --border: #2a2440;
  --border2: #372f52;
  --text: #f0eeff;
  --text2: #9b92c4;
  --text3: #5e5680;
  --accent: #a78bfa;
  --accent2: #8b6ef0;
  --accent-pink: #f472b6;
  --accent-blue: #60a5fa;
  --red: #f87171;
  --green: #34d399;
  --blue: #60a5fa;
  --mono: 'DM Mono', monospace;
  --display: 'Barlow Condensed', sans-serif;
  --body: 'Barlow', sans-serif;
  --r: 8px;
  --r2: 12px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bot: env(safe-area-inset-bottom, 0px);
  --gradient: linear-gradient(135deg, #7c3aed, #db2777);
  --gradient-soft: linear-gradient(135deg, rgba(124,58,237,0.15), rgba(219,39,119,0.1));
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: var(--body);
  font-size: 15px;
  overflow: hidden;
}

/* ── LAYOUT ── */
#app {
  display: flex;
  flex-direction: column;
  height: 100%;
  height: 100dvh;
}

#nav-bar {
  display: flex;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  padding-bottom: var(--safe-bot);
  flex-shrink: 0;
  z-index: 100;
  box-shadow: 0 -4px 20px rgba(124,58,237,0.08);
}

.nav-btn {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 10px 4px 8px;
  background: none;
  border: none;
  color: var(--text3);
  font-family: var(--body);
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  cursor: pointer;
  transition: color 0.15s;
}
.nav-btn svg { width: 22px; height: 22px; }
.nav-btn.active { color: var(--accent); }
.nav-btn.active svg { stroke: var(--accent); }

#content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding-top: var(--safe-top);
}

.screen { display: none; min-height: 100%; }
.screen.active { display: block; }

/* ── HEADER ── */
.page-header {
  padding: 20px 16px 12px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: baseline;
  gap: 12px;
}
.page-title {
  font-family: var(--display);
  font-size: 28px;
  font-weight: 800;
  letter-spacing: 0.02em;
  text-transform: uppercase;
}
.page-sub {
  font-size: 12px;
  color: var(--text3);
  font-family: var(--mono);
}

/* ── BUTTONS ── */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 16px;
  border-radius: var(--r);
  font-family: var(--body);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all 0.15s;
}
.btn-primary { background: var(--gradient); color: #fff; border: none; }
.btn-primary:active { opacity: 0.85; }
.btn-secondary { background: var(--bg3); color: var(--text); border: 1px solid var(--border2); }
.btn-secondary:active { background: var(--bg4); }
.btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border); }
.btn-ghost:active { background: var(--bg3); }
.btn-danger { background: transparent; color: var(--red); border: 1px solid var(--red); }
.btn-sm { padding: 6px 11px; font-size: 12px; }
.btn-icon { padding: 8px; border-radius: var(--r); }

/* ── CARDS ── */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 14px;
}

/* ── INPUTS ── */
input, textarea, select {
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: var(--r);
  color: var(--text);
  font-family: var(--body);
  font-size: 15px;
  padding: 10px 12px;
  width: 100%;
  outline: none;
  transition: border-color 0.15s;
  -webkit-appearance: none;
}
input:focus, textarea:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(167,139,250,0.15); }
input[type=number] { font-family: var(--mono); }
select option { background: var(--bg3); }

.input-row {
  display: flex;
  gap: 8px;
}
.input-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.input-label {
  font-size: 11px;
  color: var(--text3);
  font-family: var(--mono);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

/* ── TAGS ── */
.tag {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 600;
  font-family: var(--mono);
  text-transform: uppercase;
  letter-spacing: 0.04em;
}
.tag-muscle { background: rgba(96,165,250,0.12); color: var(--accent-blue); }
.tag-equipment { background: rgba(167,139,250,0.12); color: var(--accent); }
.tag-green { background: rgba(52,211,153,0.12); color: var(--green); }

/* ── DIVIDER ── */
.divider { height: 1px; background: var(--border); margin: 8px 0; }

/* ── BADGE ── */
.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px;
  height: 20px;
  padding: 0 5px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 700;
  font-family: var(--mono);
  background: var(--gradient);
  color: #fff;
}

/* ── MODAL ── */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  z-index: 200;
  display: none;
  align-items: flex-end;
  justify-content: center;
  backdrop-filter: blur(4px);
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-top: 1px solid rgba(167,139,250,0.2);
  border-radius: var(--r2) var(--r2) 0 0;
  width: 100%;
  max-width: 520px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  padding-bottom: var(--safe-bot);
}
.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 16px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.modal-title { font-family: var(--display); font-size: 20px; font-weight: 700; text-transform: uppercase; }
.modal-body { overflow-y: auto; flex: 1; padding: 12px 16px; }
.modal-footer { padding: 12px 16px; border-top: 1px solid var(--border); flex-shrink: 0; }

/* ── TOAST ── */
#toast {
  position: fixed;
  bottom: calc(70px + var(--safe-bot));
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--bg4);
  border: 1px solid var(--border2);
  border-radius: var(--r);
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 500;
  z-index: 500;
  opacity: 0;
  transition: all 0.25s;
  white-space: nowrap;
  pointer-events: none;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ════════════════════════════════════
   HOME / LOG SCREEN
════════════════════════════════════ */
#screen-home .session-bar {
  background: var(--gradient);
  color: #fff;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
}
#screen-home .session-bar-title {
  font-family: var(--display);
  font-size: 16px;
  font-weight: 700;
  text-transform: uppercase;
}
#screen-home .session-bar-time {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 500;
}

.workout-list { padding: 12px 16px; display: flex; flex-direction: column; gap: 10px; }

.workout-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 14px;
  cursor: pointer;
  transition: border-color 0.15s;
  active: border-color var(--border2);
}
.workout-card:active { border-color: var(--border2); background: var(--bg3); }
.workout-card-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 8px;
}
.workout-card-title {
  font-family: var(--display);
  font-size: 17px;
  font-weight: 700;
  text-transform: uppercase;
  line-height: 1.2;
}
.workout-card-date {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
  white-space: nowrap;
  flex-shrink: 0;
}
.workout-card-exercises {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.workout-card-exercise {
  font-size: 13px;
  color: var(--text2);
  display: flex;
  align-items: center;
  gap: 8px;
}
.workout-card-exercise::before {
  content: '';
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--text3);
  flex-shrink: 0;
}
.workout-card-meta {
  margin-top: 10px;
  display: flex;
  gap: 12px;
}
.workout-meta-item {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
}
.workout-meta-val { color: var(--text2); }

/* ════════════════════════════════════
   ACTIVE SESSION
════════════════════════════════════ */
#active-session {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 150;
  display: none;
  flex-direction: column;
  padding-top: var(--safe-top);
}
#active-session.open { display: flex; }

.session-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.session-name {
  font-family: var(--display);
  font-size: 20px;
  font-weight: 800;
  text-transform: uppercase;
  cursor: pointer;
}
.session-timer {
  font-family: var(--mono);
  font-size: 16px;
  font-weight: 500;
  color: var(--accent);
  min-width: 60px;
  text-align: center;
}
.session-body {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 12px 16px 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.session-footer {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
  flex-shrink: 0;
  padding-bottom: calc(12px + var(--safe-bot));
}

/* Exercise block in active session */
.ex-block {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  overflow: hidden;
}
.ex-block-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 14px;
  gap: 8px;
  cursor: pointer;
}
.ex-block-info { flex: 1; min-width: 0; }
.ex-name {
  font-family: var(--display);
  font-size: 16px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.02em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.ex-variant {
  font-size: 12px;
  color: var(--text3);
  font-family: var(--mono);
}
.ex-block-actions {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
}

/* Set rows */
.sets-table {
  width: 100%;
  border-collapse: collapse;
}
.sets-header {
  display: grid;
  grid-template-columns: 28px 1fr 1fr 36px;
  padding: 6px 14px;
  background: var(--bg3);
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}
.sets-header-cell {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}
.sets-header-cell:nth-child(2),
.sets-header-cell:nth-child(3) { text-align: center; }
.sets-header-cell:nth-child(4) { text-align: center; }

.set-row {
  display: grid;
  grid-template-columns: 28px 1fr 1fr 36px;
  align-items: center;
  padding: 0 14px;
  border-bottom: 1px solid var(--border);
  min-height: 44px;
  transition: background 0.15s;
}
.set-row:last-child { border-bottom: none; }
.set-row.completed { background: rgba(167,139,250,0.05); }
.set-row.completed .set-num { color: var(--accent); }

.set-num {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text3);
  font-weight: 500;
}

/* Inline editable cells */
.set-cell-input {
  background: transparent;
  border: none;
  color: var(--text);
  font-family: var(--mono);
  font-size: 15px;
  font-weight: 500;
  text-align: center;
  padding: 8px 4px;
  width: 100%;
  border-radius: var(--r);
  transition: background 0.15s;
  -webkit-appearance: none;
}
.set-cell-input:focus {
  background: var(--bg4);
  outline: 2px solid var(--accent);
  outline-offset: -2px;
  color: var(--text);
}
.set-row.completed .set-cell-input { color: var(--text2); }

.set-check {
  display: flex;
  align-items: center;
  justify-content: center;
}
.check-btn {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: 2px solid var(--border2);
  background: transparent;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  flex-shrink: 0;
}
.check-btn:active { transform: scale(0.9); }
.check-btn.done {
  background: var(--gradient);
  border-color: transparent;
}
.check-btn svg { width: 14px; height: 14px; }

/* Detail expand */
.set-detail {
  display: none;
  padding: 12px 14px;
  background: var(--bg3);
  border-top: 1px solid var(--border);
  gap: 10px;
  flex-direction: column;
}
.set-detail.open { display: flex; }
.set-detail-row { display: flex; gap: 8px; }

/* Add set / history row */
.ex-block-footer {
  padding: 10px 14px;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg3);
}
.prev-best {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
}
.prev-best span { color: var(--text2); }

/* ════════════════════════════════════
   TEMPLATES SCREEN
════════════════════════════════════ */
#screen-templates .template-list {
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.template-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 14px;
}
.template-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}
.template-name {
  font-family: var(--display);
  font-size: 18px;
  font-weight: 700;
  text-transform: uppercase;
}
.template-exercises {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.template-ex {
  font-size: 13px;
  color: var(--text2);
  display: flex;
  gap: 8px;
  align-items: center;
}
.template-ex::before {
  content: '';
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--text3);
  flex-shrink: 0;
}
.template-actions {
  margin-top: 12px;
  display: flex;
  gap: 8px;
}

/* ════════════════════════════════════
   EXERCISE LIBRARY
════════════════════════════════════ */
.library-search-bar {
  padding: 12px 16px 8px;
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 10;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.library-filters {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  padding-bottom: 2px;
  scrollbar-width: none;
}
.library-filters::-webkit-scrollbar { display: none; }
.filter-pill {
  flex-shrink: 0;
  padding: 5px 10px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 600;
  font-family: var(--mono);
  text-transform: uppercase;
  letter-spacing: 0.04em;
  border: 1px solid var(--border2);
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  transition: all 0.15s;
}
.filter-pill.active { background: var(--gradient); color: #fff; border-color: transparent; }

.library-list {
  padding: 8px 16px 16px;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.parent-group { margin-bottom: 8px; }
.parent-label {
  font-family: var(--display);
  font-size: 18px;
  font-weight: 700;
  text-transform: uppercase;
  padding: 10px 0 6px;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
}
.parent-label .muscle-tags { display: flex; gap: 4px; flex-wrap: wrap; }
.parent-label .count { font-family: var(--mono); font-size: 11px; color: var(--text3); font-weight: 400; }

.variant-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r);
  margin-bottom: 4px;
  cursor: pointer;
  transition: all 0.15s;
}
.variant-row:active { background: var(--bg3); }
.variant-row-left { display: flex; flex-direction: column; gap: 3px; }
.variant-name { font-size: 14px; font-weight: 500; }
.variant-equip-tags { display: flex; gap: 4px; flex-wrap: wrap; }

/* ════════════════════════════════════
   EXERCISE DETAIL / ANALYTICS
════════════════════════════════════ */
.detail-header {
  padding: 20px 16px 16px;
  border-bottom: 1px solid var(--border);
}
.detail-title {
  font-family: var(--display);
  font-size: 26px;
  font-weight: 800;
  text-transform: uppercase;
  line-height: 1.1;
}
.detail-subtitle { font-size: 14px; color: var(--text3); margin-top: 4px; }

.analytics-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  padding: 12px 16px;
}
.analytics-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 14px;
}
.analytics-label {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 6px;
}
.analytics-value {
  font-family: var(--display);
  font-size: 28px;
  font-weight: 800;
  line-height: 1;
}
.analytics-unit { font-size: 14px; color: var(--text2); font-weight: 400; }

.rep-max-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 4px;
}
.rep-max-table th {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  padding: 6px 8px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
.rep-max-table td {
  padding: 8px 8px;
  font-size: 13px;
  border-bottom: 1px solid var(--border);
}
.rep-max-table tr:last-child td { border-bottom: none; }
.rep-max-table td:nth-child(2) { font-family: var(--mono); font-weight: 600; }
.rep-max-table td:nth-child(3) { font-family: var(--mono); font-size: 11px; color: var(--text3); }

/* Mini chart */
.mini-chart {
  height: 80px;
  position: relative;
  overflow: hidden;
}
.mini-chart svg { width: 100%; height: 100%; }

/* History table */
.history-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.history-table th {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  padding: 6px 8px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
.history-table td {
  padding: 8px 8px;
  border-bottom: 1px solid var(--border);
  vertical-align: top;
}
.history-table tr:last-child td { border-bottom: none; }
.history-table td:nth-child(1) { font-family: var(--mono); font-size: 11px; color: var(--text3); white-space: nowrap; }
.history-table .sets-summary { display: flex; flex-direction: column; gap: 2px; }
.history-table .set-line { font-family: var(--mono); font-size: 12px; }

/* ════════════════════════════════════
   ANALYTICS / PROGRESS SCREEN
════════════════════════════════════ */
.stats-section {
  padding: 12px 16px;
}
.stats-section-title {
  font-family: var(--display);
  font-size: 16px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--text2);
  margin-bottom: 10px;
}

/* ════════════════════════════════════
   BODYWEIGHT
════════════════════════════════════ */
.bw-chart-wrap {
  padding: 16px;
}
.bw-chart-container {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 16px;
}
.bw-chart { height: 180px; position: relative; }
.bw-chart svg { width: 100%; height: 100%; overflow: visible; }
.bw-log-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
}
.bw-log-date { font-family: var(--mono); font-size: 12px; color: var(--text3); width: 80px; flex-shrink: 0; }
.bw-log-weight { font-family: var(--mono); font-size: 16px; font-weight: 600; }

/* ════════════════════════════════════
   SCROLL / MISC
════════════════════════════════════ */
::-webkit-scrollbar { width: 0; height: 0; }
.empty-state {
  padding: 40px 24px;
  text-align: center;
  color: var(--text3);
}
.empty-state-icon { font-size: 40px; margin-bottom: 12px; }
.empty-state-title { font-family: var(--display); font-size: 20px; font-weight: 700; text-transform: uppercase; color: var(--text2); margin-bottom: 6px; }
.empty-state-sub { font-size: 14px; line-height: 1.5; }

/* filter select row */
.filter-row {
  display: flex;
  gap: 8px;
  padding: 0 16px 12px;
}
.filter-row select { font-size: 13px; padding: 8px 10px; }

/* note textarea */
textarea { resize: none; }

/* section header w/ action */
.section-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px 8px;
}
.section-title {
  font-family: var(--display);
  font-size: 15px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--text2);
}

/* RM period filter */
.period-pills {
  display: flex;
  gap: 4px;
  padding: 0 16px 8px;
}
.period-pill {
  padding: 4px 10px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 600;
  font-family: var(--mono);
  border: 1px solid var(--border2);
  background: transparent;
  color: var(--text3);
  cursor: pointer;
}
.period-pill.active { background: var(--bg3); color: var(--text); border-color: var(--border2); }

/* timestamp in set detail */
.set-timestamp { font-family: var(--mono); font-size: 11px; color: var(--text3); }

/* Wide analytics card */
.analytics-card-wide {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 14px;
  margin: 0 16px 10px;
}

/* ════════════════════════════════════
   LOADING
════════════════════════════════════ */
#loading {
  position: fixed;
  inset: 0;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  z-index: 1000;
}
.loading-logo {
  font-family: var(--display);
  font-size: 40px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}
.loading-logo span { background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.loading-sub { font-family: var(--mono); font-size: 12px; color: var(--text3); }
.spinner {
  width: 32px;
  height: 32px;
  border: 2px solid var(--border2);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

</style>
</head>
<body>

<div id="loading">
  <div class="loading-logo">IRON<span>LOG</span></div>
  <div class="spinner"></div>
  <div class="loading-sub">Loading your data...</div>
</div>

<div id="app" style="display:none">

  <!-- ══ ACTIVE SESSION OVERLAY ══ -->
  <div id="active-session">
    <div class="session-header">
      <div id="session-back-btn" style="cursor:pointer;color:var(--text3);display:flex;align-items:center;gap:4px;font-size:13px;font-weight:600">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
        BACK
      </div>
      <div id="session-title" class="session-name">Workout</div>
      <div id="session-timer" class="session-timer">0:00</div>
    </div>
    <div id="session-body" class="session-body"></div>
    <div class="session-footer">
      <button class="btn btn-secondary btn-sm" id="session-add-ex-btn" style="flex:1">+ Add Exercise</button>
      <button class="btn btn-primary" id="session-finish-btn" style="flex:1">Finish</button>
    </div>
  </div>

  <div id="content">
    <!-- ══ HOME ══ -->
    <div id="screen-home" class="screen active">
      <div class="page-header">
        <div class="page-title">IRON<span style="background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">LOG</span></div>
        <div class="page-sub" id="home-stats-sub"></div>
      </div>
      <div id="active-banner"></div>
      <div class="section-row">
        <div class="section-title">Recent Workouts</div>
        <button class="btn btn-primary btn-sm" id="new-workout-btn">+ New</button>
      </div>
      <div id="recent-workouts" class="workout-list"></div>
    </div>

    <!-- ══ TEMPLATES ══ -->
    <div id="screen-templates" class="screen">
      <div class="page-header">
        <div class="page-title">Templates</div>
        <button class="btn btn-primary btn-sm" id="new-template-btn">+ New</button>
      </div>
      <div id="template-list" class="template-list"></div>
    </div>

    <!-- ══ LIBRARY ══ -->
    <div id="screen-library" class="screen">
      <div class="page-header">
        <div class="page-title">Library</div>
        <div class="page-sub" id="lib-count-sub"></div>
      </div>
      <div class="library-search-bar">
        <input id="lib-search" type="search" placeholder="Search exercises…" autocomplete="off">
        <div class="library-filters" id="lib-filters"></div>
      </div>
      <div class="filter-row">
        <select id="lib-equip-filter">
          <option value="">All Equipment</option>
        </select>
        <select id="lib-muscle-filter">
          <option value="">All Muscles</option>
        </select>
      </div>
      <div id="library-list" class="library-list"></div>
    </div>

    <!-- ══ PROGRESS ══ -->
    <div id="screen-progress" class="screen">
      <div class="page-header">
        <div class="page-title">Progress</div>
      </div>
      <!-- BW Chart -->
      <div class="bw-chart-wrap">
        <div style="font-family:var(--mono);font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);margin-bottom:8px">Bodyweight</div>
        <div class="bw-chart-container">
          <div id="bw-stats-row" style="display:flex;gap:20px;margin-bottom:12px"></div>
          <div class="bw-chart"><svg id="bw-svg"></svg></div>
          <div id="bw-period-pills" class="period-pills" style="margin-top:8px;padding:0"></div>
        </div>
      </div>
      <!-- Top Lifts -->
      <div class="section-row">
        <div class="section-title">Top Lifts (Est. 1RM)</div>
      </div>
      <div id="top-lifts-list" style="padding:0 16px 16px;display:flex;flex-direction:column;gap:8px"></div>
    </div>

    <!-- ══ MOBILITY ══ -->
    <div id="screen-mobility" class="screen">
      <div class="page-header">
        <div class="page-title">Mobility</div>
        <div class="page-sub" id="mobility-date-sub"></div>
      </div>
      <div style="padding:12px 16px 8px;display:flex;align-items:center;justify-content:space-between">
        <div style="font-family:var(--mono);font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em">Daily Checklist</div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-ghost btn-sm" id="mobility-reset-btn">Reset</button>
          <button class="btn btn-primary btn-sm" id="mobility-add-btn">+ Add</button>
        </div>
      </div>
      <div id="mobility-list" style="padding:0 16px 80px;display:flex;flex-direction:column;gap:6px"></div>
    </div>
  </div>

  <!-- ══ NAV ══ -->
  <nav id="nav-bar">
    <button class="nav-btn active" data-screen="home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Home
    </button>
    <button class="nav-btn" data-screen="templates">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      Templates
    </button>
    <button class="nav-btn" data-screen="library">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
      Library
    </button>
    <button class="nav-btn" data-screen="progress">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Progress
    </button>
    <button class="nav-btn" data-screen="mobility">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="3"/><path d="M12 11v4M8 17c0-2.2 1.8-4 4-4s4 1.8 4 4"/><path d="M6 21c0-3.3 2.7-6 6-6s6 2.7 6 6"/></svg>
      Mobility
    </button>
  </nav>
</div>

<!-- ══ MODALS ══ -->

<!-- New Workout / Pick Template -->
<div class="modal-overlay" id="modal-new-workout">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Start Workout</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-new-workout')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-primary" id="start-empty-btn" style="width:100%">Start Empty Workout</button>
      </div>
      <div style="margin:16px 0 8px;font-family:var(--mono);font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em">From Template</div>
      <div id="modal-template-list" style="display:flex;flex-direction:column;gap:6px"></div>
    </div>
  </div>
</div>

<!-- Exercise Picker (add exercise to session/template) -->
<div class="modal-overlay" id="modal-pick-exercise">
  <div class="modal" style="max-height:95vh">
    <div class="modal-header">
      <div class="modal-title" id="pick-ex-title">Add Exercise</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-pick-exercise')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" style="padding:8px 16px">
      <input id="pick-ex-search" type="search" placeholder="Search…" style="margin-bottom:8px" autocomplete="off">
      <div id="pick-ex-filters" style="display:flex;gap:6px;overflow-x:auto;padding-bottom:8px;scrollbar-width:none"></div>
      <div id="pick-ex-list" style="display:flex;flex-direction:column;gap:4px;max-height:60vh;overflow-y:auto"></div>
    </div>
  </div>
</div>

<!-- Set Detail Modal (notes, RPE, rest) -->
<div class="modal-overlay" id="modal-set-detail">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="set-detail-title">Set Detail</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-set-detail')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="input-row">
          <div class="input-group" style="flex:1">
            <div class="input-label">Weight (lbs)</div>
            <input id="detail-weight" type="number" step="0.5" placeholder="0">
          </div>
          <div class="input-group" style="flex:1">
            <div class="input-label">Reps</div>
            <input id="detail-reps" type="number" placeholder="0">
          </div>
        </div>
        <div class="input-row">
          <div class="input-group" style="flex:1">
            <div class="input-label">RPE (1-10)</div>
            <input id="detail-rpe" type="number" step="0.5" min="1" max="10" placeholder="—">
          </div>
          <div class="input-group" style="flex:1">
            <div class="input-label">Rest (sec)</div>
            <input id="detail-rest" type="number" placeholder="—">
          </div>
        </div>
        <div class="input-group">
          <div class="input-label">Notes</div>
          <textarea id="detail-notes" rows="3" placeholder="Form cues, how it felt…"></textarea>
        </div>
        <div id="detail-timestamp" class="set-timestamp"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="detail-save-btn" style="width:100%">Save</button>
    </div>
  </div>
</div>

<!-- Exercise Analytics View -->
<div class="modal-overlay" id="modal-exercise-detail">
  <div class="modal" style="max-height:95vh">
    <div class="modal-header">
      <div style="flex:1">
        <div class="modal-title" id="ex-detail-name"></div>
        <div id="ex-detail-sub" style="font-size:12px;color:var(--text3);font-family:var(--mono)"></div>
      </div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-exercise-detail')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" id="ex-detail-body" style="padding:0"></div>
  </div>
</div>

<!-- Template Editor -->
<div class="modal-overlay" id="modal-template-editor">
  <div class="modal" style="max-height:95vh">
    <div class="modal-header">
      <div class="modal-title" id="tmpl-editor-title">New Template</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-template-editor')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-group" style="margin-bottom:12px">
        <div class="input-label">Template Name</div>
        <input id="tmpl-name-input" type="text" placeholder="Push / Pull / Legs…">
      </div>
      <div id="tmpl-exercises-list" style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px"></div>
      <button class="btn btn-secondary" id="tmpl-add-ex-btn" style="width:100%">+ Add Exercise</button>
    </div>
    <div class="modal-footer" style="display:flex;gap:8px">
      <button class="btn btn-danger btn-sm" id="tmpl-delete-btn" style="display:none">Delete</button>
      <button class="btn btn-primary" id="tmpl-save-btn" style="flex:1">Save Template</button>
    </div>
  </div>
</div>

<!-- BW Entry -->
<div class="modal-overlay" id="modal-bw-entry">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Log Weight</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-bw-entry')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-row">
        <div class="input-group" style="flex:1">
          <div class="input-label">Date</div>
          <input id="bw-date-input" type="date">
        </div>
        <div class="input-group" style="flex:1">
          <div class="input-label">Weight (lbs)</div>
          <input id="bw-weight-input" type="number" step="0.1" placeholder="180.0">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="bw-save-btn" style="width:100%">Save</button>
    </div>
  </div>
</div>

<!-- Add Mobility Exercise Modal -->
<div class="modal-overlay" id="modal-mobility-add">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="mobility-modal-title">Add Mobility Exercise</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-mobility-add')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-group" style="margin-bottom:12px">
        <div class="input-label">Exercise Name</div>
        <input id="mobility-name-input" type="text" placeholder="e.g. Hip Flexor Stretch, Cat-Cow…">
      </div>
      <div class="input-group">
        <div class="input-label">Notes (optional)</div>
        <textarea id="mobility-notes-input" rows="2" placeholder="Duration, sets, cues…"></textarea>
      </div>
    </div>
    <div class="modal-footer" style="display:flex;gap:8px">
      <button class="btn btn-danger btn-sm" id="mobility-delete-btn" style="display:none">Delete</button>
      <button class="btn btn-primary" id="mobility-save-btn" style="flex:1">Save</button>
    </div>
  </div>
</div>

<!-- Variant Editor Modal -->
<div class="modal-overlay" id="modal-variant-editor">
  <div class="modal" style="max-height:90vh">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="variant-editor-title">Edit Variant</div>
        <div id="variant-editor-parent" style="font-size:12px;color:var(--text3);font-family:var(--mono)"></div>
      </div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-variant-editor')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-group" style="margin-bottom:12px">
        <div class="input-label">Variant Name</div>
        <input id="ve-name" type="text" placeholder="e.g. Flat (Barbell)">
      </div>
      <div class="input-group" style="margin-bottom:12px">
        <div class="input-label">Equipment Tags</div>
        <div id="ve-equip-checkboxes" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px"></div>
      </div>
      <div id="ve-analytics-btn-wrap" style="margin-top:4px">
        <button class="btn btn-ghost btn-sm" id="ve-analytics-btn" style="width:100%">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          View Analytics
        </button>
      </div>
    </div>
    <div class="modal-footer" style="display:flex;gap:8px">
      <button class="btn btn-danger btn-sm" id="ve-delete-btn">Delete Variant</button>
      <button class="btn btn-primary" id="ve-save-btn" style="flex:1">Save</button>
    </div>
  </div>
</div>

<!-- Add New Variant Modal -->
<div class="modal-overlay" id="modal-new-variant">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">New Variant</div>
        <div id="new-variant-parent-name" style="font-size:12px;color:var(--text3);font-family:var(--mono)"></div>
      </div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-new-variant')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-group" style="margin-bottom:12px">
        <div class="input-label">Variant Name</div>
        <input id="nv-name" type="text" placeholder="e.g. Incline (Barbell)">
      </div>
      <div class="input-group">
        <div class="input-label">Equipment Tags</div>
        <div id="nv-equip-checkboxes" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="nv-save-btn" style="width:100%">Add Variant</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ═══════════════════════════════════════════════════════════════
// DATA LAYER — IndexedDB via simple wrapper
// ═══════════════════════════════════════════════════════════════

const DB_NAME = 'ironlog';
const DB_VER = 2;
let db;

function openDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('sessions')) {
        const s = d.createObjectStore('sessions', { keyPath: 'id' });
        s.createIndex('startTime', 'startTime');
      }
      if (!d.objectStoreNames.contains('templates')) {
        d.createObjectStore('templates', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('bodyweight')) {
        const b = d.createObjectStore('bodyweight', { keyPath: 'date' });
        b.createIndex('date', 'date');
      }
      if (!d.objectStoreNames.contains('exercises')) {
        d.createObjectStore('exercises', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('mobility_exercises')) {
        d.createObjectStore('mobility_exercises', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('mobility_checks')) {
        d.createObjectStore('mobility_checks', { keyPath: 'date' });
      }
      if (!d.objectStoreNames.contains('variant_overrides')) {
        d.createObjectStore('variant_overrides', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('custom_variants')) {
        d.createObjectStore('custom_variants', { keyPath: 'id' });
      }
    };
    req.onsuccess = e => { db = e.target.result; res(db); };
    req.onerror = () => rej(req.error);
  });
}

function dbGet(store, key) {
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

function dbPut(store, val) {
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).put(val);
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

function dbDelete(store, key) {
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).delete(key);
    req.onsuccess = () => res();
    req.onerror = () => rej(req.error);
  });
}

function dbGetAll(store, indexName, query) {
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readonly');
    const os = tx.objectStore(store);
    const req = indexName ? os.index(indexName).getAll(query) : os.getAll();
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

function uid() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2,6);
}

// ═══════════════════════════════════════════════════════════════
// EXERCISE LIBRARY DATA
// ═══════════════════════════════════════════════════════════════
</script>
<script id="lib-data-script">
// Library injected by build
const EXERCISE_LIBRARY = {"equipment_types":["barbell","dumbbell","cable","machine","landmine","band","bodyweight","trap_bar","kettlebell","plate","suspension","voltra"],"muscle_groups":["chest","back","shoulders","biceps","triceps","quads","hamstrings","glutes","calves","core","forearms"],"movement_patterns":["push","pull","squat","hinge","carry","isolation","core"],"parents":[{"id":"bench_press","name":"Bench Press","primary_muscles":["chest"],"secondary_muscles":["triceps","shoulders"],"movement_pattern":"push","variants":[{"id":"bench_barbell_flat","name":"Flat (Barbell)","equipment":["barbell"]},{"id":"bench_barbell_incline","name":"Incline (Barbell)","equipment":["barbell"]},{"id":"bench_barbell_decline","name":"Decline (Barbell)","equipment":["barbell"]},{"id":"bench_barbell_close_grip","name":"Close Grip (Barbell)","equipment":["barbell"]},{"id":"bench_barbell_pause","name":"Pause (Barbell)","equipment":["barbell"]},{"id":"bench_barbell_bands","name":"With Bands (Barbell)","equipment":["barbell","band"]},{"id":"bench_barbell_guillotine","name":"Guillotine (Barbell)","equipment":["barbell"]},{"id":"bench_dumbbell_flat","name":"Flat (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_dumbbell_incline","name":"Incline (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_dumbbell_decline","name":"Decline (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_dumbbell_single_arm","name":"Single Arm (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_cable","name":"Cable","equipment":["cable"]},{"id":"bench_dumbbell_isometric","name":"Isometric (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_dumbbell_incline_squeeze","name":"Incline Squeeze Press (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_dumbbell_hex","name":"Hex Press (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_landmine_crush","name":"Crush Press (Landmine)","equipment":["landmine"]},{"id":"bench_plate_loaded","name":"Plate-Loaded Machine","equipment":["machine","plate"]}]},{"id":"chest_fly","name":"Chest Fly","primary_muscles":["chest"],"secondary_muscles":["shoulders"],"movement_pattern":"isolation","variants":[{"id":"fly_dumbbell_flat","name":"Flat (Dumbbell)","equipment":["dumbbell"]},{"id":"fly_dumbbell_incline","name":"Incline (Dumbbell)","equipment":["dumbbell"]},{"id":"fly_dumbbell_decline","name":"Decline (Dumbbell)","equipment":["dumbbell"]},{"id":"fly_cable_crossover","name":"Cable Crossover","equipment":["cable"]},{"id":"fly_cable_low","name":"Low Cable Crossover","equipment":["cable"]},{"id":"fly_cable_seated","name":"Seated Cable","equipment":["cable"]},{"id":"fly_machine_pec_deck","name":"Pec Deck Machine","equipment":["machine"]},{"id":"fly_machine","name":"Machine","equipment":["machine"]},{"id":"fly_band_flat","name":"Flat (Band)","equipment":["band"]},{"id":"fly_band_incline","name":"Incline (Band)","equipment":["band"]},{"id":"fly_band_decline","name":"Decline (Band)","equipment":["band"]},{"id":"fly_dumbbell_partial_bottom","name":"Partial Bottom Range (Dumbbell)","equipment":["dumbbell"]},{"id":"fly_cable_single_arm","name":"Single Arm Cable","equipment":["cable"]},{"id":"fly_judd","name":"Judd Flies","equipment":["cable"]},{"id":"fly_butterfly_ext","name":"Butterfly Extensions","equipment":["machine"]},{"id":"fly_dumbbell_incline_crush","name":"Incline Crush Press (Dumbbell)","equipment":["dumbbell"]}]},{"id":"push_up","name":"Push Up","primary_muscles":["chest"],"secondary_muscles":["triceps","shoulders"],"movement_pattern":"push","variants":[{"id":"pushup_bodyweight","name":"Bodyweight","equipment":["bodyweight"]},{"id":"pushup_weighted","name":"Weighted","equipment":["bodyweight","plate"]},{"id":"pushup_band","name":"Band","equipment":["band"]},{"id":"pushup_clap","name":"Clap","equipment":["bodyweight"]},{"id":"pushup_inclined_close_grip","name":"Incline Close Grip","equipment":["bodyweight"]}]},{"id":"dip","name":"Dip","primary_muscles":["chest"],"secondary_muscles":["triceps","shoulders"],"movement_pattern":"push","variants":[{"id":"dip_chest_bodyweight","name":"Chest Dip (Bodyweight)","equipment":["bodyweight"]},{"id":"dip_chest_weighted","name":"Chest Dip (Weighted)","equipment":["bodyweight"]},{"id":"dip_bench","name":"Bench Dip","equipment":["bodyweight"]},{"id":"dip_ring","name":"Ring Dip","equipment":["suspension"]},{"id":"dip_triceps_machine","name":"Machine","equipment":["machine"]},{"id":"dip_triceps_bar","name":"Triceps Dip (Bar)","equipment":["bodyweight"]}]},{"id":"pull_up","name":"Pull Up / Chin Up","primary_muscles":["back"],"secondary_muscles":["biceps"],"movement_pattern":"pull","variants":[{"id":"pullup_bodyweight","name":"Pull Up (Bodyweight)","equipment":["bodyweight"]},{"id":"pullup_weighted","name":"Pull Up (Weighted)","equipment":["bodyweight"]},{"id":"chinup_bodyweight","name":"Chin Up (Bodyweight)","equipment":["bodyweight"]},{"id":"chinup_weighted","name":"Chin Up (Weighted)","equipment":["bodyweight"]},{"id":"pullup_pelican","name":"Pelican Curl","equipment":["bodyweight"]}]},{"id":"lat_pulldown","name":"Lat Pulldown","primary_muscles":["back"],"secondary_muscles":["biceps"],"movement_pattern":"pull","variants":[{"id":"pulldown_cable_wide","name":"Wide Grip (Cable)","equipment":["cable"]},{"id":"pulldown_cable_close","name":"Close Grip (Cable)","equipment":["cable"]},{"id":"pulldown_cable_single_arm","name":"Single Arm (Cable)","equipment":["cable"]},{"id":"pulldown_cable_reverse_grip","name":"Reverse Grip (Cable)","equipment":["cable"]},{"id":"pulldown_plate_loaded","name":"Plate-Loaded Machine","equipment":["machine","plate"]}]},{"id":"row","name":"Row","primary_muscles":["back"],"secondary_muscles":["biceps","shoulders"],"movement_pattern":"pull","variants":[{"id":"row_barbell_bent_over","name":"Bent Over (Barbell)","equipment":["barbell"]},{"id":"row_barbell_chest_supported","name":"Chest Supported (Barbell)","equipment":["barbell"]},{"id":"row_dumbbell_single_arm","name":"Single Arm (Dumbbell)","equipment":["dumbbell"]},{"id":"row_dumbbell_bent_over","name":"Bent Over (Dumbbell)","equipment":["dumbbell"]},{"id":"row_dumbbell_chest_supported_incline","name":"Chest Supported Incline (Dumbbell)","equipment":["dumbbell"]},{"id":"row_cable_bar","name":"Seated Cable (Bar Grip)","equipment":["cable"]},{"id":"row_cable_v_grip","name":"Seated Cable (V Grip)","equipment":["cable"]},{"id":"row_cable_single_arm","name":"Single Arm Cable","equipment":["cable"]},{"id":"row_cable_high","name":"High Cable Row","equipment":["cable"]},{"id":"row_tbar","name":"T-Bar","equipment":["barbell"]},{"id":"row_landmine_tbar","name":"T-Bar (Landmine)","equipment":["landmine"]},{"id":"row_landmine_single_arm","name":"Single Arm (Landmine)","equipment":["landmine"]},{"id":"row_machine_seated","name":"Seated Machine","equipment":["machine"]},{"id":"row_machine_iso_lateral","name":"Iso-Lateral Machine","equipment":["machine"]},{"id":"row_machine_high_plate","name":"High Row (Plate-Loaded)","equipment":["machine","plate"]},{"id":"row_machine_high","name":"High Row Machine","equipment":["machine"]},{"id":"row_plate_single_arm","name":"Single Arm Plate","equipment":["plate"]},{"id":"row_inverted","name":"Inverted Row (Bodyweight)","equipment":["bodyweight"]},{"id":"row_inverted_weighted","name":"Inverted Row (Weighted)","equipment":["bodyweight"]},{"id":"row_suspension_single_arm","name":"Single Arm Suspension","equipment":["suspension"]},{"id":"row_voltra","name":"Voltra Row","equipment":["voltra"]},{"id":"row_fa","name":"FA Row","equipment":["bodyweight"]},{"id":"row_landmine_combo","name":"Row+Press (Landmine)","equipment":["landmine"]}]},{"id":"straight_arm_pulldown","name":"Straight Arm Pulldown","primary_muscles":["back"],"secondary_muscles":[],"movement_pattern":"pull","variants":[{"id":"sal_cable","name":"Cable","equipment":["cable"]},{"id":"sal_cable_iso_lateral","name":"Iso-Lateral Cable","equipment":["cable"]},{"id":"sal_rope","name":"Rope","equipment":["cable"]}]},{"id":"pullover","name":"Pullover","primary_muscles":["back"],"secondary_muscles":["chest"],"movement_pattern":"pull","variants":[{"id":"pullover_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"pullover_barbell","name":"Barbell","equipment":["barbell"]},{"id":"pullover_machine","name":"Machine","equipment":["machine"]}]},{"id":"back_extension","name":"Back Extension","primary_muscles":["hamstrings","glutes"],"secondary_muscles":["back"],"movement_pattern":"hinge","variants":[{"id":"back_ext_weighted","name":"Weighted (Freakathlete)","equipment":["bodyweight"]},{"id":"back_ext_single_leg","name":"Single Leg (Freakathlete)","equipment":["bodyweight"]},{"id":"back_ext_iso_hold","name":"Iso Hold (Freakathlete)","equipment":["bodyweight"]},{"id":"back_ext_single_leg_iso","name":"Single Leg Iso Hold (Freakathlete)","equipment":["bodyweight"]},{"id":"back_ext_reverse_hyper","name":"Reverse Hyperextension","equipment":["bodyweight"]}]},{"id":"overhead_press","name":"Overhead Press","primary_muscles":["shoulders"],"secondary_muscles":["triceps"],"movement_pattern":"push","variants":[{"id":"ohp_barbell_standing","name":"Standing (Barbell)","equipment":["barbell"]},{"id":"ohp_barbell_seated","name":"Seated (Barbell)","equipment":["barbell"]},{"id":"ohp_dumbbell_standing","name":"Standing (Dumbbell)","equipment":["dumbbell"]},{"id":"ohp_dumbbell_seated","name":"Seated (Dumbbell)","equipment":["dumbbell"]},{"id":"ohp_cable","name":"Cable","equipment":["cable"]},{"id":"ohp_machine","name":"Machine","equipment":["machine"]},{"id":"ohp_landmine_kneeling","name":"Kneeling (Landmine)","equipment":["landmine"]},{"id":"ohp_landmine_single","name":"Single Arm (Landmine)","equipment":["landmine"]},{"id":"ohp_landmine_standing","name":"Standing (Landmine)","equipment":["landmine"]},{"id":"ohp_landmine_jammer","name":"Jammer (Landmine)","equipment":["landmine"]},{"id":"ohp_dumbbell_arnold","name":"Arnold Press (Dumbbell)","equipment":["dumbbell"]}]},{"id":"lateral_raise","name":"Lateral Raise","primary_muscles":["shoulders"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"lat_raise_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"lat_raise_dumbbell_seated","name":"Seated (Dumbbell)","equipment":["dumbbell"]},{"id":"lat_raise_cable","name":"Cable","equipment":["cable"]},{"id":"lat_raise_cable_single_arm","name":"Single Arm Cable","equipment":["cable"]},{"id":"lat_raise_machine","name":"Machine","equipment":["machine"]},{"id":"lat_raise_band","name":"Band","equipment":["band"]},{"id":"front_raise_barbell","name":"Front Raise (Barbell)","equipment":["barbell"]},{"id":"front_raise_dumbbell","name":"Front Raise (Dumbbell)","equipment":["dumbbell"]},{"id":"front_raise_plate","name":"Front Raise (Plate)","equipment":["plate"]}]},{"id":"face_pull","name":"Face Pull","primary_muscles":["shoulders"],"secondary_muscles":["back"],"movement_pattern":"pull","variants":[{"id":"face_pull_cable","name":"Cable","equipment":["cable"]},{"id":"face_pull_band","name":"Band","equipment":["band"]}]},{"id":"upright_row","name":"Upright Row","primary_muscles":["shoulders"],"secondary_muscles":["biceps"],"movement_pattern":"pull","variants":[{"id":"upright_row_barbell","name":"Barbell","equipment":["barbell"]},{"id":"upright_row_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"upright_row_cable","name":"Cable","equipment":["cable"]},{"id":"upright_row_dumbbell_single","name":"Single Arm Dumbbell","equipment":["dumbbell"]},{"id":"upright_row_staggered_db_high_pull","name":"Staggered High Pull (Dumbbell)","equipment":["dumbbell"]}]},{"id":"rear_delt_fly","name":"Rear Delt Fly","primary_muscles":["shoulders"],"secondary_muscles":["back"],"movement_pattern":"isolation","variants":[{"id":"rear_delt_cable","name":"Cable","equipment":["cable"]},{"id":"rear_delt_dumbbell_chest_supported","name":"Chest Supported (Dumbbell)","equipment":["dumbbell"]},{"id":"rear_delt_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"rear_delt_machine","name":"Machine","equipment":["machine"]},{"id":"rear_delt_band","name":"Band","equipment":["band"]}]},{"id":"shrug","name":"Shrug","primary_muscles":["shoulders"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"shrug_barbell","name":"Barbell","equipment":["barbell"]},{"id":"shrug_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"shrug_cable","name":"Cable","equipment":["cable"]},{"id":"shrug_trap_bar","name":"Trap Bar","equipment":["trap_bar"]},{"id":"shrug_smith","name":"Smith Machine","equipment":["machine"]}]},{"id":"shoulder_rotation","name":"Shoulder Rotation","primary_muscles":["shoulders"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"shoulder_w_band","name":"W Rotation (Band)","equipment":["band"]},{"id":"band_pullaparts","name":"Pullaparts (Band)","equipment":["band"]},{"id":"sunrise_raises","name":"Sunrise Raises","equipment":["dumbbell"]},{"id":"clock_raises","name":"Clock Raises","equipment":["dumbbell"]},{"id":"jesus_raises","name":"Jesus Raises","equipment":["dumbbell"]}]},{"id":"bicep_curl","name":"Bicep Curl","primary_muscles":["biceps"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"curl_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"curl_dumbbell_incline_seated","name":"Incline Seated (Dumbbell)","equipment":["dumbbell"]},{"id":"curl_dumbbell_concentration","name":"Concentration (Dumbbell)","equipment":["dumbbell"]},{"id":"curl_dumbbell_spider","name":"Spider (Dumbbell)","equipment":["dumbbell"]},{"id":"curl_barbell","name":"Barbell","equipment":["barbell"]},{"id":"curl_barbell_ez","name":"EZ Bar","equipment":["barbell"]},{"id":"curl_barbell_preacher","name":"Preacher (Barbell)","equipment":["barbell"]},{"id":"curl_barbell_spider","name":"Spider (Barbell)","equipment":["barbell"]},{"id":"curl_cable","name":"Cable","equipment":["cable"]},{"id":"curl_cable_rope","name":"Rope (Cable)","equipment":["cable"]},{"id":"curl_cable_high","name":"High Cable (Bar)","equipment":["cable"]},{"id":"curl_cable_single_arm","name":"Single Arm (Cable)","equipment":["cable"]},{"id":"curl_dumbbell_hammer","name":"Hammer (Dumbbell)","equipment":["dumbbell"]},{"id":"curl_cable_hammer","name":"Hammer (Cable)","equipment":["cable"]},{"id":"curl_machine","name":"Machine","equipment":["machine"]},{"id":"curl_dumbbell_preacher","name":"Preacher (Dumbbell)","equipment":["dumbbell"]},{"id":"curl_dumbbell_zottman","name":"Zottman (Dumbbell)","equipment":["dumbbell"]},{"id":"curl_suspension","name":"Suspension Curl","equipment":["suspension"]},{"id":"curl_plate","name":"Plate Curl","equipment":["plate"]}]},{"id":"tricep_extension","name":"Tricep Extension","primary_muscles":["triceps"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"tri_ext_dumbbell_overhead","name":"Overhead (Dumbbell)","equipment":["dumbbell"]},{"id":"tri_ext_barbell_overhead","name":"Overhead (Barbell)","equipment":["barbell"]},{"id":"tri_ext_cable_overhead","name":"Overhead (Cable)","equipment":["cable"]},{"id":"tri_ext_cable_overhead_single","name":"Overhead Single Arm (Cable)","equipment":["cable"]},{"id":"tri_ext_cable_handle","name":"Cable Handle","equipment":["cable"]},{"id":"tri_ext_cable_handleless","name":"Cable Handleless","equipment":["cable"]},{"id":"tri_ext_machine","name":"Machine","equipment":["machine"]},{"id":"tri_ext_band","name":"Band","equipment":["band"]},{"id":"tri_ext_suspension_ring","name":"Ring Extension","equipment":["suspension"]},{"id":"tri_ext_suspension","name":"Suspension Extension","equipment":["suspension"]},{"id":"tri_ext_plate","name":"Plate Extension","equipment":["plate"]},{"id":"tri_ext_dumbbell_single","name":"Single Arm (Dumbbell)","equipment":["dumbbell"]}]},{"id":"tricep_pushdown","name":"Tricep Pushdown","primary_muscles":["triceps"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"tri_push_cable_bar","name":"Bar (Cable)","equipment":["cable"]},{"id":"tri_push_cable_rope","name":"Rope (Cable)","equipment":["cable"]},{"id":"tri_push_cable_reverse","name":"Reverse Grip (Cable)","equipment":["cable"]},{"id":"tri_push_cable_single","name":"Single Arm (Cable)","equipment":["cable"]},{"id":"tri_push_cable_single_handle","name":"Single Arm Handle (Cable)","equipment":["cable"]}]},{"id":"skullcrusher","name":"Skullcrusher","primary_muscles":["triceps"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"skull_barbell","name":"Barbell","equipment":["barbell"]},{"id":"skull_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"skull_cambered","name":"Cambered Close Grip","equipment":["barbell"]}]},{"id":"tricep_kickback","name":"Tricep Kickback","primary_muscles":["triceps"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"kickback_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"kickback_cable","name":"Cable","equipment":["cable"]}]},{"id":"squat","name":"Squat","primary_muscles":["quads"],"secondary_muscles":["glutes","hamstrings"],"movement_pattern":"squat","variants":[{"id":"squat_barbell_back","name":"Back Squat (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_front","name":"Front Squat (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_overhead","name":"Overhead Squat (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_pause","name":"Pause Squat (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_zercher","name":"Zercher Squat (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_cossack","name":"Cossack Squat (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_clean","name":"Squat Clean (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_thruster","name":"Thruster (Barbell)","equipment":["barbell"]},{"id":"squat_landmine","name":"Landmine Squat","equipment":["landmine"]},{"id":"squat_landmine_hack","name":"Landmine Hack Squat","equipment":["landmine"]},{"id":"squat_dumbbell_goblet","name":"Goblet (Dumbbell)","equipment":["dumbbell"]},{"id":"squat_kettlebell_goblet","name":"Goblet (Kettlebell)","equipment":["kettlebell"]},{"id":"squat_cable_goblet","name":"Goblet (Cable)","equipment":["cable"]},{"id":"squat_sissy","name":"Sissy Squat (Weighted)","equipment":["plate"]},{"id":"squat_sissy_cable","name":"Sissy Squat (Cable)","equipment":["cable"]},{"id":"squat_sissy_banded","name":"Sissy Squat (Band)","equipment":["band"]},{"id":"squat_spanish","name":"Spanish Squat","equipment":["band"]},{"id":"squat_belt","name":"Belt Squat","equipment":["machine"]},{"id":"squat_belt_cable","name":"Belt Squat (Cable)","equipment":["cable"]},{"id":"squat_box_pistol","name":"Box Pistol Squat","equipment":["bodyweight"]}]},{"id":"hack_squat","name":"Hack Squat","primary_muscles":["quads"],"secondary_muscles":["glutes"],"movement_pattern":"squat","variants":[{"id":"hack_squat_barbell","name":"Barbell","equipment":["barbell"]},{"id":"hack_squat_machine","name":"Machine","equipment":["machine"]}]},{"id":"leg_press","name":"Leg Press","primary_muscles":["quads"],"secondary_muscles":["glutes","hamstrings"],"movement_pattern":"squat","variants":[{"id":"leg_press_machine","name":"Machine","equipment":["machine"]},{"id":"leg_press_machine_horizontal","name":"Horizontal Machine","equipment":["machine"]},{"id":"leg_press_single_leg","name":"Single Leg Machine","equipment":["machine"]},{"id":"leg_press_calf","name":"Calf Press on Leg Press","equipment":["machine"]}]},{"id":"split_squat","name":"Split Squat / Lunge","primary_muscles":["quads"],"secondary_muscles":["glutes","hamstrings"],"movement_pattern":"squat","variants":[{"id":"split_squat_barbell","name":"Split Squat (Barbell)","equipment":["barbell"]},{"id":"split_squat_dumbbell","name":"Split Squat (Dumbbell)","equipment":["dumbbell"]},{"id":"split_squat_stationary","name":"Stationary Lunge","equipment":["bodyweight"]},{"id":"bulgarian_split_squat_bodyweight","name":"Bulgarian Split Squat (Bodyweight)","equipment":["bodyweight"]},{"id":"bulgarian_split_squat_barbell","name":"Bulgarian Split Squat (Barbell)","equipment":["barbell"]},{"id":"bulgarian_goblet","name":"Goblet Bulgarian Split Squat","equipment":["dumbbell"]},{"id":"lunge_dumbbell","name":"Lunge (Dumbbell)","equipment":["dumbbell"]},{"id":"lunge_barbell","name":"Lunge (Barbell)","equipment":["barbell"]},{"id":"step_up_dumbbell","name":"Step Up (Dumbbell)","equipment":["dumbbell"]}]},{"id":"leg_extension","name":"Leg Extension","primary_muscles":["quads"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"leg_ext_machine","name":"Machine","equipment":["machine"]},{"id":"leg_ext_plate_loaded","name":"Plate-Loaded","equipment":["machine","plate"]},{"id":"leg_ext_machine_iso","name":"Iso Machine","equipment":["machine"]},{"id":"leg_ext_reverse_nordic","name":"Reverse Nordic","equipment":["bodyweight"]}]},{"id":"deadlift","name":"Deadlift","primary_muscles":["hamstrings","glutes"],"secondary_muscles":["back","quads"],"movement_pattern":"hinge","variants":[{"id":"deadlift_barbell","name":"Conventional (Barbell)","equipment":["barbell"]},{"id":"deadlift_trap_bar","name":"Trap Bar","equipment":["trap_bar"]},{"id":"deadlift_landmine","name":"Landmine Deadlift","equipment":["landmine"]},{"id":"deadlift_jefferson_curl","name":"Jefferson Curl (Barbell)","equipment":["barbell"]},{"id":"deadlift_trap_bar_jump","name":"Trap Bar Jump","equipment":["trap_bar"]}]},{"id":"romanian_deadlift","name":"Romanian Deadlift","primary_muscles":["hamstrings","glutes"],"secondary_muscles":["back"],"movement_pattern":"hinge","variants":[{"id":"rdl_barbell","name":"Barbell","equipment":["barbell"]},{"id":"rdl_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"rdl_dumbbell_single_leg","name":"Single Leg (Dumbbell)","equipment":["dumbbell"]},{"id":"rdl_dumbbell_kneeling_single","name":"Kneeling Single Leg (Dumbbell)","equipment":["dumbbell"]},{"id":"rdl_voltra","name":"Voltra RDL","equipment":["voltra"]}]},{"id":"good_morning","name":"Good Morning","primary_muscles":["hamstrings"],"secondary_muscles":["back","glutes"],"movement_pattern":"hinge","variants":[{"id":"good_morning_barbell","name":"Barbell","equipment":["barbell"]},{"id":"good_morning_band","name":"Band","equipment":["band"]}]},{"id":"leg_curl","name":"Leg Curl","primary_muscles":["hamstrings"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"leg_curl_plate_loaded","name":"Plate-Loaded","equipment":["machine","plate"]},{"id":"leg_curl_machine_lying","name":"Lying Machine","equipment":["machine"]},{"id":"leg_curl_machine_iso","name":"Iso Machine","equipment":["machine"]},{"id":"ghd_leg_curl","name":"GHR / Nordic Hamstring Curl (Freakathlete)","equipment":["bodyweight"]},{"id":"nordic_hamstring","name":"Nordic Hamstring Curl","equipment":["bodyweight"]},{"id":"nordic_inclined","name":"Inclined Nordic Curl (Freakathlete)","equipment":["bodyweight"]},{"id":"voltra_ham_curl","name":"Standing Ham Curl (Voltra)","equipment":["voltra"]}]},{"id":"hip_thrust","name":"Hip Thrust","primary_muscles":["glutes"],"secondary_muscles":["hamstrings"],"movement_pattern":"hinge","variants":[{"id":"hip_thrust_barbell","name":"Barbell","equipment":["barbell"]},{"id":"hip_thrust_machine","name":"Machine","equipment":["machine"]}]},{"id":"calf_raise","name":"Calf Raise","primary_muscles":["calves"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"calf_seated","name":"Seated Machine","equipment":["machine"]},{"id":"calf_dumbbell_seated","name":"Seated (Dumbbell)","equipment":["dumbbell"]},{"id":"calf_barbell_seated","name":"Seated (Barbell)","equipment":["barbell"]},{"id":"calf_machine_press","name":"Machine Press","equipment":["machine"]},{"id":"calf_standing_machine","name":"Standing Machine","equipment":["machine"]},{"id":"calf_landmine","name":"Landmine Calf Raise","equipment":["landmine"]},{"id":"calf_hanging_landmine","name":"Hanging Landmine Calf Raise","equipment":["landmine"]},{"id":"calf_barbell_standing_single","name":"Single Leg Standing (Barbell)","equipment":["barbell"]},{"id":"calf_belt","name":"Belt Calf Raise","equipment":["machine"]},{"id":"calf_hanging_cable","name":"Hanging Cable Calf Raise","equipment":["cable"]},{"id":"calf_hanging_barbell","name":"Hanging Barbell Calf Raise","equipment":["barbell"]}]},{"id":"crunch","name":"Crunch","primary_muscles":["core"],"secondary_muscles":[],"movement_pattern":"core","variants":[{"id":"crunch_cable","name":"Cable Crunch","equipment":["cable"]},{"id":"crunch_machine","name":"Machine","equipment":["machine"]},{"id":"crunch_bench","name":"Bench Crunch","equipment":["bodyweight"]},{"id":"crunch_db","name":"Dumbbell Crunch","equipment":["dumbbell"]},{"id":"crunch_band","name":"Band Crunch","equipment":["band"]},{"id":"crunch_weighted","name":"Weighted Crunch","equipment":["plate"]},{"id":"crunch_ghd","name":"GHD Crunch (Freakathlete)","equipment":["bodyweight"]},{"id":"crunch_suspension","name":"Suspension Crunch","equipment":["suspension"]},{"id":"crunch_decline_weighted","name":"Decline Weighted","equipment":["bodyweight","plate"]}]},{"id":"leg_raise","name":"Leg Raise / Knee Raise","primary_muscles":["core"],"secondary_muscles":[],"movement_pattern":"core","variants":[{"id":"knee_raise_parallel","name":"Knee Raise (Parallel Bars)","equipment":["bodyweight"]},{"id":"hanging_leg_raise","name":"Hanging Leg Raise","equipment":["bodyweight"]},{"id":"hanging_knee_raise","name":"Hanging Knee Raise","equipment":["bodyweight"]},{"id":"leg_raise_decline_bench","name":"Decline Bench Leg Lifts","equipment":["bodyweight"]},{"id":"captains_chair","name":"Captain's Chair","equipment":["bodyweight"]},{"id":"ghd_leg_lift","name":"GHD Leg Lift (Freakathlete)","equipment":["bodyweight"]},{"id":"lying_leg_raise","name":"Lying Leg Raise","equipment":["bodyweight"]},{"id":"v_up","name":"V Up","equipment":["bodyweight"]},{"id":"jackknife_suspension","name":"Jackknife (Suspension)","equipment":["suspension"]}]},{"id":"ab_wheel","name":"Ab Wheel / Rollout","primary_muscles":["core"],"secondary_muscles":[],"movement_pattern":"core","variants":[{"id":"ab_wheel","name":"Ab Wheel","equipment":["bodyweight"]}]},{"id":"plank","name":"Plank","primary_muscles":["core"],"secondary_muscles":[],"movement_pattern":"core","variants":[{"id":"plank_standard","name":"Standard","equipment":["bodyweight"]},{"id":"plank_side","name":"Side Plank","equipment":["bodyweight"]},{"id":"plank_hollow_rock","name":"Hollow Rock","equipment":["bodyweight"]},{"id":"plank_bird_dog","name":"Bird Dog","equipment":["bodyweight"]},{"id":"plank_mountain_climber","name":"Mountain Climber","equipment":["bodyweight"]},{"id":"plank_v_up_weighted","name":"Weighted V-Ups","equipment":["plate"]}]},{"id":"pallof_press","name":"Pallof Press / Anti-Rotation","primary_muscles":["core"],"secondary_muscles":[],"movement_pattern":"core","variants":[{"id":"pallof_band","name":"Band","equipment":["band"]},{"id":"pallof_cable","name":"Cable","equipment":["cable"]},{"id":"pallof_twist_press","name":"Twist + Press","equipment":["cable","band"]},{"id":"cable_twist_up_down","name":"Cable Twist (Up to Down)","equipment":["cable"]},{"id":"kneeling_landmine_rotation","name":"Kneeling Rotation (Landmine)","equipment":["landmine"]},{"id":"russian_twist_weighted","name":"Weighted Russian Twist","equipment":["plate"]}]},{"id":"side_bend","name":"Side Bend / QL","primary_muscles":["core"],"secondary_muscles":[],"movement_pattern":"core","variants":[{"id":"side_bend_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"side_crunch_cable","name":"Side Crunch (Cable)","equipment":["cable"]},{"id":"weighted_ql_bend","name":"Weighted QL Bend","equipment":["dumbbell"]}]},{"id":"farmers_carry","name":"Farmer's Carry","primary_muscles":["core","forearms"],"secondary_muscles":["shoulders"],"movement_pattern":"carry","variants":[{"id":"farmers_carry_dumbbell","name":"Dumbbell","equipment":["dumbbell"]}]},{"id":"rowing_machine","name":"Rowing Machine","primary_muscles":["back"],"secondary_muscles":["quads","core"],"movement_pattern":"pull","variants":[{"id":"rowing_machine_cardio","name":"Rowing Machine","equipment":["machine"]}]}]};

// Build lookup maps
const variantMap = {}; // variantId -> {variant, parent}
const parentMap = {}; // parentId -> parent
EXERCISE_LIBRARY.parents.forEach(p => {
  parentMap[p.id] = p;
  p.variants.forEach(v => {
    variantMap[v.id] = { variant: v, parent: p };
  });
});

function getVariantDisplayName(variantId) {
  const info = variantMap[variantId];
  if (!info) return variantId;
  return `${info.parent.name} — ${info.variant.name}`;
}
function getParentForVariant(variantId) {
  return variantMap[variantId]?.parent;
}
</script>

<script>
// ═══════════════════════════════════════════════════════════════
// APP STATE
// ═══════════════════════════════════════════════════════════════
let activeSession = null; // current in-progress workout
let sessionTimerInterval = null;
let sessionStartEpoch = null;

let editingTemplateId = null;
let pendingPickExerciseCallback = null;
let editingSetContext = null; // {sessionExIndex, setIndex}

// ═══════════════════════════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════════════════════════
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`screen-${name}`)?.classList.add('active');
  document.querySelector(`[data-screen="${name}"]`)?.classList.add('active');

  if (name === 'home') renderHome();
  if (name === 'templates') renderTemplates();
  if (name === 'library') renderLibrary();
  if (name === 'progress') renderProgress();
  if (name === 'mobility') renderMobility();
}

document.querySelectorAll('.nav-btn').forEach(btn => {
  btn.addEventListener('click', () => showScreen(btn.dataset.screen));
});

// ═══════════════════════════════════════════════════════════════
// TOAST
// ═══════════════════════════════════════════════════════════════
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// ═══════════════════════════════════════════════════════════════
// MODALS
// ═══════════════════════════════════════════════════════════════
function openModal(id) {
  document.getElementById(id)?.classList.add('open');
}
function closeModal(id) {
  document.getElementById(id)?.classList.remove('open');
}
// Close on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) closeModal(overlay.id);
  });
});

// ═══════════════════════════════════════════════════════════════
// HOME SCREEN
// ═══════════════════════════════════════════════════════════════
async function renderHome() {
  const sessions = await dbGetAll('sessions');
  sessions.sort((a,b) => b.startTime - a.startTime);

  const sub = document.getElementById('home-stats-sub');
  sub.textContent = `${sessions.length} sessions logged`;

  const list = document.getElementById('recent-workouts');
  const recent = sessions.slice(0, 20);

  if (recent.length === 0) {
    list.innerHTML = `<div class="empty-state">
      <div class="empty-state-icon">💪</div>
      <div class="empty-state-title">No workouts yet</div>
      <div class="empty-state-sub">Tap + New to start your first session</div>
    </div>`;
    return;
  }

  list.innerHTML = recent.map(s => {
    const date = new Date(s.startTime);
    const dateStr = date.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
    const dur = s.durationMinutes ? `${s.durationMinutes}m` : '';
    const totalSets = s.exercises.reduce((acc, ex) => acc + ex.sets.filter(st => st.completed).length, 0);
    const exList = s.exercises.slice(0,4).map(ex => {
      const name = getVariantDisplayName(ex.variantId);
      const topSet = ex.sets.filter(st => st.completed && st.weight).sort((a,b) => b.weight - a.weight)[0];
      return `<div class="workout-card-exercise">${name}${topSet ? ` <span style="color:var(--text3);font-family:var(--mono);font-size:11px">${topSet.weight}×${topSet.reps}</span>` : ''}</div>`;
    }).join('');
    const more = s.exercises.length > 4 ? `<div style="font-size:11px;color:var(--text3);margin-top:2px">+${s.exercises.length - 4} more</div>` : '';

    return `<div class="workout-card" onclick="viewWorkoutDetail('${s.id}')">
      <div class="workout-card-header">
        <div class="workout-card-title">${escHtml(s.title)}</div>
        <div class="workout-card-date">${dateStr}</div>
      </div>
      <div class="workout-card-exercises">${exList}${more}</div>
      <div class="workout-card-meta">
        ${dur ? `<div class="workout-meta-item"><span class="workout-meta-val">${dur}</span></div>` : ''}
        <div class="workout-meta-item"><span class="workout-meta-val">${totalSets}</span> sets</div>
        <div class="workout-meta-item"><span class="workout-meta-val">${s.exercises.length}</span> exercises</div>
      </div>
    </div>`;
  }).join('');
}

document.getElementById('new-workout-btn').addEventListener('click', () => {
  openNewWorkoutModal();
});

async function openNewWorkoutModal() {
  const templates = await dbGetAll('templates');
  const list = document.getElementById('modal-template-list');
  list.innerHTML = templates.map(t => `
    <button class="btn btn-secondary" style="width:100%;text-align:left;justify-content:space-between" onclick="startFromTemplate('${t.id}')">
      <span style="font-family:var(--display);font-size:15px;text-transform:uppercase;letter-spacing:.02em">${escHtml(t.name)}</span>
      <span style="font-size:12px;color:var(--text3)">${t.exercises.length} exercises</span>
    </button>`).join('');
  if (templates.length === 0) {
    list.innerHTML = `<div style="font-size:13px;color:var(--text3);text-align:center;padding:12px 0">No templates yet</div>`;
  }
  openModal('modal-new-workout');
}

document.getElementById('start-empty-btn').addEventListener('click', () => {
  closeModal('modal-new-workout');
  startSession({title: 'Workout', exercises: []});
});

async function startFromTemplate(templateId) {
  closeModal('modal-new-workout');
  const tmpl = await dbGet('templates', templateId);
  if (!tmpl) return;
  // Build session exercises from template, prefilled from last session using same exercise
  const exPromises = tmpl.exercises.map(async (te) => {
    const lastSets = await getLastSetsForVariant(te.variantId);
    return {
      variantId: te.variantId,
      sets: (te.defaultSets || lastSets || []).map(s => ({...s, completed: false, completedAt: null, rpe: null, restSeconds: null, notes: ''}))
    };
  });
  const exercises = await Promise.all(exPromises);
  startSession({title: tmpl.name, exercises});
}

async function getLastSetsForVariant(variantId) {
  const sessions = await dbGetAll('sessions');
  const sorted = sessions.sort((a,b) => b.startTime - a.startTime);
  for (const s of sorted) {
    const ex = s.exercises.find(e => e.variantId === variantId);
    if (ex && ex.sets.some(st => st.completed)) {
      return ex.sets.filter(st => st.completed).map(st => ({weight: st.weight, reps: st.reps}));
    }
  }
  return [{weight: 0, reps: 8}, {weight: 0, reps: 8}, {weight: 0, reps: 8}];
}

// ═══════════════════════════════════════════════════════════════
// ACTIVE SESSION
// ═══════════════════════════════════════════════════════════════
function startSession(sessionData) {
  sessionStartEpoch = Date.now();
  activeSession = {
    id: uid(),
    title: sessionData.title,
    startTime: sessionStartEpoch,
    endTime: null,
    durationMinutes: null,
    exercises: sessionData.exercises.map(ex => ({
      variantId: ex.variantId,
      sets: ex.sets.map((s, i) => ({
        index: i,
        weight: s.weight || 0,
        reps: s.reps || 0,
        completed: false,
        completedAt: null,
        rpe: null,
        restSeconds: null,
        notes: ''
      }))
    }))
  };
  renderActiveSession();
  document.getElementById('active-session').classList.add('open');
  startTimer();
}

function startTimer() {
  clearInterval(sessionTimerInterval);
  sessionTimerInterval = setInterval(updateTimer, 1000);
  updateTimer();
}

function updateTimer() {
  if (!sessionStartEpoch) return;
  const elapsed = Math.floor((Date.now() - sessionStartEpoch) / 1000);
  const m = Math.floor(elapsed / 60);
  const s = elapsed % 60;
  document.getElementById('session-timer').textContent = `${m}:${s.toString().padStart(2,'0')}`;
}

function renderActiveSession() {
  if (!activeSession) return;
  document.getElementById('session-title').textContent = activeSession.title;

  const body = document.getElementById('session-body');
  body.innerHTML = activeSession.exercises.map((ex, exIdx) => {
    const info = variantMap[ex.variantId];
    const parentName = info ? info.parent.name : ex.variantId;
    const variantName = info ? info.variant.name : '';

    const completedCount = ex.sets.filter(s => s.completed).length;
    const totalCount = ex.sets.length;

    const setsHtml = `
      <div class="sets-header">
        <div class="sets-header-cell">#</div>
        <div class="sets-header-cell">LBS</div>
        <div class="sets-header-cell">REPS</div>
        <div class="sets-header-cell"></div>
      </div>
      ${ex.sets.map((set, si) => renderSetRow(exIdx, si, set)).join('')}
    `;

    return `<div class="ex-block" id="ex-block-${exIdx}">
      <div class="ex-block-header">
        <div class="ex-block-info">
          <div class="ex-name">${escHtml(parentName)}</div>
          <div class="ex-variant">${escHtml(variantName)}</div>
        </div>
        <div class="ex-block-actions">
          <button class="btn btn-ghost btn-sm btn-icon" onclick="showExerciseAnalyticsFromSession('${ex.variantId}')" title="History">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          </button>
          <button class="btn btn-ghost btn-sm btn-icon" onclick="removeExFromSession(${exIdx})" title="Remove">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      </div>
      ${setsHtml}
      <div class="ex-block-footer">
        <div class="prev-best" id="prev-best-${exIdx}">loading…</div>
        <button class="btn btn-ghost btn-sm" onclick="addSetToExercise(${exIdx})">+ Set</button>
      </div>
    </div>`;
  }).join('');

  // Load prev bests async
  activeSession.exercises.forEach((ex, idx) => loadPrevBest(ex.variantId, idx));

  attachSetInputListeners();
}

function renderSetRow(exIdx, si, set) {
  const w = set.weight || '';
  const r = set.reps || '';
  return `<div class="set-row ${set.completed ? 'completed' : ''}" id="set-row-${exIdx}-${si}">
    <div class="set-num">${si + 1}</div>
    <input class="set-cell-input" type="number" step="0.5" value="${w}" placeholder="—"
      data-ex="${exIdx}" data-set="${si}" data-field="weight"
      inputmode="decimal">
    <input class="set-cell-input" type="number" value="${r}" placeholder="—"
      data-ex="${exIdx}" data-set="${si}" data-field="reps"
      inputmode="numeric">
    <div class="set-check">
      <button class="check-btn ${set.completed ? 'done' : ''}"
        onclick="toggleSetComplete(${exIdx}, ${si})"
        id="check-${exIdx}-${si}">
        ${set.completed ? `<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>` : ''}
      </button>
    </div>
  </div>
  <div class="set-detail" id="set-detail-${exIdx}-${si}">
    <div class="set-detail-row">
      <button class="btn btn-ghost btn-sm" style="flex:1" onclick="openSetDetailModal(${exIdx},${si})">Notes / RPE / Rest…</button>
    </div>
  </div>`;
}

function attachSetInputListeners() {
  document.querySelectorAll('.set-cell-input').forEach(input => {
    input.addEventListener('change', e => {
      const exIdx = parseInt(e.target.dataset.ex);
      const si = parseInt(e.target.dataset.set);
      const field = e.target.dataset.field;
      const val = parseFloat(e.target.value) || 0;
      if (!activeSession) return;
      activeSession.exercises[exIdx].sets[si][field] = val;
    });
    // Long press on set row -> open detail
    input.addEventListener('contextmenu', e => {
      e.preventDefault();
      const exIdx = parseInt(e.target.dataset.ex);
      const si = parseInt(e.target.dataset.set);
      openSetDetailModal(exIdx, si);
    });
  });
}

function toggleSetComplete(exIdx, si) {
  if (!activeSession) return;
  const set = activeSession.exercises[exIdx].sets[si];

  // Read current input values before toggling
  const wInput = document.querySelector(`input[data-ex="${exIdx}"][data-set="${si}"][data-field="weight"]`);
  const rInput = document.querySelector(`input[data-ex="${exIdx}"][data-set="${si}"][data-field="reps"]`);
  if (wInput) set.weight = parseFloat(wInput.value) || 0;
  if (rInput) set.reps = parseInt(rInput.value) || 0;

  set.completed = !set.completed;
  set.completedAt = set.completed ? Date.now() : null;

  const row = document.getElementById(`set-row-${exIdx}-${si}`);
  const btn = document.getElementById(`check-${exIdx}-${si}`);
  if (set.completed) {
    row.classList.add('completed');
    btn.classList.add('done');
    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`;
  } else {
    row.classList.remove('completed');
    btn.classList.remove('done');
    btn.innerHTML = '';
  }
}

function addSetToExercise(exIdx) {
  if (!activeSession) return;
  const ex = activeSession.exercises[exIdx];
  const lastSet = ex.sets[ex.sets.length - 1] || {weight: 0, reps: 8};
  ex.sets.push({
    index: ex.sets.length,
    weight: lastSet.weight,
    reps: lastSet.reps,
    completed: false,
    completedAt: null,
    rpe: null,
    restSeconds: null,
    notes: ''
  });
  // Re-render just the sets area
  renderActiveSession();
}

function removeExFromSession(exIdx) {
  if (!activeSession) return;
  activeSession.exercises.splice(exIdx, 1);
  renderActiveSession();
}

async function loadPrevBest(variantId, idx) {
  const el = document.getElementById(`prev-best-${idx}`);
  if (!el) return;
  const sessions = await dbGetAll('sessions');
  const sorted = sessions.sort((a,b) => b.startTime - a.startTime);
  for (const s of sorted) {
    const ex = s.exercises.find(e => e.variantId === variantId);
    if (ex) {
      const completed = ex.sets.filter(st => st.completed && st.weight);
      if (completed.length > 0) {
        const top = completed.sort((a,b) => b.weight - a.weight)[0];
        const date = new Date(s.startTime).toLocaleDateString('en-US', {month:'short', day:'numeric'});
        el.innerHTML = `Prev: <span>${top.weight}×${top.reps}</span> <span style="color:var(--text3)">${date}</span>`;
        return;
      }
    }
  }
  el.innerHTML = `<span>First time</span>`;
}

// Set detail modal
function openSetDetailModal(exIdx, si) {
  if (!activeSession) return;
  editingSetContext = {exIdx, si};
  const set = activeSession.exercises[exIdx].sets[si];
  const exName = getVariantDisplayName(activeSession.exercises[exIdx].variantId);

  document.getElementById('set-detail-title').textContent = `Set ${si+1} — ${exName.split('—')[0].trim()}`;
  document.getElementById('detail-weight').value = set.weight || '';
  document.getElementById('detail-reps').value = set.reps || '';
  document.getElementById('detail-rpe').value = set.rpe || '';
  document.getElementById('detail-rest').value = set.restSeconds || '';
  document.getElementById('detail-notes').value = set.notes || '';

  const tsEl = document.getElementById('detail-timestamp');
  if (set.completedAt) {
    const dt = new Date(set.completedAt);
    tsEl.textContent = `Completed at ${dt.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', second:'2-digit'})}`;
  } else {
    tsEl.textContent = '';
  }

  openModal('modal-set-detail');
}

document.getElementById('detail-save-btn').addEventListener('click', () => {
  if (!editingSetContext || !activeSession) return;
  const {exIdx, si} = editingSetContext;
  const set = activeSession.exercises[exIdx].sets[si];
  set.weight = parseFloat(document.getElementById('detail-weight').value) || 0;
  set.reps = parseInt(document.getElementById('detail-reps').value) || 0;
  set.rpe = parseFloat(document.getElementById('detail-rpe').value) || null;
  set.restSeconds = parseInt(document.getElementById('detail-rest').value) || null;
  set.notes = document.getElementById('detail-notes').value.trim();

  // Update inline inputs
  const wInput = document.querySelector(`input[data-ex="${exIdx}"][data-set="${si}"][data-field="weight"]`);
  const rInput = document.querySelector(`input[data-ex="${exIdx}"][data-set="${si}"][data-field="reps"]`);
  if (wInput) wInput.value = set.weight || '';
  if (rInput) rInput.value = set.reps || '';

  closeModal('modal-set-detail');
  showToast('Set updated');
});

// Session add exercise
document.getElementById('session-add-ex-btn').addEventListener('click', () => {
  pendingPickExerciseCallback = (variantId) => {
    if (!activeSession) return;
    activeSession.exercises.push({
      variantId,
      sets: [{weight:0, reps:8, completed:false, completedAt:null, rpe:null, restSeconds:null, notes:''},
             {weight:0, reps:8, completed:false, completedAt:null, rpe:null, restSeconds:null, notes:''},
             {weight:0, reps:8, completed:false, completedAt:null, rpe:null, restSeconds:null, notes:''}]
    });
    renderActiveSession();
    closeModal('modal-pick-exercise');
  };
  document.getElementById('pick-ex-title').textContent = 'Add Exercise';
  openExercisePicker();
});

// Session back
document.getElementById('session-back-btn').addEventListener('click', () => {
  // Minimize session - go back to home with banner
  document.getElementById('active-session').classList.remove('open');
  renderHome();
  renderActiveBanner();
});

function renderActiveBanner() {
  const banner = document.getElementById('active-banner');
  if (!activeSession) { banner.innerHTML = ''; return; }
  const elapsed = Math.floor((Date.now() - sessionStartEpoch) / 1000);
  const m = Math.floor(elapsed / 60);
  const completedSets = activeSession.exercises.reduce((a, ex) => a + ex.sets.filter(s=>s.completed).length, 0);
  banner.innerHTML = `<div class="session-bar" onclick="document.getElementById('active-session').classList.add('open')">
    <div>
      <div class="session-bar-title">${escHtml(activeSession.title)}</div>
      <div style="font-size:11px;font-family:var(--mono)">${completedSets} sets completed</div>
    </div>
    <div class="session-bar-time">${m}m • Resume →</div>
  </div>`;
}

// Finish session
document.getElementById('session-finish-btn').addEventListener('click', async () => {
  if (!activeSession) return;
  clearInterval(sessionTimerInterval);
  activeSession.endTime = Date.now();
  activeSession.durationMinutes = Math.round((activeSession.endTime - activeSession.startTime) / 60000);

  await dbPut('sessions', activeSession);
  activeSession = null;
  document.getElementById('active-session').classList.remove('open');
  document.getElementById('active-banner').innerHTML = '';
  showToast('Workout saved!');
  renderHome();
});

// Session title edit
document.getElementById('session-title').addEventListener('click', () => {
  const newTitle = prompt('Workout name:', activeSession.title);
  if (newTitle?.trim()) {
    activeSession.title = newTitle.trim();
    document.getElementById('session-title').textContent = activeSession.title;
  }
});

// Show exercise detail from session
function showExerciseAnalyticsFromSession(variantId) {
  showExerciseAnalytics(variantId);
}

// ═══════════════════════════════════════════════════════════════
// VIEW WORKOUT DETAIL
// ═══════════════════════════════════════════════════════════════
async function viewWorkoutDetail(sessionId) {
  // For now, open exercise analytics for first exercise or show a summary
  const session = await dbGet('sessions', sessionId);
  if (!session) return;
  // Show a quick workout detail in the exercise detail modal
  const body = document.getElementById('ex-detail-body');
  const date = new Date(session.startTime).toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'});
  document.getElementById('ex-detail-name').textContent = session.title;
  document.getElementById('ex-detail-sub').textContent = `${date} · ${session.durationMinutes || '?'}m`;

  body.innerHTML = `<div style="padding:12px 16px">` + session.exercises.map(ex => {
    const name = getVariantDisplayName(ex.variantId);
    const sets = ex.sets.filter(s => s.completed);
    return `<div style="margin-bottom:14px">
      <div style="font-family:var(--display);font-size:15px;font-weight:700;text-transform:uppercase;margin-bottom:6px">${escHtml(name)}</div>
      ${sets.map((s, i) => {
        const ts = s.completedAt ? new Date(s.completedAt).toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', second:'2-digit'}) : '';
        const rpe = s.rpe ? ` · RPE ${s.rpe}` : '';
        const notes = s.notes ? `<div style="font-size:11px;color:var(--text3);margin-top:2px">${escHtml(s.notes)}</div>` : '';
        return `<div style="display:flex;justify-content:space-between;align-items:baseline;padding:5px 0;border-bottom:1px solid var(--border)">
          <div style="font-family:var(--mono);font-size:13px">${i+1}. ${s.weight}lbs × ${s.reps}${rpe}</div>
          <div style="font-family:var(--mono);font-size:10px;color:var(--text3)">${ts}</div>
        </div>${notes}`;
      }).join('')}
      ${sets.length === 0 ? '<div style="font-size:12px;color:var(--text3)">No sets completed</div>' : ''}
    </div>`;
  }).join('') + `</div>`;

  openModal('modal-exercise-detail');
}

// ═══════════════════════════════════════════════════════════════
// EXERCISE ANALYTICS
// ═══════════════════════════════════════════════════════════════
async function showExerciseAnalytics(variantId) {
  const info = variantMap[variantId];
  if (!info) return;
  const parentName = info.parent.name;
  const variantName = info.variant.name;

  document.getElementById('ex-detail-name').textContent = parentName;
  document.getElementById('ex-detail-sub').textContent = variantName + ' · ' + info.parent.primary_muscles.join(', ');

  const sessions = await dbGetAll('sessions');
  // Collect all sets for this variant
  const allSets = [];
  sessions.forEach(s => {
    const ex = s.exercises.find(e => e.variantId === variantId);
    if (ex) {
      ex.sets.filter(st => st.completed && st.weight && st.reps).forEach(st => {
        allSets.push({...st, sessionDate: s.startTime, sessionTitle: s.title});
      });
    }
  });

  // Also include sets from active session
  if (activeSession) {
    const ex = activeSession.exercises.find(e => e.variantId === variantId);
    if (ex) ex.sets.filter(st => st.weight && st.reps).forEach(st => allSets.push({...st, sessionDate: Date.now(), sessionTitle: activeSession.title}));
  }

  // 1RM (Epley): w * (1 + reps/30)
  function epley1RM(w, r) { return r === 1 ? w : w * (1 + r / 30); }
  const topRM = allSets.reduce((best, s) => Math.max(best, epley1RM(s.weight, s.reps)), 0);
  const maxWeight = allSets.reduce((best, s) => Math.max(best, s.weight), 0);

  // Rep-max table
  const repBuckets = [1,2,3,5,8,10,12,15];
  const repMaxes = repBuckets.map(rep => {
    const sets = allSets.filter(s => s.reps === rep);
    if (sets.length === 0) return {rep, weight: null, date: null};
    const best = sets.sort((a,b) => b.weight - a.weight)[0];
    return {rep, weight: best.weight, date: best.sessionDate};
  });

  // History (last 8 sessions with this exercise)
  const sessionMap = {};
  sessions.forEach(s => {
    const ex = s.exercises.find(e => e.variantId === variantId);
    if (ex && ex.sets.some(st => st.completed)) {
      sessionMap[s.id] = {date: s.startTime, sets: ex.sets.filter(st => st.completed)};
    }
  });
  const historyEntries = Object.values(sessionMap).sort((a,b) => b.date - a.date).slice(0, 8);

  // Max weight progression
  const progressByDate = {};
  sessions.forEach(s => {
    const ex = s.exercises.find(e => e.variantId === variantId);
    if (ex) {
      const maxW = Math.max(...ex.sets.filter(st => st.completed && st.weight).map(st => st.weight));
      if (maxW > 0) progressByDate[s.startTime] = maxW;
    }
  });
  const progressData = Object.entries(progressByDate).sort((a,b) => a[0]-b[0]).slice(-30);

  const body = document.getElementById('ex-detail-body');
  body.innerHTML = `
    <div class="analytics-grid">
      <div class="analytics-card">
        <div class="analytics-label">Est. 1RM</div>
        <div class="analytics-value">${topRM > 0 ? Math.round(topRM) : '—'} <span class="analytics-unit">lbs</span></div>
      </div>
      <div class="analytics-card">
        <div class="analytics-label">Max Weight</div>
        <div class="analytics-value">${maxWeight > 0 ? maxWeight : '—'} <span class="analytics-unit">lbs</span></div>
      </div>
    </div>

    ${progressData.length >= 2 ? `
    <div class="analytics-card-wide">
      <div class="analytics-label" style="margin-bottom:8px">Max Weight Over Time</div>
      <div class="mini-chart">${renderSparkline(progressData.map(d => d[1]))}</div>
    </div>` : ''}

    <div class="analytics-card-wide" style="padding:14px 0">
      <div class="analytics-label" style="padding:0 14px;margin-bottom:6px">Rep Max Table</div>
      <table class="rep-max-table">
        <thead><tr><th>Reps</th><th>Best Weight</th><th>Date</th></tr></thead>
        <tbody>
          ${repMaxes.filter(r => r.weight).map(r => `
            <tr>
              <td>${r.rep} rep${r.rep > 1?'s':''}</td>
              <td>${r.weight} lbs</td>
              <td>${r.date ? new Date(r.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'2-digit'}) : ''}</td>
            </tr>`).join('')}
          ${repMaxes.every(r => !r.weight) ? '<tr><td colspan="3" style="color:var(--text3);text-align:center">No data yet</td></tr>' : ''}
        </tbody>
      </table>
    </div>

    <div class="analytics-card-wide" style="padding:14px 0">
      <div class="analytics-label" style="padding:0 14px;margin-bottom:6px">Recent History</div>
      ${historyEntries.length === 0 ? '<div style="padding:0 14px;font-size:13px;color:var(--text3)">No history yet</div>' :
      `<table class="history-table">
        <thead><tr><th>Date</th><th>Sets</th></tr></thead>
        <tbody>
          ${historyEntries.map(h => `
            <tr>
              <td>${new Date(h.date).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</td>
              <td><div class="sets-summary">${h.sets.map(s =>
                `<div class="set-line">${s.weight}×${s.reps}${s.rpe ? ` @${s.rpe}` : ''}</div>`
              ).join('')}</div></td>
            </tr>`).join('')}
        </tbody>
      </table>`}
    </div>
  `;

  openModal('modal-exercise-detail');
}

function renderSparkline(values) {
  if (values.length < 2) return '';
  const min = Math.min(...values);
  const max = Math.max(...values);
  const range = max - min || 1;
  const w = 100;
  const h = 70;
  const pad = 4;
  const points = values.map((v, i) => {
    const x = pad + (i / (values.length - 1)) * (w - pad*2);
    const y = h - pad - ((v - min) / range) * (h - pad*2);
    return `${x},${y}`;
  }).join(' ');

  return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
    <defs>
      <linearGradient id="sg" x1="0" x2="0" y1="0" y2="1">
        <stop offset="0%" stop-color="var(--accent)" stop-opacity="0.3"/>
        <stop offset="100%" stop-color="var(--accent)" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <polygon points="${points} ${w-pad},${h-pad} ${pad},${h-pad}" fill="url(#sg)"/>
    <polyline points="${points}" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    <circle cx="${points.split(' ').slice(-1)[0].split(',')[0]}" cy="${points.split(' ').slice(-1)[0].split(',')[1]}" r="3" fill="var(--accent)"/>
  </svg>`;
}

// ═══════════════════════════════════════════════════════════════
// TEMPLATES
// ═══════════════════════════════════════════════════════════════
async function renderTemplates() {
  const templates = await dbGetAll('templates');
  const list = document.getElementById('template-list');
  if (templates.length === 0) {
    list.innerHTML = `<div class="empty-state">
      <div class="empty-state-icon">📋</div>
      <div class="empty-state-title">No templates yet</div>
      <div class="empty-state-sub">Create templates to start workouts quickly</div>
    </div>`;
    return;
  }
  list.innerHTML = templates.map(t => `
    <div class="template-card">
      <div class="template-card-header">
        <div class="template-name">${escHtml(t.name)}</div>
        <button class="btn btn-ghost btn-sm btn-icon" onclick="openTemplateEditor('${t.id}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
      </div>
      <div class="template-exercises">
        ${t.exercises.slice(0,5).map(ex => `<div class="template-ex">${escHtml(getVariantDisplayName(ex.variantId))}</div>`).join('')}
        ${t.exercises.length > 5 ? `<div style="font-size:11px;color:var(--text3)">+${t.exercises.length-5} more</div>` : ''}
      </div>
      <div class="template-actions">
        <button class="btn btn-primary btn-sm" onclick="startFromTemplate('${t.id}')">Start Workout</button>
      </div>
    </div>`).join('');
}

document.getElementById('new-template-btn').addEventListener('click', () => openTemplateEditor(null));

async function openTemplateEditor(templateId) {
  editingTemplateId = templateId;
  const deleteBtn = document.getElementById('tmpl-delete-btn');

  if (templateId) {
    const tmpl = await dbGet('templates', templateId);
    if (!tmpl) return;
    document.getElementById('tmpl-editor-title').textContent = 'Edit Template';
    document.getElementById('tmpl-name-input').value = tmpl.name;
    deleteBtn.style.display = '';
    renderTemplateExercises(tmpl.exercises);
  } else {
    document.getElementById('tmpl-editor-title').textContent = 'New Template';
    document.getElementById('tmpl-name-input').value = '';
    deleteBtn.style.display = 'none';
    renderTemplateExercises([]);
  }
  openModal('modal-template-editor');
}

let tmplExercises = [];
function renderTemplateExercises(exercises) {
  tmplExercises = exercises ? [...exercises] : [];
  const list = document.getElementById('tmpl-exercises-list');
  list.innerHTML = tmplExercises.map((ex, i) => `
    <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--bg3);border-radius:var(--r);border:1px solid var(--border)">
      <div style="flex:1;font-size:13px">${escHtml(getVariantDisplayName(ex.variantId))}</div>
      <div style="font-family:var(--mono);font-size:11px;color:var(--text3)">${(ex.defaultSets||[]).length} sets</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="removeTemplateEx(${i})">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>`).join('');
}

function removeTemplateEx(i) {
  tmplExercises.splice(i, 1);
  renderTemplateExercises(tmplExercises);
}

document.getElementById('tmpl-add-ex-btn').addEventListener('click', () => {
  pendingPickExerciseCallback = (variantId) => {
    tmplExercises.push({variantId, defaultSets: [{weight:0,reps:8},{weight:0,reps:8},{weight:0,reps:8}]});
    renderTemplateExercises(tmplExercises);
    closeModal('modal-pick-exercise');
  };
  document.getElementById('pick-ex-title').textContent = 'Add to Template';
  openExercisePicker();
});

document.getElementById('tmpl-save-btn').addEventListener('click', async () => {
  const name = document.getElementById('tmpl-name-input').value.trim();
  if (!name) { showToast('Enter a template name'); return; }
  const tmpl = {
    id: editingTemplateId || uid(),
    name,
    exercises: tmplExercises
  };
  await dbPut('templates', tmpl);
  closeModal('modal-template-editor');
  showToast('Template saved');
  renderTemplates();
});

document.getElementById('tmpl-delete-btn').addEventListener('click', async () => {
  if (!editingTemplateId) return;
  if (!confirm('Delete this template?')) return;
  await dbDelete('templates', editingTemplateId);
  closeModal('modal-template-editor');
  showToast('Template deleted');
  renderTemplates();
});

// ═══════════════════════════════════════════════════════════════
// EXERCISE PICKER MODAL
// ═══════════════════════════════════════════════════════════════
let pickerMuscleFilter = '';

function openExercisePicker() {
  pickerMuscleFilter = '';
  document.getElementById('pick-ex-search').value = '';
  renderPickerFilters();
  renderPickerList('');
  openModal('modal-pick-exercise');
}

function renderPickerFilters() {
  const container = document.getElementById('pick-ex-filters');
  const muscles = ['all', ...EXERCISE_LIBRARY.muscle_groups];
  container.innerHTML = muscles.map(m => `
    <button class="filter-pill ${pickerMuscleFilter === (m==='all'?'':m) ? 'active' : ''}"
      onclick="setPickerMuscle('${m === 'all' ? '' : m}')">
      ${m === 'all' ? 'All' : m}
    </button>`).join('');
}

function setPickerMuscle(m) {
  pickerMuscleFilter = m;
  renderPickerFilters();
  renderPickerList(document.getElementById('pick-ex-search').value);
}

document.getElementById('pick-ex-search').addEventListener('input', e => {
  renderPickerList(e.target.value);
});

function renderPickerList(query) {
  const q = query.toLowerCase().trim();
  const list = document.getElementById('pick-ex-list');
  const results = [];

  EXERCISE_LIBRARY.parents.forEach(parent => {
    if (pickerMuscleFilter && !parent.primary_muscles.includes(pickerMuscleFilter) && !parent.secondary_muscles.includes(pickerMuscleFilter)) return;
    parent.variants.forEach(v => {
      const fullName = `${parent.name} ${v.name}`.toLowerCase();
      if (q && !fullName.includes(q)) return;
      results.push({parent, variant: v});
    });
  });

  if (results.length === 0) {
    list.innerHTML = `<div style="padding:20px;text-align:center;color:var(--text3)">No exercises found</div>`;
    return;
  }

  list.innerHTML = results.slice(0, 80).map(({parent, variant}) => `
    <div class="variant-row" onclick="pickExercise('${variant.id}')">
      <div class="variant-row-left">
        <div class="variant-name">${escHtml(parent.name)} <span style="color:var(--text3)">— ${escHtml(variant.name)}</span></div>
        <div class="variant-equip-tags">
          ${variant.equipment.map(e => `<span class="tag tag-equipment">${e}</span>`).join('')}
        </div>
      </div>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
    </div>`).join('');
}

function pickExercise(variantId) {
  if (pendingPickExerciseCallback) {
    pendingPickExerciseCallback(variantId);
    pendingPickExerciseCallback = null;
  }
}

// ═══════════════════════════════════════════════════════════════
// LIBRARY SCREEN
// ═══════════════════════════════════════════════════════════════
let libMuscleFilter = '';
let libEquipFilter = '';

function renderLibrary() {
  const countEl = document.getElementById('lib-count-sub');
  const total = EXERCISE_LIBRARY.parents.reduce((a, p) => a + p.variants.length, 0);
  countEl.textContent = `${total} variants · ${EXERCISE_LIBRARY.parents.length} movements`;

  // Build filter pills
  const filtersEl = document.getElementById('lib-filters');
  const muscles = ['all', ...EXERCISE_LIBRARY.muscle_groups];
  filtersEl.innerHTML = muscles.map(m => `
    <button class="filter-pill ${libMuscleFilter === (m==='all'?'':m) ? 'active' : ''}"
      onclick="setLibMuscle('${m === 'all' ? '' : m}')">
      ${m}
    </button>`).join('');

  // Equipment dropdown
  const equipSel = document.getElementById('lib-equip-filter');
  if (equipSel.options.length <= 1) {
    EXERCISE_LIBRARY.equipment_types.forEach(e => {
      const opt = document.createElement('option');
      opt.value = e; opt.textContent = e;
      equipSel.appendChild(opt);
    });
  }
  const muscleSel = document.getElementById('lib-muscle-filter');
  if (muscleSel.options.length <= 1) {
    EXERCISE_LIBRARY.muscle_groups.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m;
      muscleSel.appendChild(opt);
    });
  }

  renderLibraryList(document.getElementById('lib-search').value);
}

function setLibMuscle(m) {
  libMuscleFilter = m;
  renderLibrary();
}

document.getElementById('lib-search').addEventListener('input', e => renderLibraryList(e.target.value));
document.getElementById('lib-equip-filter').addEventListener('change', e => { libEquipFilter = e.target.value; renderLibraryList(document.getElementById('lib-search').value); });
document.getElementById('lib-muscle-filter').addEventListener('change', e => { libMuscleFilter = e.target.value; renderLibrary(); });

function renderLibraryList(query) {
  const q = query.toLowerCase().trim();
  const list = document.getElementById('library-list');
  let html = '';

  EXERCISE_LIBRARY.parents.forEach(parent => {
    const muscleMatch = !libMuscleFilter || parent.primary_muscles.includes(libMuscleFilter) || parent.secondary_muscles.includes(libMuscleFilter);
    if (!muscleMatch) return;

    const variants = parent.variants.filter(v => {
      if (libEquipFilter && !v.equipment.includes(libEquipFilter)) return false;
      if (q) {
        const name = `${parent.name} ${v.name}`.toLowerCase();
        if (!name.includes(q)) return false;
      }
      return true;
    });
    if (variants.length === 0) return;

    const muscleTags = [...parent.primary_muscles].map(m => `<span class="tag tag-muscle">${m}</span>`).join('');
    html += `<div class="parent-group">
      <div class="parent-label">
        <span>${escHtml(parent.name)}</span>
        <span class="count">${variants.length}v</span>
        <div class="muscle-tags">${muscleTags}</div>
      </div>
      ${variants.map(v => `
        <div class="variant-row" style="cursor:default">
          <div class="variant-row-left" style="cursor:pointer;flex:1" onclick="showExerciseAnalytics('${v.id}')">
            <div class="variant-name">${escHtml(v.name)}</div>
            <div class="variant-equip-tags">${v.equipment.map(e => `<span class="tag tag-equipment">${e}</span>`).join('')}</div>
          </div>
          <button class="btn btn-ghost btn-sm btn-icon" onclick="openVariantEditor('${parent.id}','${v.id}')" title="Edit" style="flex-shrink:0;margin-left:4px">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </button>
        </div>`).join('')}
      <button class="btn btn-ghost btn-sm" onclick="openNewVariantModal('${parent.id}')" style="width:100%;margin-top:4px;margin-bottom:6px;border-style:dashed;color:var(--text3)">+ Add Variant</button>
    </div>`;
  });

  list.innerHTML = html || `<div class="empty-state"><div class="empty-state-title">No results</div></div>`;
}

// ═══════════════════════════════════════════════════════════════
// PROGRESS SCREEN
// ═══════════════════════════════════════════════════════════════
let bwPeriod = '3m';

async function renderProgress() {
  await renderBWChart();
  await renderTopLifts();
}

const BW_PERIODS = {'1m':30,'3m':90,'6m':180,'1y':365,'all':99999};

async function renderBWChart() {
  const entries = await dbGetAll('bodyweight');
  entries.sort((a,b) => a.date.localeCompare(b.date));

  const cutoff = Date.now() - BW_PERIODS[bwPeriod] * 86400000;
  const filtered = entries.filter(e => new Date(e.date).getTime() >= cutoff);
  const display = filtered.length > 0 ? filtered : entries.slice(-30);

  // Stats
  const statsRow = document.getElementById('bw-stats-row');
  if (display.length > 0) {
    const latest = display[display.length - 1];
    const oldest = display[0];
    const change = latest.weight_lbs - oldest.weight_lbs;
    const changeStr = (change >= 0 ? '+' : '') + change.toFixed(1);
    const changeColor = change <= 0 ? 'var(--green)' : 'var(--red)';
    statsRow.innerHTML = `
      <div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.06em">Current</div>
        <div style="font-family:var(--display);font-size:24px;font-weight:800">${latest.weight_lbs} <span style="font-size:13px;font-weight:400;color:var(--text2)">lbs</span></div>
      </div>
      <div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.06em">Change</div>
        <div style="font-family:var(--display);font-size:24px;font-weight:800;color:${changeColor}">${changeStr}</div>
      </div>`;
  } else {
    statsRow.innerHTML = `<div style="color:var(--text3);font-size:13px">No data</div>`;
  }

  // Period pills
  const pillsEl = document.getElementById('bw-period-pills');
  pillsEl.innerHTML = Object.keys(BW_PERIODS).map(p => `
    <button class="period-pill ${bwPeriod === p ? 'active' : ''}" onclick="setBWPeriod('${p}')">${p}</button>`).join('');

  // Chart
  renderBWSVG(display);
}

function setBWPeriod(p) {
  bwPeriod = p;
  renderBWChart();
}

function renderBWSVG(data) {
  const svg = document.getElementById('bw-svg');
  if (!data.length) { svg.innerHTML = ''; return; }

  const W = svg.parentElement.clientWidth || 300;
  const H = 160;
  const pad = {top: 10, right: 10, bottom: 20, left: 35};
  const iW = W - pad.left - pad.right;
  const iH = H - pad.top - pad.bottom;

  const weights = data.map(d => d.weight_lbs);
  const minW = Math.min(...weights) - 2;
  const maxW = Math.max(...weights) + 2;

  const toX = i => pad.left + (i / (data.length - 1)) * iW;
  const toY = w => pad.top + iH - ((w - minW) / (maxW - minW)) * iH;

  const linePoints = data.map((d, i) => `${toX(i)},${toY(d.weight_lbs)}`).join(' ');
  const areaPoints = `${pad.left},${pad.top + iH} ${linePoints} ${pad.left + iW},${pad.top + iH}`;

  // Y axis labels
  const ySteps = 4;
  const yLabels = Array.from({length: ySteps+1}, (_, i) => {
    const val = minW + (i/ySteps) * (maxW - minW);
    const y = toY(val);
    return `<text x="${pad.left - 4}" y="${y + 4}" text-anchor="end" fill="var(--text3)" font-size="9" font-family="DM Mono, monospace">${Math.round(val)}</text>`;
  }).join('');

  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  svg.innerHTML = `
    <defs>
      <linearGradient id="bwg" x1="0" x2="0" y1="0" y2="1">
        <stop offset="0%" stop-color="var(--accent)" stop-opacity="0.25"/>
        <stop offset="100%" stop-color="var(--accent)" stop-opacity="0"/>
      </linearGradient>
    </defs>
    ${yLabels}
    <line x1="${pad.left}" y1="${pad.top}" x2="${pad.left}" y2="${pad.top + iH}" stroke="var(--border)" stroke-width="1"/>
    <polygon points="${areaPoints}" fill="url(#bwg)"/>
    <polyline points="${linePoints}" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <circle cx="${toX(data.length-1)}" cy="${toY(data[data.length-1].weight_lbs)}" r="4" fill="var(--accent)"/>
  `;
}

async function renderTopLifts() {
  const sessions = await dbGetAll('sessions');
  const best1RM = {};

  sessions.forEach(s => {
    s.exercises.forEach(ex => {
      ex.sets.filter(st => st.completed && st.weight && st.reps).forEach(st => {
        const rm = st.weight * (1 + st.reps / 30);
        if (!best1RM[ex.variantId] || rm > best1RM[ex.variantId].rm) {
          best1RM[ex.variantId] = {rm, weight: st.weight, reps: st.reps, date: s.startTime};
        }
      });
    });
  });

  const sorted = Object.entries(best1RM)
    .sort((a,b) => b[1].rm - a[1].rm)
    .slice(0, 12);

  const list = document.getElementById('top-lifts-list');
  if (sorted.length === 0) {
    list.innerHTML = `<div style="color:var(--text3);font-size:13px;text-align:center;padding:20px 0">Log workouts to see your top lifts</div>`;
    return;
  }

  list.innerHTML = sorted.map(([variantId, data]) => {
    const name = getVariantDisplayName(variantId);
    const date = new Date(data.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'2-digit'});
    return `<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);padding:12px 14px;cursor:pointer;display:flex;align-items:center;gap:12px" onclick="showExerciseAnalytics('${variantId}')">
      <div style="flex:1">
        <div style="font-size:13px;font-weight:600">${escHtml(name)}</div>
        <div style="font-family:var(--mono);font-size:11px;color:var(--text3)">${data.weight}×${data.reps} · ${date}</div>
      </div>
      <div style="text-align:right">
        <div style="font-family:var(--display);font-size:22px;font-weight:800;color:var(--accent)">${Math.round(data.rm)}</div>
        <div style="font-family:var(--mono);font-size:9px;color:var(--text3)">EST 1RM</div>
      </div>
    </div>`;
  }).join('');
}

// Log BW button
document.getElementById('bw-stats-row').addEventListener('click', () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('bw-date-input').value = today;
  document.getElementById('bw-weight-input').value = '';
  openModal('modal-bw-entry');
});

document.getElementById('bw-save-btn').addEventListener('click', async () => {
  const date = document.getElementById('bw-date-input').value;
  const weight = parseFloat(document.getElementById('bw-weight-input').value);
  if (!date || !weight) { showToast('Enter date and weight'); return; }
  await dbPut('bodyweight', {date, weight_lbs: weight});
  closeModal('modal-bw-entry');
  showToast('Weight logged');
  renderBWChart();
});

// Add BW button
const bwBtn = document.createElement('button');
bwBtn.className = 'btn btn-secondary btn-sm';
bwBtn.textContent = '+ Log Weight';
bwBtn.style.cssText = 'position:absolute;top:16px;right:16px';
bwBtn.addEventListener('click', () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('bw-date-input').value = today;
  document.getElementById('bw-weight-input').value = '';
  openModal('modal-bw-entry');
});
document.querySelector('.bw-chart-wrap').style.position = 'relative';
document.querySelector('.bw-chart-wrap').appendChild(bwBtn);

// ═══════════════════════════════════════════════════════════════
// SEED DATA
// ═══════════════════════════════════════════════════════════════
async function seedBWData() {
  const existing = await dbGetAll('bodyweight');
  if (existing.length > 0) return; // already seeded

  // Show loading toast
  showToast('Importing 8 years of bodyweight data…');

  // Fetch BW data
  const bwData = await fetch('bw_data.json').then(r => r.json()).catch(() => null);
  if (bwData && Array.isArray(bwData)) {
    const tx = db.transaction('bodyweight', 'readwrite');
    const store = tx.objectStore('bodyweight');
    bwData.forEach(entry => store.put(entry));
    await new Promise(res => { tx.oncomplete = res; });
    showToast(`Imported ${bwData.length} bodyweight entries`);
  }
}

async function seedDefaultTemplates() {
  const existing = await dbGetAll('templates');
  if (existing.length > 0) return;

  const templates = [
    {
      id: uid(),
      name: 'Push',
      exercises: [
        {variantId: 'bench_barbell_flat', defaultSets: [{weight:225,reps:5},{weight:225,reps:5},{weight:225,reps:5},{weight:225,reps:5},{weight:225,reps:5}]},
        {variantId: 'ohp_landmine_standing', defaultSets: [{weight:90,reps:10},{weight:90,reps:10},{weight:90,reps:10}]},
        {variantId: 'dip_chest_weighted', defaultSets: [{weight:45,reps:10},{weight:45,reps:10},{weight:45,reps:10}]},
        {variantId: 'lat_raise_dumbbell', defaultSets: [{weight:25,reps:15},{weight:25,reps:15},{weight:25,reps:15},{weight:25,reps:15}]},
        {variantId: 'tri_push_cable_rope', defaultSets: [{weight:50,reps:12},{weight:50,reps:12},{weight:50,reps:12}]},
      ]
    },
    {
      id: uid(),
      name: 'Pull',
      exercises: [
        {variantId: 'pulldown_cable_close', defaultSets: [{weight:125,reps:12},{weight:160,reps:12},{weight:160,reps:12},{weight:160,reps:12}]},
        {variantId: 'row_barbell_bent_over', defaultSets: [{weight:185,reps:8},{weight:185,reps:8},{weight:185,reps:8},{weight:185,reps:8}]},
        {variantId: 'pullup_weighted', defaultSets: [{weight:25,reps:8},{weight:25,reps:8},{weight:25,reps:8}]},
        {variantId: 'face_pull_cable', defaultSets: [{weight:40,reps:15},{weight:40,reps:15},{weight:40,reps:15}]},
        {variantId: 'curl_dumbbell', defaultSets: [{weight:40,reps:12},{weight:40,reps:12},{weight:40,reps:12}]},
      ]
    },
    {
      id: uid(),
      name: 'Legs',
      exercises: [
        {variantId: 'squat_barbell_back', defaultSets: [{weight:225,reps:8},{weight:275,reps:5},{weight:315,reps:3},{weight:315,reps:3},{weight:315,reps:3}]},
        {variantId: 'rdl_barbell', defaultSets: [{weight:225,reps:8},{weight:225,reps:8},{weight:225,reps:8}]},
        {variantId: 'leg_press_machine', defaultSets: [{weight:270,reps:12},{weight:270,reps:12},{weight:270,reps:12}]},
        {variantId: 'leg_ext_plate_loaded', defaultSets: [{weight:90,reps:15},{weight:90,reps:15},{weight:90,reps:15}]},
        {variantId: 'calf_landmine', defaultSets: [{weight:90,reps:15},{weight:90,reps:15},{weight:90,reps:15}]},
      ]
    },
    {
      id: uid(),
      name: 'Full Body',
      exercises: [
        {variantId: 'squat_barbell_back', defaultSets: [{weight:225,reps:5},{weight:275,reps:5},{weight:275,reps:5}]},
        {variantId: 'bench_barbell_flat', defaultSets: [{weight:185,reps:8},{weight:185,reps:8},{weight:185,reps:8}]},
        {variantId: 'pullup_weighted', defaultSets: [{weight:25,reps:8},{weight:25,reps:8},{weight:25,reps:8}]},
        {variantId: 'rdl_barbell', defaultSets: [{weight:185,reps:10},{weight:185,reps:10},{weight:185,reps:10}]},
        {variantId: 'ohp_landmine_standing', defaultSets: [{weight:80,reps:10},{weight:80,reps:10},{weight:80,reps:10}]},
        {variantId: 'crunch_cable', defaultSets: [{weight:70,reps:15},{weight:70,reps:15},{weight:70,reps:15}]},
      ]
    }
  ];

  for (const t of templates) await dbPut('templates', t);
}

// ═══════════════════════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════════════════════
function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ═══════════════════════════════════════════════════════════════
// MOBILITY CHECKLIST
// ═══════════════════════════════════════════════════════════════
let mobilityExercises = []; // persisted in IDB store 'mobility_exercises'
let mobilityChecks = {}; // {exerciseId: bool} — reset daily, stored in 'mobility_checks'

function todayStr() { return new Date().toISOString().split('T')[0]; }

async function loadMobility() {
  const exList = await dbGetAll('mobility_exercises');
  mobilityExercises = exList.sort((a,b) => (a.order||0) - (b.order||0));
  const checkData = await dbGet('mobility_checks', todayStr());
  mobilityChecks = checkData ? checkData.checks : {};
}

async function saveMobilityChecks() {
  await dbPut('mobility_checks', {date: todayStr(), checks: mobilityChecks});
}

async function renderMobility() {
  await loadMobility();
  const subEl = document.getElementById('mobility-date-sub');
  const today = new Date();
  subEl.textContent = today.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric'});

  const list = document.getElementById('mobility-list');
  const completedCount = mobilityExercises.filter(ex => mobilityChecks[ex.id]).length;

  if (mobilityExercises.length === 0) {
    list.innerHTML = `<div class="empty-state">
      <div class="empty-state-icon" style="font-size:36px">🧘</div>
      <div class="empty-state-title">No Mobility Exercises</div>
      <div class="empty-state-sub">Tap + Add to build your daily mobility checklist</div>
    </div>`;
    return;
  }

  const allDone = completedCount === mobilityExercises.length;
  list.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 0 10px">
      <div style="font-family:var(--mono);font-size:12px;color:var(--text3)">${completedCount}/${mobilityExercises.length} complete</div>
      ${allDone ? `<div style="font-size:12px;color:var(--accent);font-weight:600">✓ All done!</div>` : ''}
    </div>
    <div style="height:4px;background:var(--bg3);border-radius:99px;margin-bottom:14px;overflow:hidden">
      <div style="height:100%;width:${mobilityExercises.length ? (completedCount/mobilityExercises.length*100) : 0}%;background:var(--gradient);border-radius:99px;transition:width .3s"></div>
    </div>
    ${mobilityExercises.map(ex => {
      const done = !!mobilityChecks[ex.id];
      return `<div style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--bg2);border:1px solid ${done ? 'var(--accent)' : 'var(--border)'};border-radius:var(--r2);transition:all .15s;${done ? 'opacity:0.7' : ''}">
        <button style="width:26px;height:26px;border-radius:50%;border:2px solid ${done ? 'transparent' : 'var(--border2)'};background:${done ? 'var(--gradient)' : 'transparent'};cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s"
          onclick="toggleMobilityCheck('${ex.id}')">
          ${done ? `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>` : ''}
        </button>
        <div style="flex:1;min-width:0">
          <div style="font-size:15px;font-weight:500;${done ? 'text-decoration:line-through;color:var(--text3)' : ''}">${escHtml(ex.name)}</div>
          ${ex.notes ? `<div style="font-size:12px;color:var(--text3);margin-top:2px">${escHtml(ex.notes)}</div>` : ''}
        </div>
        <button class="btn btn-ghost btn-sm btn-icon" onclick="openMobilityEdit('${ex.id}')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
      </div>`;
    }).join('')}`;
}

async function toggleMobilityCheck(exId) {
  mobilityChecks[exId] = !mobilityChecks[exId];
  await saveMobilityChecks();
  renderMobility();
}

let editingMobilityId = null;

function openMobilityAdd() {
  editingMobilityId = null;
  document.getElementById('mobility-modal-title').textContent = 'Add Mobility Exercise';
  document.getElementById('mobility-name-input').value = '';
  document.getElementById('mobility-notes-input').value = '';
  document.getElementById('mobility-delete-btn').style.display = 'none';
  openModal('modal-mobility-add');
}

function openMobilityEdit(exId) {
  editingMobilityId = exId;
  const ex = mobilityExercises.find(e => e.id === exId);
  if (!ex) return;
  document.getElementById('mobility-modal-title').textContent = 'Edit Exercise';
  document.getElementById('mobility-name-input').value = ex.name;
  document.getElementById('mobility-notes-input').value = ex.notes || '';
  document.getElementById('mobility-delete-btn').style.display = '';
  openModal('modal-mobility-add');
}

document.getElementById('mobility-add-btn').addEventListener('click', openMobilityAdd);
document.getElementById('mobility-reset-btn').addEventListener('click', async () => {
  mobilityChecks = {};
  await saveMobilityChecks();
  renderMobility();
  showToast('Checklist reset');
});

document.getElementById('mobility-save-btn').addEventListener('click', async () => {
  const name = document.getElementById('mobility-name-input').value.trim();
  if (!name) { showToast('Enter an exercise name'); return; }
  const notes = document.getElementById('mobility-notes-input').value.trim();

  if (editingMobilityId) {
    const idx = mobilityExercises.findIndex(e => e.id === editingMobilityId);
    if (idx >= 0) {
      mobilityExercises[idx].name = name;
      mobilityExercises[idx].notes = notes;
      await dbPut('mobility_exercises', mobilityExercises[idx]);
    }
  } else {
    const ex = {id: uid(), name, notes, order: mobilityExercises.length};
    await dbPut('mobility_exercises', ex);
  }
  closeModal('modal-mobility-add');
  await renderMobility();
  showToast(editingMobilityId ? 'Updated' : 'Exercise added');
});

document.getElementById('mobility-delete-btn').addEventListener('click', async () => {
  if (!editingMobilityId) return;
  if (!confirm('Delete this exercise?')) return;
  await dbDelete('mobility_exercises', editingMobilityId);
  delete mobilityChecks[editingMobilityId];
  await saveMobilityChecks();
  closeModal('modal-mobility-add');
  await renderMobility();
  showToast('Deleted');
});

// ═══════════════════════════════════════════════════════════════
// VARIANT EDITOR
// ═══════════════════════════════════════════════════════════════
// We store user edits in IDB 'variant_overrides' store keyed by variantId
// On load, we apply overrides to EXERCISE_LIBRARY data

async function loadVariantOverrides() {
  const overrides = await dbGetAll('variant_overrides');
  overrides.forEach(ov => {
    const info = variantMap[ov.id];
    if (info) {
      info.variant.name = ov.name;
      info.variant.equipment = ov.equipment;
    }
  });
  // Also load custom variants
  const customVariants = await dbGetAll('custom_variants');
  customVariants.forEach(cv => {
    const parent = parentMap[cv.parentId];
    if (parent && !variantMap[cv.id]) {
      parent.variants.push({id: cv.id, name: cv.name, equipment: cv.equipment});
      variantMap[cv.id] = {variant: parent.variants[parent.variants.length-1], parent};
    }
  });
}

let editingVariantId = null;
let editingVariantParentId = null;

function buildEquipCheckboxes(containerId, selectedEquip) {
  const container = document.getElementById(containerId);
  container.innerHTML = EXERCISE_LIBRARY.equipment_types.map(e => {
    const checked = selectedEquip.includes(e);
    return `<label style="display:flex;align-items:center;gap:6px;padding:6px 10px;background:${checked ? 'rgba(167,139,250,0.15)' : 'var(--bg3)'};border:1px solid ${checked ? 'var(--accent)' : 'var(--border)'};border-radius:var(--r);cursor:pointer;font-size:13px;transition:all .15s">
      <input type="checkbox" name="${containerId}-equip" value="${e}" ${checked ? 'checked' : ''} style="accent-color:var(--accent);width:14px;height:14px">
      ${e}
    </label>`;
  }).join('');
  // Live highlight on change
  container.querySelectorAll('input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', () => {
      const label = cb.closest('label');
      if (cb.checked) {
        label.style.background = 'rgba(167,139,250,0.15)';
        label.style.borderColor = 'var(--accent)';
      } else {
        label.style.background = 'var(--bg3)';
        label.style.borderColor = 'var(--border)';
      }
    });
  });
}

function getCheckedEquipment(containerId) {
  return [...document.querySelectorAll(`#${containerId} input[type=checkbox]:checked`)].map(cb => cb.value);
}

function openVariantEditor(parentId, variantId) {
  editingVariantId = variantId;
  editingVariantParentId = parentId;
  const info = variantMap[variantId];
  if (!info) return;

  document.getElementById('variant-editor-title').textContent = 'Edit Variant';
  document.getElementById('variant-editor-parent').textContent = info.parent.name;
  document.getElementById('ve-name').value = info.variant.name;
  buildEquipCheckboxes('ve-equip-checkboxes', info.variant.equipment);

  document.getElementById('ve-analytics-btn').onclick = () => {
    closeModal('modal-variant-editor');
    showExerciseAnalytics(variantId);
  };

  openModal('modal-variant-editor');
}

document.getElementById('ve-save-btn').addEventListener('click', async () => {
  const name = document.getElementById('ve-name').value.trim();
  if (!name) { showToast('Enter a name'); return; }
  const equipment = getCheckedEquipment('ve-equip-checkboxes');

  // Update in-memory
  const info = variantMap[editingVariantId];
  if (info) {
    info.variant.name = name;
    info.variant.equipment = equipment;
  }

  // Persist override
  await dbPut('variant_overrides', {id: editingVariantId, name, equipment});
  closeModal('modal-variant-editor');
  showToast('Variant updated');
  renderLibrary();
});

document.getElementById('ve-delete-btn').addEventListener('click', async () => {
  if (!editingVariantId || !editingVariantParentId) return;
  if (!confirm('Delete this variant? This cannot be undone.')) return;

  const parent = parentMap[editingVariantParentId];
  if (parent) {
    parent.variants = parent.variants.filter(v => v.id !== editingVariantId);
  }
  delete variantMap[editingVariantId];

  await dbDelete('variant_overrides', editingVariantId);
  await dbDelete('custom_variants', editingVariantId);

  closeModal('modal-variant-editor');
  showToast('Variant deleted');
  renderLibrary();
});

let newVariantParentId = null;

function openNewVariantModal(parentId) {
  newVariantParentId = parentId;
  const parent = parentMap[parentId];
  document.getElementById('new-variant-parent-name').textContent = parent ? parent.name : '';
  document.getElementById('nv-name').value = '';
  buildEquipCheckboxes('nv-equip-checkboxes', []);
  openModal('modal-new-variant');
}

document.getElementById('nv-save-btn').addEventListener('click', async () => {
  const name = document.getElementById('nv-name').value.trim();
  if (!name) { showToast('Enter a name'); return; }
  const equipment = getCheckedEquipment('nv-equip-checkboxes');
  if (equipment.length === 0) { showToast('Select at least one equipment type'); return; }

  const parent = parentMap[newVariantParentId];
  if (!parent) return;

  const newId = newVariantParentId + '_custom_' + Date.now().toString(36);
  const newVariant = {id: newId, name, equipment};
  parent.variants.push(newVariant);
  variantMap[newId] = {variant: newVariant, parent};

  // Persist as custom variant
  await dbPut('custom_variants', {id: newId, parentId: newVariantParentId, name, equipment});

  closeModal('modal-new-variant');
  showToast('Variant added');
  renderLibrary();
});

// ═══════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════
async function init() {
  await openDB();
  await loadVariantOverrides();
  await seedBWData();
  await seedDefaultTemplates();

  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = '';

  renderHome();
}

init().catch(console.error);

// Register service worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  });
}
</script>
</body>
</html>
