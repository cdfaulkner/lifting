<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d0b14">
<title>Iron Log</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0d0b14;
  --bg2: #13101e;
  --bg3: #1c1828;
  --bg4: #252033;
  --border: #2a2440;
  --border2: #372f52;
  --text: #f0eeff;
  --text2: #9b92c4;
  --text3: #5e5680;
  --accent: #a78bfa;
  --accent2: #8b6ef0;
  --accent-pink: #f472b6;
  --accent-blue: #60a5fa;
  --red: #f87171;
  --green: #34d399;
  --blue: #60a5fa;
  --mono: 'DM Mono', monospace;
  --display: 'Inter', sans-serif;
  --body: 'Inter', sans-serif;
  --r: 10px;
  --r2: 14px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bot: env(safe-area-inset-bottom, 0px);
  --gradient: linear-gradient(135deg, #7c3aed, #db2777);
  --gradient-soft: linear-gradient(135deg, rgba(124,58,237,0.15), rgba(219,39,119,0.1));
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: var(--body);
  font-size: 15px;
  overflow: hidden;
}

/* ── LAYOUT ── */
#app {
  display: flex;
  flex-direction: column;
  height: 100%;
  height: 100dvh;
}

#nav-bar {
  display: flex;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  padding-bottom: var(--safe-bot);
  flex-shrink: 0;
  z-index: 100;
  box-shadow: 0 -4px 20px rgba(124,58,237,0.08);
}

.nav-btn {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 10px 4px 8px;
  background: none;
  border: none;
  color: var(--text3);
  font-family: var(--body);
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 0.01em;
  cursor: pointer;
  transition: color 0.15s;
}
.nav-btn svg { width: 22px; height: 22px; }
.nav-btn.active { color: var(--accent); }
.nav-btn.active svg { stroke: var(--accent); }

#content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding-top: var(--safe-top);
}

.screen { display: none; min-height: 100%; }
.screen.active { display: block; }

/* ── HEADER ── */
.page-header {
  padding: 20px 16px 14px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: baseline;
  gap: 10px;
}
.page-title {
  font-family: var(--display);
  font-size: 20px;
  font-weight: 600;
  letter-spacing: -0.02em;
}
.page-sub {
  font-size: 12px;
  color: var(--text3);
  font-family: var(--mono);
}

/* ── BUTTONS ── */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 16px;
  border-radius: var(--r);
  font-family: var(--body);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  border: none;
  transition: all 0.15s;
}
.btn-primary { background: var(--gradient); color: #fff; border: none; }
.btn-primary:active { opacity: 0.85; }
.btn-secondary { background: var(--bg3); color: var(--text); border: 1px solid var(--border2); }
.btn-secondary:active { background: var(--bg4); }
.btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border); }
.btn-ghost:active { background: var(--bg3); }
.btn-danger { background: transparent; color: var(--red); border: 1px solid var(--red); }
.btn-sm { padding: 6px 11px; font-size: 12px; }
.btn-icon { padding: 8px; border-radius: var(--r); }
.ex-block-actions .btn-icon { padding: 6px; }

/* ── CARDS ── */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 14px;
}

/* ── INPUTS ── */
input, textarea, select {
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: var(--r);
  color: var(--text);
  font-family: var(--body);
  font-size: 15px;
  padding: 10px 12px;
  width: 100%;
  outline: none;
  transition: border-color 0.15s;
  -webkit-appearance: none;
}
input:focus, textarea:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(167,139,250,0.15); }
input[type=number] { font-family: var(--mono); }
select option { background: var(--bg3); }

.input-row {
  display: flex;
  gap: 8px;
}
.input-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.input-label {
  font-size: 12px;
  color: var(--text3);
  font-family: var(--body);
  font-weight: 500;
}

/* ── TAGS ── */
.tag {
  display: inline-flex;
  align-items: center;
  padding: 2px 7px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 500;
  font-family: var(--mono);
  letter-spacing: 0.01em;
}
.tag-muscle { background: rgba(96,165,250,0.1); color: var(--accent-blue); }
.tag-equipment { background: rgba(167,139,250,0.1); color: var(--accent); }


/* ── DIVIDER ── */


/* ── BADGE ── */
.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px;
  height: 20px;
  padding: 0 5px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 700;
  font-family: var(--mono);
  background: var(--gradient);
  color: #fff;
}

/* ── MODAL ── */
.modal-overlay {
  position: fixed;
  inset: 0;
  z-index: 200;
  display: none;
  align-items: flex-end;
  justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal-overlay.elevated { z-index: 400; }

/* Single shared backdrop */
#modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  backdrop-filter: blur(4px);
  z-index: 199;
  display: none;
  pointer-events: none;
}
#modal-backdrop.show { display: block; }
.modal {
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-top: 1px solid rgba(167,139,250,0.2);
  border-radius: var(--r2) var(--r2) 0 0;
  width: 100%;
  max-width: 520px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  padding-bottom: var(--safe-bot);
}
.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 16px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.modal-title { font-family: var(--display); font-size: 16px; font-weight: 600; letter-spacing: -0.02em; }
.modal-body { overflow-y: auto; flex: 1; padding: 12px 16px; }
.modal-footer { padding: 12px 16px; border-top: 1px solid var(--border); flex-shrink: 0; }

/* ── TOAST ── */
#toast {
  position: fixed;
  bottom: calc(70px + var(--safe-bot));
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--bg4);
  border: 1px solid var(--border2);
  border-radius: var(--r);
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 500;
  z-index: 500;
  opacity: 0;
  transition: all 0.25s;
  white-space: nowrap;
  pointer-events: none;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ════════════════════════════════════
   HOME / LOG SCREEN
════════════════════════════════════ */
#screen-home .session-bar {
  background: var(--gradient);
  color: #fff;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
}
#screen-home .session-bar-title {
  font-family: var(--display);
  font-size: 15px;
  font-weight: 500;
  letter-spacing: -0.01em;
}
#screen-home .session-bar-time {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 500;
}

.workout-list { padding: 12px 16px; display: flex; flex-direction: column; gap: 10px; }

.workout-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 14px;
  cursor: pointer;
  transition: border-color 0.15s;
  active: border-color var(--border2);
}
.workout-card:active { border-color: var(--border2); background: var(--bg3); }
.workout-card-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 8px;
}
.workout-card-title {
  font-family: var(--display);
  font-size: 15px;
  font-weight: 500;
  letter-spacing: -0.01em;
  line-height: 1.3;
}
.workout-card-date {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
  white-space: nowrap;
  flex-shrink: 0;
}
.workout-card-exercises {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.workout-card-exercise {
  font-size: 13px;
  color: var(--text2);
  display: flex;
  align-items: center;
  gap: 8px;
}
.workout-card-exercise::before {
  content: '';
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--text3);
  flex-shrink: 0;
}
.workout-card-meta {
  margin-top: 10px;
  display: flex;
  gap: 12px;
}
.workout-meta-item {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
}
.workout-meta-val { color: var(--text2); }

/* ════════════════════════════════════
   ACTIVE SESSION
════════════════════════════════════ */
#active-session {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 150;
  display: none;
  flex-direction: column;
  padding-top: var(--safe-top);
  height: 100dvh;
}
#active-session.open { display: flex; }

.session-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.session-name {
  font-family: var(--display);
  font-size: 16px;
  font-weight: 500;
  letter-spacing: -0.01em;
  cursor: pointer;
}
.session-timer {
  font-family: var(--mono);
  font-size: 16px;
  font-weight: 500;
  color: var(--accent);
  min-width: 60px;
  text-align: center;
}
.session-body {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 12px 16px 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.session-footer {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
  flex-shrink: 0;
  padding-bottom: calc(12px + var(--safe-bot));
}

/* Exercise block in active session */
.ex-block {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  overflow: clip;
}
.ex-block-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  gap: 6px;
  cursor: pointer;
  user-select: none;
  -webkit-user-select: none;
}
.ex-block-header .collapse-chevron {
  width: 16px; height: 16px;
  color: var(--text3);
  transition: transform 0.2s;
  flex-shrink: 0;
}
.ex-block.collapsed .collapse-chevron { transform: rotate(-90deg); }
.ex-block.collapsed .ex-block-body { display: none; }
.ex-block-info { flex: 1; min-width: 0; }
.ex-block-info .ex-summary {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
  display: none;
}
.ex-block.collapsed .ex-block-info .ex-summary { display: block; }
.ex-name {
  font-family: var(--display);
  font-size: 14px;
  font-weight: 500;
  letter-spacing: -0.01em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.ex-variant {
  font-size: 12px;
  color: var(--text3);
  font-family: var(--mono);
}
.ex-block-actions {
  display: flex;
  align-items: center;
  gap: 2px;
  flex-shrink: 0;
}
.ex-block.collapsed .ex-block-actions { display: none; }

/* Set rows */

.sets-header {
  display: grid;
  grid-template-columns: 36px 1fr 1fr 52px;
  padding: 6px 10px;
  background: var(--bg3);
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}
.sets-header-cell {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
  letter-spacing: 0.04em;
  text-align: center;
}
.sets-header-cell:first-child { text-align: left; padding-left: 10px; }

.set-row {
  display: grid;
  grid-template-columns: 36px 1fr 1fr 52px;
  align-items: center;
  border-bottom: 1px solid var(--border);
  min-height: 52px;
  transition: background 0.15s;
}
.set-row:last-child { border-bottom: none; }
.set-row.completed { background: rgba(167,139,250,0.06); }
.set-row.completed .set-num { color: var(--accent); }

.set-num {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text3);
  font-weight: 600;
  display: flex;
  align-items: center;
  padding-left: 10px;
}

/* Inline editable cells — large Hevy-style tap targets */
.set-cell-input {
  background: transparent;
  border: none;
  color: var(--text);
  font-family: var(--mono);
  font-size: 20px;
  font-weight: 600;
  text-align: center;
  padding: 14px 6px;
  width: 100%;
  border-radius: 0;
  -webkit-appearance: none;
  transition: background 0.12s;
  cursor: text;
}
.set-cell-input:focus {
  background: rgba(167,139,250,0.12);
  outline: none;
  color: var(--text);
}
.set-cell-input::placeholder { color: var(--text3); font-size: 16px; }
.set-row.completed .set-cell-input { color: var(--text2); }

.set-check {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 8px;
}
.check-btn {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  border: 2px solid var(--border2);
  background: transparent;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  flex-shrink: 0;
}
.check-btn:active { transform: scale(0.88); }
.check-btn.done {
  background: var(--gradient);
  border-color: transparent;
}
.check-btn svg { width: 16px; height: 16px; }

/* Detail expand */
.set-detail {
  display: none;
  padding: 12px 14px;
  background: var(--bg3);
  border-top: 1px solid var(--border);
  gap: 10px;
  flex-direction: column;
}
.set-detail.open { display: flex; }
.set-detail-row { display: flex; gap: 8px; }

/* Add set / history row */
.ex-block-footer {
  padding: 10px 14px;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* ── Superset grouping ── */
.superset-group {
  border: 1px solid var(--border2);
  border-left: 3px solid var(--accent);
  border-radius: var(--r2);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.superset-label {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 12px;
  background: rgba(167,139,250,0.08);
  font-size: 11px;
  font-weight: 500;
  color: var(--accent);
  gap: 8px;
}
.superset-label-text { display: flex; align-items: center; gap: 6px; }
.superset-connector {
  height: 1px;
  background: var(--border);
  margin: 0 12px;
  position: relative;
}
.superset-connector::after {
  content: attr(data-label);
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  background: var(--bg2);
  padding: 0 6px;
  font-size: 10px;
  color: var(--accent);
  font-weight: 600;
  letter-spacing: 0.04em;
}
.superset-group .ex-block {
  border: none;
  border-radius: 0;
  background: var(--bg3);
}
.prev-best {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
}
.prev-best span { color: var(--text2); }

/* ════════════════════════════════════
   TEMPLATES SCREEN
════════════════════════════════════ */
#screen-templates .template-list {
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.template-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 14px;
}
.template-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 6px;
}
.template-name {
  font-family: var(--display);
  font-size: 15px;
  font-weight: 500;
  letter-spacing: -0.01em;
  flex: 1;
}
.template-exercises {
  margin-top: 8px;
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.template-ex {
  font-size: 13px;
  color: var(--text2);
  display: flex;
  gap: 8px;
  align-items: center;
}
.template-ex::before {
  content: '';
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--text3);
  flex-shrink: 0;
}
.template-actions {
  margin-top: 12px;
  display: flex;
  gap: 8px;
}

/* ════════════════════════════════════
   EXERCISE LIBRARY
════════════════════════════════════ */
.library-search-bar {
  padding: 12px 16px 8px;
  position: sticky;
  top: 0;
  background: var(--bg);
  z-index: 10;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.library-filters {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  padding-bottom: 2px;
  scrollbar-width: none;
}
.library-filters::-webkit-scrollbar { display: none; }
.filter-pill {
  flex-shrink: 0;
  padding: 5px 11px;
  border-radius: 99px;
  font-size: 12px;
  font-weight: 500;
  font-family: var(--body);
  border: 1px solid var(--border2);
  background: transparent;
  color: var(--text2);
  cursor: pointer;
  transition: all 0.15s;
}
.filter-pill.active { background: var(--gradient); color: #fff; border-color: transparent; }

.library-list {
  padding: 8px 16px 16px;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.parent-group { margin-bottom: 8px; }
.parent-label {
  font-family: var(--display);
  font-size: 13px;
  font-weight: 600;
  letter-spacing: -0.01em;
  padding: 10px 0 6px;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
  color: var(--text2);
  text-transform: none;
}
.parent-label .muscle-tags { display: flex; gap: 4px; flex-wrap: wrap; }
.parent-label .count { font-family: var(--mono); font-size: 11px; color: var(--text3); font-weight: 400; }

.variant-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r);
  margin-bottom: 4px;
  cursor: pointer;
  transition: all 0.15s;
}
.variant-row:active { background: var(--bg3); }

/* ── HIERARCHICAL PICKER ── */
.picker-steps { display: flex; gap: 4px; margin-bottom: 12px; }
.picker-step {
  display: flex; align-items: center; gap: 4px;
  font-size: 11px; font-family: var(--mono); color: var(--text3);
}
.picker-step.active { color: var(--accent); font-weight: 600; }
.picker-step.done { color: var(--green); }
.picker-step-arrow { color: var(--text3); font-size: 10px; }
.picker-step-num {
  width: 18px; height: 18px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 10px; font-weight: 600;
  background: var(--bg3); color: var(--text3); border: 1px solid var(--border);
}
.picker-step.active .picker-step-num { background: var(--accent); color: #fff; border-color: var(--accent); }
.picker-step.done .picker-step-num { background: var(--green); color: #fff; border-color: var(--green); }

.picker-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 6px; max-height: 55vh; overflow-y: auto;
}
.picker-grid.single-col { grid-template-columns: 1fr; }
.picker-option {
  padding: 12px 14px; background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--r); cursor: pointer; transition: all 0.15s;
  display: flex; flex-direction: column; gap: 3px;
}
.picker-option:active { background: var(--bg4); }
.picker-option.selected { border-color: var(--accent); background: rgba(167,139,250,0.1); }
.picker-option-name { font-size: 14px; font-weight: 500; }
.picker-option-sub { font-size: 11px; color: var(--text3); font-family: var(--mono); }

.picker-section-label {
  font-size: 12px; font-weight: 600; color: var(--text2);
  margin: 10px 0 6px; font-family: var(--body);
  text-transform: uppercase; letter-spacing: 0.03em;
}

.picker-modifier-row {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px; background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--r); margin-bottom: 6px; cursor: pointer; transition: all 0.15s;
}
.picker-modifier-row.active { border-color: var(--accent); background: rgba(167,139,250,0.1); }
.picker-modifier-check {
  width: 20px; height: 20px; border-radius: 4px;
  border: 2px solid var(--border2); display: flex;
  align-items: center; justify-content: center; flex-shrink: 0;
  transition: all 0.15s;
}
.picker-modifier-row.active .picker-modifier-check {
  background: var(--accent); border-color: var(--accent);
}
.picker-modifier-label { font-size: 14px; font-weight: 500; flex: 1; }

.picker-preview {
  background: var(--bg3); border: 1px solid var(--border2);
  border-radius: var(--r); padding: 12px 14px; margin-top: 10px;
}
.picker-preview-label { font-size: 11px; color: var(--text3); margin-bottom: 4px; }
.picker-preview-name { font-size: 16px; font-weight: 600; font-family: var(--display); }
.picker-name-edit {
  width: 100%; background: var(--bg); border: 1px solid var(--border2);
  border-radius: var(--r); color: var(--text); font-family: var(--display);
  font-size: 15px; font-weight: 500; padding: 8px 10px; margin-top: 6px;
}

.picker-back-btn {
  display: flex; align-items: center; gap: 4px;
  font-size: 13px; color: var(--text3); cursor: pointer;
  padding: 4px 0; margin-bottom: 8px; background: none; border: none;
  font-family: var(--body); font-weight: 500;
}
.picker-back-btn:active { color: var(--text2); }
.variant-row-left { display: flex; flex-direction: column; gap: 3px; }
.variant-name { font-size: 14px; font-weight: 500; }
.variant-equip-tags { display: flex; gap: 4px; flex-wrap: wrap; }

/* ════════════════════════════════════
   EXERCISE DETAIL / ANALYTICS
════════════════════════════════════ */

.detail-title {
  font-family: var(--display);
  font-size: 20px;
  font-weight: 600;
  letter-spacing: -0.02em;
  line-height: 1.2;
}


.analytics-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  padding: 12px 16px;
}
.analytics-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 14px;
}
.analytics-label {
  font-size: 11px;
  color: var(--text3);
  font-family: var(--body);
  font-weight: 500;
  margin-bottom: 6px;
}
.analytics-value {
  font-family: var(--display);
  font-size: 24px;
  font-weight: 600;
  line-height: 1;
  letter-spacing: -0.02em;
}
.analytics-unit { font-size: 14px; color: var(--text2); font-weight: 400; }

.rep-max-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 4px;
}
.rep-max-table th {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
  letter-spacing: 0.02em;
  padding: 6px 8px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
.rep-max-table td {
  padding: 8px 8px;
  font-size: 13px;
  border-bottom: 1px solid var(--border);
}
.rep-max-table tr:last-child td { border-bottom: none; }
.rep-max-table td:nth-child(2) { font-family: var(--mono); font-weight: 600; }
.rep-max-table td:nth-child(3) { font-family: var(--mono); font-size: 11px; color: var(--text3); }

/* Mini chart */
.mini-chart {
  height: 80px;
  position: relative;
  overflow: hidden;
}
.mini-chart svg { width: 100%; height: 100%; }

/* History table */
.history-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.history-table th {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
  letter-spacing: 0.02em;
  padding: 6px 8px;
  text-align: left;
  border-bottom: 1px solid var(--border);
}
.history-table td {
  padding: 8px 8px;
  border-bottom: 1px solid var(--border);
  vertical-align: top;
}
.history-table tr:last-child td { border-bottom: none; }
.history-table td:nth-child(1) { font-family: var(--mono); font-size: 11px; color: var(--text3); white-space: nowrap; }
.history-table .sets-summary { display: flex; flex-direction: column; gap: 2px; }
.history-table .set-line { font-family: var(--mono); font-size: 12px; }

/* ════════════════════════════════════
   ANALYTICS / PROGRESS SCREEN
════════════════════════════════════ */



/* ════════════════════════════════════
   BODYWEIGHT
════════════════════════════════════ */
.bw-chart-wrap {
  padding: 16px;
}
.bw-chart-container {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 16px;
}
.bw-chart { height: 180px; position: relative; }
.bw-chart svg { width: 100%; height: 100%; overflow: visible; }




/* ════════════════════════════════════
   SCROLL / MISC
════════════════════════════════════ */
::-webkit-scrollbar { width: 0; height: 0; }
.empty-state {
  padding: 40px 24px;
  text-align: center;
  color: var(--text3);
}
.empty-state-icon { font-size: 40px; margin-bottom: 12px; }
.empty-state-title { font-family: var(--display); font-size: 17px; font-weight: 600; letter-spacing: -0.01em; color: var(--text2); margin-bottom: 6px; }
.empty-state-sub { font-size: 14px; line-height: 1.5; }

/* filter select row */
.filter-row {
  display: flex;
  gap: 8px;
  padding: 0 16px 12px;
}
.filter-row select { font-size: 13px; padding: 8px 10px; }

/* note textarea */
textarea { resize: none; }

/* section header w/ action */
.section-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px 8px;
}
.section-title {
  font-family: var(--display);
  font-size: 12px;
  font-weight: 500;
  color: var(--text3);
}

/* RM period filter */
.period-pills {
  display: flex;
  gap: 4px;
  padding: 0 16px 8px;
}
.period-pill {
  padding: 4px 10px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 600;
  font-family: var(--mono);
  border: 1px solid var(--border2);
  background: transparent;
  color: var(--text3);
  cursor: pointer;
}
.period-pill.active { background: var(--bg3); color: var(--text); border-color: var(--border2); }

/* timestamp in set detail */
.set-timestamp { font-family: var(--mono); font-size: 11px; color: var(--text3); }

/* Wide analytics card */
.analytics-card-wide {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 14px;
  margin: 0 16px 10px;
}

/* ════════════════════════════════════
   LOADING
════════════════════════════════════ */
#loading {
  position: fixed;
  inset: 0;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  z-index: 1000;
}
.loading-logo {
  font-family: var(--display);
  font-size: 30px;
  font-weight: 500;
  letter-spacing: -0.04em;
}
.loading-logo span { background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.loading-sub { font-family: var(--mono); font-size: 12px; color: var(--text3); }
.spinner {
  width: 32px;
  height: 32px;
  border: 2px solid var(--border2);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }


/* ── Rest Timer ── */
#rest-timer-bar {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 500;
  height: 3px;
  background: var(--gradient);
  transform-origin: left;
  transform: scaleX(0);
  transition: none;
  display: none;
}
#rest-timer-toast {
  position: fixed;
  top: calc(var(--safe-top) + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg4);
  border: 1px solid var(--border2);
  border-radius: 99px;
  padding: 6px 14px;
  font-family: var(--mono);
  font-size: 14px;
  font-weight: 600;
  color: var(--accent);
  z-index: 501;
  display: none;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  white-space: nowrap;
}
#rest-timer-toast.show { display: flex; }

/* ── PR badge ── */
.pr-badge {
  display: inline-flex;
  align-items: center;
  font-size: 10px;
  font-weight: 700;
  color: #fbbf24;
  margin-left: 4px;
}

/* ── Exercise notes cue ── */
.ex-cue {
  font-size: 11px;
  color: var(--accent-blue);
  padding: 4px 14px 8px;
  font-style: italic;
  line-height: 1.4;
}

/* ── Workout notes ── */
#session-notes-wrap {
  padding: 0 16px;
  flex-shrink: 0;
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.2s, padding 0.2s;
}
#session-notes-wrap.open {
  max-height: 100px;
  padding: 8px 16px 0;
}
#session-notes-input {
  font-size: 13px;
  padding: 8px 10px;
  border-radius: var(--r);
  min-height: 0;
  resize: none;
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text2);
  width: 100%;
  font-family: var(--body);
}
#session-notes-input:focus { border-color: var(--accent); color: var(--text); }

/* ── Reorder buttons ── */
.reorder-btn {
  width: 28px; height: 28px;
  border-radius: var(--r);
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text3);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
}
.reorder-btn:active { background: var(--bg3); color: var(--text); }

/* ── Volume chart ── */

.volume-chart svg { width: 100%; height: 100%; }

/* ── Swap variant ── */
#modal-swap-variant .variant-row { cursor: pointer; }
</style>
</head>
<body>
<div id="rest-timer-bar"></div>
<div id="rest-timer-toast" onclick="skipRestTimer()">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
  <span id="rest-timer-label">0:00</span>
  <span style="font-size:10px;color:var(--text3)">tap to skip</span>
</div>


<div id="loading">
  <div class="loading-logo">Iron<span>Log</span></div>
  <div class="spinner"></div>
  <div class="loading-sub">Loading your data...</div>
</div>

<div id="app" style="display:none">

  <!-- ══ ACTIVE SESSION OVERLAY ══ -->
  <div id="active-session">
    <div class="session-header">
      <div id="session-back-btn" style="cursor:pointer;color:var(--text3);display:flex;align-items:center;gap:4px;font-size:13px;font-weight:500">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
        Back
      </div>
      <div id="session-title" class="session-name">Workout</div>
      <div style="display:flex;align-items:center;gap:8px">
        <button class="btn btn-ghost btn-sm btn-icon" id="session-notes-toggle" title="Toggle notes" style="padding:6px;color:var(--text3)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <div id="session-timer" class="session-timer">0:00</div>
      </div>
    </div>
    <div id="session-notes-wrap">
      <textarea id="session-notes-input" placeholder="Workout notes…" rows="2"></textarea>
    </div>
    <div id="session-body" class="session-body"></div>
    <div class="session-footer">
      <button class="btn btn-secondary btn-sm" id="session-add-ex-btn" style="flex:1">+ Add Exercise</button>
      <button class="btn btn-primary" id="session-finish-btn" style="flex:1">Finish</button>
    </div>
  </div>

  <div id="content">
    <!-- ══ HOME ══ -->
    <div id="screen-home" class="screen active">
      <div class="page-header">
        <div class="page-title">Iron<span style="background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">Log</span></div>
        <div class="page-sub" id="home-stats-sub"></div>
      </div>
      <div id="active-banner"></div>
      <div class="section-row">
        <div class="section-title">Recent Workouts</div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-ghost btn-sm" id="export-claude-btn" title="Export for Claude">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            Share
          </button>
          <button class="btn btn-primary btn-sm" id="new-workout-btn">+ New</button>
        </div>
      </div>
      <div id="recent-workouts" class="workout-list"></div>
    </div>

    <!-- ══ TEMPLATES ══ -->
    <div id="screen-templates" class="screen">
      <div class="page-header">
        <div class="page-title">Templates</div>
        <button class="btn btn-primary btn-sm" id="new-template-btn">+ New</button>
      </div>
      <div id="template-list" class="template-list"></div>
    </div>

    <!-- ══ LIBRARY ══ -->
    <div id="screen-library" class="screen">
      <div class="page-header" style="justify-content:space-between">
        <div style="display:flex;align-items:baseline;gap:10px">
          <div class="page-title">Library</div>
          <div class="page-sub" id="lib-count-sub"></div>
        </div>
        <button class="btn btn-primary btn-sm" id="new-parent-btn">+ New</button>
      </div>
      <div class="library-search-bar">
        <input id="lib-search" type="search" placeholder="Search exercises…" autocomplete="off">
        <div class="library-filters" id="lib-filters"></div>
      </div>
      <div class="filter-row">
        <select id="lib-equip-filter">
          <option value="">All Equipment</option>
        </select>
        <select id="lib-muscle-filter">
          <option value="">All Muscles</option>
        </select>
      </div>
      <div id="library-list" class="library-list"></div>
    </div>

    <!-- ══ PROGRESS ══ -->
    <div id="screen-progress" class="screen">
      <div class="page-header">
        <div class="page-title">Progress</div>
      </div>
      <!-- BW Chart -->
      <div class="bw-chart-wrap">
        <div style="font-size:11px;color:var(--text3);font-weight:500;margin-bottom:8px">Bodyweight</div>
        <div class="bw-chart-container">
          <div id="bw-stats-row" style="display:flex;gap:20px;margin-bottom:12px"></div>
          <div class="bw-chart"><svg id="bw-svg"></svg></div>
          <div id="bw-period-pills" class="period-pills" style="margin-top:8px;padding:0"></div>
        </div>
      </div>
      <!-- Top Lifts -->
      <div class="section-row">
        <div class="section-title">Top Lifts (Est. 1RM)</div>
      </div>
      <div id="top-lifts-list" style="padding:0 16px 16px;display:flex;flex-direction:column;gap:8px"></div>
    </div>

    <!-- ══ MOBILITY ══ -->
    <div id="screen-mobility" class="screen">
      <div class="page-header">
        <div class="page-title">Mobility</div>
        <div class="page-sub" id="mobility-date-sub"></div>
      </div>
      <div style="padding:12px 16px 8px;display:flex;align-items:center;justify-content:space-between">
        <div style="font-size:12px;color:var(--text3);font-weight:500">Daily checklist</div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-ghost btn-sm" id="mobility-reset-btn">Reset</button>
          <button class="btn btn-primary btn-sm" id="mobility-add-btn">+ Add</button>
        </div>
      </div>
      <div id="mobility-list" style="padding:0 16px 80px;display:flex;flex-direction:column;gap:6px"></div>
    </div>
  </div>

  <!-- ══ NAV ══ -->
  <nav id="nav-bar">
    <button class="nav-btn active" data-screen="home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Home
    </button>
    <button class="nav-btn" data-screen="templates">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      Templates
    </button>
    <button class="nav-btn" data-screen="library">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
      Library
    </button>
    <button class="nav-btn" data-screen="progress">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Progress
    </button>
    <button class="nav-btn" data-screen="mobility">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="3"/><path d="M12 11v4M8 17c0-2.2 1.8-4 4-4s4 1.8 4 4"/><path d="M6 21c0-3.3 2.7-6 6-6s6 2.7 6 6"/></svg>
      Mobility
    </button>
  </nav>
</div>

<!-- ══ MODALS ══ -->
<div id="modal-backdrop"></div>

<!-- New Workout / Pick Template -->
<div class="modal-overlay" id="modal-new-workout">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Start Workout</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-new-workout')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-primary" id="start-empty-btn" style="width:100%">Start Empty Workout</button>
      </div>
      <div style="margin:16px 0 8px;font-size:12px;color:var(--text3);font-weight:500">From template</div>
      <div id="modal-template-list" style="display:flex;flex-direction:column;gap:6px"></div>
    </div>
  </div>
</div>

<!-- Set Detail Modal (notes, RPE, rest) -->
<div class="modal-overlay" id="modal-set-detail">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="set-detail-title">Set Detail</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-set-detail')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="input-row">
          <div class="input-group" style="flex:1">
            <div class="input-label">Weight (lbs)</div>
            <input id="detail-weight" type="number" step="0.5" placeholder="0">
          </div>
          <div class="input-group" style="flex:1">
            <div class="input-label">Reps</div>
            <input id="detail-reps" type="number" placeholder="0">
          </div>
        </div>
        <div class="input-row">
          <div class="input-group" style="flex:1">
            <div class="input-label">RPE (1-10)</div>
            <input id="detail-rpe" type="number" step="0.5" min="1" max="10" placeholder="—">
          </div>
          <div class="input-group" style="flex:1">
            <div class="input-label">Rest (sec)</div>
            <input id="detail-rest" type="number" placeholder="—">
          </div>
        </div>
        <div class="input-group">
          <div class="input-label">Notes</div>
          <textarea id="detail-notes" rows="3" placeholder="Form cues, how it felt…"></textarea>
        </div>
        <div id="detail-timestamp" class="set-timestamp"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="detail-save-btn" style="width:100%">Save</button>
    </div>
  </div>
</div>

<!-- Exercise Analytics View -->
<div class="modal-overlay" id="modal-exercise-detail">
  <div class="modal" style="max-height:95vh">
    <div class="modal-header">
      <div style="flex:1">
        <div class="modal-title" id="ex-detail-name"></div>
        <div id="ex-detail-sub" style="font-size:12px;color:var(--text3);font-family:var(--mono)"></div>
      </div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-exercise-detail')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" id="ex-detail-body" style="padding:0"></div>
    <div class="modal-footer" id="ex-detail-footer" style="display:none">
      <button class="btn btn-secondary" id="ex-repeat-btn" style="width:100%">Repeat this workout</button>
    </div>
  </div>
</div>

<!-- Template Editor -->
<div class="modal-overlay" id="modal-template-editor">
  <div class="modal" style="max-height:95vh">
    <div class="modal-header">
      <div class="modal-title" id="tmpl-editor-title">New Template</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-template-editor')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-group" style="margin-bottom:12px">
        <div class="input-label">Template Name</div>
        <input id="tmpl-name-input" type="text" placeholder="Push / Pull / Legs…">
      </div>
      <div id="tmpl-exercises-list" style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px"></div>
      <button class="btn btn-secondary" id="tmpl-add-ex-btn" style="width:100%">+ Add Exercise</button>
    </div>
    <div class="modal-footer" style="display:flex;gap:8px">
      <button class="btn btn-danger btn-sm" id="tmpl-delete-btn" style="display:none">Delete</button>
      <button class="btn btn-primary" id="tmpl-save-btn" style="flex:1">Save Template</button>
    </div>
  </div>
</div>

<!-- BW Entry -->
<div class="modal-overlay" id="modal-bw-entry">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Log Weight</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-bw-entry')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-row">
        <div class="input-group" style="flex:1">
          <div class="input-label">Date</div>
          <input id="bw-date-input" type="date">
        </div>
        <div class="input-group" style="flex:1">
          <div class="input-label">Weight (lbs)</div>
          <input id="bw-weight-input" type="number" step="0.1" placeholder="180.0">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="bw-save-btn" style="width:100%">Save</button>
    </div>
  </div>
</div>

<!-- Add Mobility Exercise Modal -->
<div class="modal-overlay" id="modal-mobility-add">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="mobility-modal-title">Add Mobility Exercise</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-mobility-add')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-group" style="margin-bottom:12px">
        <div class="input-label">Exercise Name</div>
        <input id="mobility-name-input" type="text" placeholder="e.g. Hip Flexor Stretch, Cat-Cow…">
      </div>
      <div class="input-group">
        <div class="input-label">Notes (optional)</div>
        <textarea id="mobility-notes-input" rows="2" placeholder="Duration, sets, cues…"></textarea>
      </div>
    </div>
    <div class="modal-footer" style="display:flex;gap:8px">
      <button class="btn btn-danger btn-sm" id="mobility-delete-btn" style="display:none">Delete</button>
      <button class="btn btn-primary" id="mobility-save-btn" style="flex:1">Save</button>
    </div>
  </div>
</div>

<!-- Variant Editor Modal -->
<div class="modal-overlay" id="modal-variant-editor">
  <div class="modal" style="max-height:90vh">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="variant-editor-title">Edit Variant</div>
        <div id="variant-editor-parent" style="font-size:12px;color:var(--text3);font-family:var(--mono)"></div>
      </div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-variant-editor')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-group" style="margin-bottom:12px">
        <div class="input-label">Variant Name</div>
        <input id="ve-name" type="text" placeholder="e.g. Flat (Barbell)">
      </div>
      <div class="input-group" style="margin-bottom:12px">
        <div class="input-label">Equipment Tags</div>
        <div id="ve-equip-checkboxes" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px"></div>
      </div>
      <div id="ve-analytics-btn-wrap" style="margin-top:4px">
        <button class="btn btn-ghost btn-sm" id="ve-analytics-btn" style="width:100%">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          View Analytics
        </button>
      </div>
    </div>
    <div class="modal-footer" style="display:flex;gap:8px">
      <button class="btn btn-danger btn-sm" id="ve-delete-btn">Delete Variant</button>
      <button class="btn btn-primary" id="ve-save-btn" style="flex:1">Save</button>
    </div>
  </div>
</div>

<!-- Add New Variant Modal -->
<div class="modal-overlay" id="modal-new-variant">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">New Variant</div>
        <div id="new-variant-parent-name" style="font-size:12px;color:var(--text3);font-family:var(--mono)"></div>
      </div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-new-variant')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-group" style="margin-bottom:12px">
        <div class="input-label">Variant Name</div>
        <input id="nv-name" type="text" placeholder="e.g. Incline (Barbell)">
      </div>
      <div class="input-group">
        <div class="input-label">Equipment Tags</div>
        <div id="nv-equip-checkboxes" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="nv-save-btn" style="width:100%">Add Variant</button>
    </div>
  </div>
</div>

<!-- New Parent Exercise Modal -->
<div class="modal-overlay" id="modal-new-parent">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">New Exercise</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-new-parent')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-group" style="margin-bottom:12px">
        <div class="input-label">Exercise Name</div>
        <input id="np-name" type="text" placeholder="e.g. Chest Supported Row">
      </div>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <div class="input-group" style="flex:1">
          <div class="input-label">Primary Muscle</div>
          <select id="np-primary-muscle">
            <option value="">Select…</option>
          </select>
        </div>
        <div class="input-group" style="flex:1">
          <div class="input-label">Movement</div>
          <select id="np-movement">
            <option value="">Select…</option>
          </select>
        </div>
      </div>
      <div class="input-group" style="margin-bottom:12px">
        <div class="input-label">Secondary Muscles <span style="color:var(--text3);font-weight:400">(optional)</span></div>
        <div id="np-secondary-muscles" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px"></div>
      </div>
      <div style="border-top:1px solid var(--border);padding-top:12px;margin-bottom:6px">
        <div class="input-label" style="margin-bottom:10px">First variant</div>
        <div class="input-group" style="margin-bottom:10px">
          <input id="np-variant-name" type="text" placeholder="Variant name, e.g. Barbell">
        </div>
        <div class="input-label" style="margin-bottom:6px">Equipment</div>
        <div id="np-equip-checkboxes" style="display:flex;flex-wrap:wrap;gap:8px"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="np-save-btn" style="width:100%">Create Exercise</button>
    </div>
  </div>
</div>

<!-- Superset Modal -->
<div class="modal-overlay" id="modal-superset">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="superset-modal-title">Superset</div>
        <div id="superset-modal-sub" style="font-size:12px;color:var(--text3);margin-top:2px"></div>
      </div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-superset')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div id="superset-current-group" style="margin-bottom:12px;display:none">
        <div class="input-label" style="margin-bottom:8px">In this superset</div>
        <div id="superset-group-list" style="display:flex;flex-direction:column;gap:4px"></div>
        <button class="btn btn-danger btn-sm" id="superset-unlink-btn" style="width:100%;margin-top:10px">Remove from superset</button>
      </div>
      <div id="superset-link-section">
        <div class="input-label" style="margin-bottom:8px">Pair with…</div>
        <div id="superset-ex-list" style="display:flex;flex-direction:column;gap:4px"></div>
      </div>
    </div>
  </div>
</div>

<!-- Swap Variant Modal -->
<div class="modal-overlay" id="modal-swap-variant">
  <div class="modal" style="max-height:90vh">
    <div class="modal-header">
      <div>
        <div class="modal-title">Swap Variant</div>
        <div id="swap-variant-parent-name" style="font-size:12px;color:var(--text3)"></div>
      </div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-swap-variant')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" style="padding:8px 16px">
      <div id="swap-variant-list" style="display:flex;flex-direction:column;gap:4px"></div>
    </div>
  </div>
</div>

<!-- Exercise Notes Modal -->
<div class="modal-overlay" id="modal-ex-notes">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">Exercise Notes</div>
        <div id="ex-notes-modal-sub" style="font-size:12px;color:var(--text3)"></div>
      </div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-ex-notes')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="input-label" style="margin-bottom:6px">Cues &amp; reminders</div>
      <textarea id="ex-notes-input" rows="4" placeholder="e.g. Retract scapula, drive elbows down, pause at chest"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="ex-notes-save-btn" style="width:100%">Save</button>
    </div>
  </div>
</div>

<!-- Export for Claude Modal -->
<div class="modal-overlay" id="modal-export-claude">
  <div class="modal" style="max-height:85vh">
    <div class="modal-header">
      <div>
        <div class="modal-title">Export for Claude</div>
        <div style="font-size:12px;color:var(--text3);margin-top:2px">Paste this into any Claude chat</div>
      </div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeModal('modal-export-claude')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" style="padding:12px 16px">
      <textarea id="export-claude-text" rows="14" readonly
        style="font-size:12px;font-family:var(--mono);line-height:1.5;background:var(--bg3);border:1px solid var(--border);color:var(--text2);resize:none;cursor:text"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="export-copy-btn" style="width:100%">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
        Copy to clipboard
      </button>
    </div>
  </div>
</div>

<!-- Exercise Picker — must be last modal in DOM so it renders above all others -->
<div class="modal-overlay" id="modal-pick-exercise" style="z-index:400">
  <div class="modal" style="max-height:95vh">
    <div class="modal-header">
      <div class="modal-title" id="pick-ex-title">Add Exercise</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="closeExercisePicker()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" style="padding:8px 16px">
      <input id="pick-ex-search" type="search" placeholder="Search exercises…" style="margin-bottom:8px" autocomplete="off">
      <div id="pick-ex-filters" style="display:flex;gap:6px;overflow-x:auto;padding-bottom:8px;scrollbar-width:none"></div>
      <!-- Step indicator -->
      <div id="pick-ex-steps" class="picker-steps" style="display:none"></div>
      <!-- Back button for sub-steps -->
      <button id="pick-ex-back" class="picker-back-btn" style="display:none" onclick="pickerGoBack()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
        Back
      </button>
      <!-- Main content area -->
      <div id="pick-ex-list" style="display:flex;flex-direction:column;gap:4px;max-height:60vh;overflow-y:auto"></div>
    </div>
    <div id="pick-ex-footer" class="modal-footer" style="display:none">
      <button class="btn btn-primary" id="pick-ex-confirm" style="width:100%">Add Exercise</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ═══════════════════════════════════════════════════════════════
// DATA LAYER — IndexedDB via simple wrapper
// ═══════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════
// SUPABASE SYNC LAYER
// sessions and templates are stored in Supabase (cross-device sync)
// everything else stays in IndexedDB
// ═══════════════════════════════════════════════════════════════
const SUPABASE_URL = 'https://dvahxqqmneahnboiuvnz.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2YWh4cXFtbmVhaG5ib2l1dm56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzE3MDUsImV4cCI6MjA4NzU0NzcwNX0.a4Zadt0iMJBeLqLYZmHYiBmbER-57lJxLHoN07rFgmc';
const SUPABASE_STORES = new Set(['sessions', 'templates']);

async function sbRequest(method, path, body) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
    method,
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': method === 'POST' ? 'resolution=merge-duplicates,return=minimal' : 'return=minimal'
    },
    body: body ? JSON.stringify(body) : undefined
  });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`Supabase error: ${err}`);
  }
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

async function sbGetAll(store) {
  const rows = await sbRequest('GET', `ironlog_${store}?select=data&order=created_at.asc`, null);
  return (rows || []).map(r => r.data);
}

async function sbGet(store, key) {
  const rows = await sbRequest('GET', `ironlog_${store}?select=data&id=eq.${encodeURIComponent(key)}`, null);
  return rows && rows.length > 0 ? rows[0].data : undefined;
}

async function sbPut(store, val) {
  await sbRequest('POST', `ironlog_${store}`, {
    id: val.id,
    data: val,
    updated_at: new Date().toISOString()
  });
}

async function sbDelete(store, key) {
  await sbRequest('DELETE', `ironlog_${store}?id=eq.${encodeURIComponent(key)}`, null);
}

const DB_NAME = 'ironlog';
const DB_VER = 4;
let db;

function openDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('sessions')) {
        const s = d.createObjectStore('sessions', { keyPath: 'id' });
        s.createIndex('startTime', 'startTime');
      }
      if (!d.objectStoreNames.contains('templates')) {
        d.createObjectStore('templates', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('bodyweight')) {
        const b = d.createObjectStore('bodyweight', { keyPath: 'date' });
        b.createIndex('date', 'date');
      }
      if (!d.objectStoreNames.contains('exercises')) {
        d.createObjectStore('exercises', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('mobility_exercises')) {
        d.createObjectStore('mobility_exercises', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('mobility_checks')) {
        d.createObjectStore('mobility_checks', { keyPath: 'date' });
      }
      if (!d.objectStoreNames.contains('variant_overrides')) {
        d.createObjectStore('variant_overrides', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('custom_variants')) {
        d.createObjectStore('custom_variants', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('custom_parents')) {
        d.createObjectStore('custom_parents', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('custom_equipment_types')) {
        d.createObjectStore('custom_equipment_types', { keyPath: 'id' });
      }
      if (!d.objectStoreNames.contains('exercise_notes')) {
        d.createObjectStore('exercise_notes', { keyPath: 'variantId' });
      }
      if (!d.objectStoreNames.contains('pr_records')) {
        d.createObjectStore('pr_records', { keyPath: 'variantId' });
      }
    };
    req.onsuccess = e => { db = e.target.result; res(db); };
    req.onerror = () => rej(req.error);
  });
}

function idbGet(store, key) {
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

function idbPut(store, val) {
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).put(val);
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

function idbDelete(store, key) {
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).delete(key);
    req.onsuccess = () => res();
    req.onerror = () => rej(req.error);
  });
}

function idbGetAll(store, indexName, query) {
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readonly');
    const os = tx.objectStore(store);
    const req = indexName ? os.index(indexName).getAll(query) : os.getAll();
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

function dbGet(store, key) {
  if (!SUPABASE_STORES.has(store)) return idbGet(store, key);
  return sbGet(store, key).catch(() => idbGet(store, key));
}
function dbPut(store, val) {
  if (!SUPABASE_STORES.has(store)) return idbPut(store, val);
  return sbPut(store, val).catch(() => idbPut(store, val));
}
function dbDelete(store, key) {
  if (!SUPABASE_STORES.has(store)) return idbDelete(store, key);
  return sbDelete(store, key).catch(() => idbDelete(store, key));
}
function dbGetAll(store, indexName, query) {
  if (!SUPABASE_STORES.has(store)) return idbGetAll(store, indexName, query);
  return sbGetAll(store).catch(() => idbGetAll(store, indexName, query));
}

function uid() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2,6);
}

// ═══════════════════════════════════════════════════════════════
// EXERCISE LIBRARY DATA
// ═══════════════════════════════════════════════════════════════
</script>
<script id="lib-data-script">
// Library injected by build
const EXERCISE_LIBRARY = {"equipment_types":["barbell","dumbbell","cable","machine","landmine","band","bodyweight","trap_bar","kettlebell","plate","suspension","voltra"],"muscle_groups":["chest","back","shoulders","biceps","triceps","quads","hamstrings","glutes","calves","core","forearms"],"movement_patterns":["push","pull","squat","hinge","carry","isolation","core"],"parents":[{"id":"bench_press","name":"Bench Press","primary_muscles":["chest"],"secondary_muscles":["triceps","shoulders"],"movement_pattern":"push","variants":[{"id":"bench_barbell_flat","name":"Flat (Barbell)","equipment":["barbell"]},{"id":"bench_barbell_incline","name":"Incline (Barbell)","equipment":["barbell"]},{"id":"bench_barbell_decline","name":"Decline (Barbell)","equipment":["barbell"]},{"id":"bench_barbell_close_grip","name":"Close Grip (Barbell)","equipment":["barbell"]},{"id":"bench_barbell_pause","name":"Pause (Barbell)","equipment":["barbell"]},{"id":"bench_barbell_bands","name":"With Bands (Barbell)","equipment":["barbell","band"]},{"id":"bench_barbell_guillotine","name":"Guillotine (Barbell)","equipment":["barbell"]},{"id":"bench_dumbbell_flat","name":"Flat (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_dumbbell_incline","name":"Incline (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_dumbbell_decline","name":"Decline (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_dumbbell_single_arm","name":"Single Arm (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_cable","name":"Cable","equipment":["cable"]},{"id":"bench_dumbbell_isometric","name":"Isometric (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_dumbbell_incline_squeeze","name":"Incline Squeeze Press (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_dumbbell_hex","name":"Hex Press (Dumbbell)","equipment":["dumbbell"]},{"id":"bench_landmine_crush","name":"Crush Press (Landmine)","equipment":["landmine"]},{"id":"bench_plate_loaded","name":"Plate-Loaded Machine","equipment":["machine","plate"]}]},{"id":"chest_fly","name":"Chest Fly","primary_muscles":["chest"],"secondary_muscles":["shoulders"],"movement_pattern":"isolation","variants":[{"id":"fly_dumbbell_flat","name":"Flat (Dumbbell)","equipment":["dumbbell"]},{"id":"fly_dumbbell_incline","name":"Incline (Dumbbell)","equipment":["dumbbell"]},{"id":"fly_dumbbell_decline","name":"Decline (Dumbbell)","equipment":["dumbbell"]},{"id":"fly_cable_crossover","name":"Cable Crossover","equipment":["cable"]},{"id":"fly_cable_low","name":"Low Cable Crossover","equipment":["cable"]},{"id":"fly_cable_seated","name":"Seated Cable","equipment":["cable"]},{"id":"fly_machine_pec_deck","name":"Pec Deck Machine","equipment":["machine"]},{"id":"fly_machine","name":"Machine","equipment":["machine"]},{"id":"fly_band_flat","name":"Flat (Band)","equipment":["band"]},{"id":"fly_band_incline","name":"Incline (Band)","equipment":["band"]},{"id":"fly_band_decline","name":"Decline (Band)","equipment":["band"]},{"id":"fly_dumbbell_partial_bottom","name":"Partial Bottom Range (Dumbbell)","equipment":["dumbbell"]},{"id":"fly_cable_single_arm","name":"Single Arm Cable","equipment":["cable"]},{"id":"fly_judd","name":"Judd Flies","equipment":["cable"]},{"id":"fly_butterfly_ext","name":"Butterfly Extensions","equipment":["machine"]},{"id":"fly_dumbbell_incline_crush","name":"Incline Crush Press (Dumbbell)","equipment":["dumbbell"]}]},{"id":"push_up","name":"Push Up","primary_muscles":["chest"],"secondary_muscles":["triceps","shoulders"],"movement_pattern":"push","variants":[{"id":"pushup_bodyweight","name":"Bodyweight","equipment":["bodyweight"]},{"id":"pushup_weighted","name":"Weighted","equipment":["bodyweight","plate"]},{"id":"pushup_band","name":"Band","equipment":["band"]},{"id":"pushup_clap","name":"Clap","equipment":["bodyweight"]},{"id":"pushup_inclined_close_grip","name":"Incline Close Grip","equipment":["bodyweight"]}]},{"id":"dip","name":"Dip","primary_muscles":["chest"],"secondary_muscles":["triceps","shoulders"],"movement_pattern":"push","variants":[{"id":"dip_chest_bodyweight","name":"Chest Dip (Bodyweight)","equipment":["bodyweight"]},{"id":"dip_chest_weighted","name":"Chest Dip (Weighted)","equipment":["bodyweight"]},{"id":"dip_bench","name":"Bench Dip","equipment":["bodyweight"]},{"id":"dip_ring","name":"Ring Dip","equipment":["suspension"]},{"id":"dip_triceps_machine","name":"Machine","equipment":["machine"]},{"id":"dip_triceps_bar","name":"Triceps Dip (Bar)","equipment":["bodyweight"]}]},{"id":"pull_up","name":"Pull Up / Chin Up","primary_muscles":["back"],"secondary_muscles":["biceps"],"movement_pattern":"pull","variants":[{"id":"pullup_bodyweight","name":"Pull Up (Bodyweight)","equipment":["bodyweight"]},{"id":"pullup_weighted","name":"Pull Up (Weighted)","equipment":["bodyweight"]},{"id":"chinup_bodyweight","name":"Chin Up (Bodyweight)","equipment":["bodyweight"]},{"id":"chinup_weighted","name":"Chin Up (Weighted)","equipment":["bodyweight"]},{"id":"pullup_pelican","name":"Pelican Curl","equipment":["bodyweight"]}]},{"id":"lat_pulldown","name":"Lat Pulldown","primary_muscles":["back"],"secondary_muscles":["biceps"],"movement_pattern":"pull","variants":[{"id":"pulldown_cable_wide","name":"Wide Grip (Cable)","equipment":["cable"]},{"id":"pulldown_cable_close","name":"Close Grip (Cable)","equipment":["cable"]},{"id":"pulldown_cable_single_arm","name":"Single Arm (Cable)","equipment":["cable"]},{"id":"pulldown_cable_reverse_grip","name":"Reverse Grip (Cable)","equipment":["cable"]},{"id":"pulldown_plate_loaded","name":"Plate-Loaded Machine","equipment":["machine","plate"]}]},{"id":"row","name":"Row","primary_muscles":["back"],"secondary_muscles":["biceps","shoulders"],"movement_pattern":"pull","variants":[{"id":"row_barbell_bent_over","name":"Bent Over (Barbell)","equipment":["barbell"]},{"id":"row_barbell_chest_supported","name":"Chest Supported (Barbell)","equipment":["barbell"]},{"id":"row_dumbbell_single_arm","name":"Single Arm (Dumbbell)","equipment":["dumbbell"]},{"id":"row_dumbbell_bent_over","name":"Bent Over (Dumbbell)","equipment":["dumbbell"]},{"id":"row_dumbbell_chest_supported_incline","name":"Chest Supported Incline (Dumbbell)","equipment":["dumbbell"]},{"id":"row_cable_bar","name":"Seated Cable (Bar Grip)","equipment":["cable"]},{"id":"row_cable_v_grip","name":"Seated Cable (V Grip)","equipment":["cable"]},{"id":"row_cable_single_arm","name":"Single Arm Cable","equipment":["cable"]},{"id":"row_cable_high","name":"High Cable Row","equipment":["cable"]},{"id":"row_tbar","name":"T-Bar","equipment":["barbell"]},{"id":"row_landmine_tbar","name":"T-Bar (Landmine)","equipment":["landmine"]},{"id":"row_landmine_single_arm","name":"Single Arm (Landmine)","equipment":["landmine"]},{"id":"row_machine_seated","name":"Seated Machine","equipment":["machine"]},{"id":"row_machine_iso_lateral","name":"Iso-Lateral Machine","equipment":["machine"]},{"id":"row_machine_high_plate","name":"High Row (Plate-Loaded)","equipment":["machine","plate"]},{"id":"row_machine_high","name":"High Row Machine","equipment":["machine"]},{"id":"row_plate_single_arm","name":"Single Arm Plate","equipment":["plate"]},{"id":"row_inverted","name":"Inverted Row (Bodyweight)","equipment":["bodyweight"]},{"id":"row_inverted_weighted","name":"Inverted Row (Weighted)","equipment":["bodyweight"]},{"id":"row_suspension_single_arm","name":"Single Arm Suspension","equipment":["suspension"]},{"id":"row_voltra","name":"Voltra Row","equipment":["voltra"]},{"id":"row_fa","name":"FA Row","equipment":["bodyweight"]},{"id":"row_landmine_combo","name":"Row+Press (Landmine)","equipment":["landmine"]}]},{"id":"straight_arm_pulldown","name":"Straight Arm Pulldown","primary_muscles":["back"],"secondary_muscles":[],"movement_pattern":"pull","variants":[{"id":"sal_cable","name":"Cable","equipment":["cable"]},{"id":"sal_cable_iso_lateral","name":"Iso-Lateral Cable","equipment":["cable"]},{"id":"sal_rope","name":"Rope","equipment":["cable"]}]},{"id":"pullover","name":"Pullover","primary_muscles":["back"],"secondary_muscles":["chest"],"movement_pattern":"pull","variants":[{"id":"pullover_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"pullover_barbell","name":"Barbell","equipment":["barbell"]},{"id":"pullover_machine","name":"Machine","equipment":["machine"]}]},{"id":"back_extension","name":"Back Extension","primary_muscles":["hamstrings","glutes"],"secondary_muscles":["back"],"movement_pattern":"hinge","variants":[{"id":"back_ext_weighted","name":"Weighted (Freakathlete)","equipment":["bodyweight"]},{"id":"back_ext_single_leg","name":"Single Leg (Freakathlete)","equipment":["bodyweight"]},{"id":"back_ext_iso_hold","name":"Iso Hold (Freakathlete)","equipment":["bodyweight"]},{"id":"back_ext_single_leg_iso","name":"Single Leg Iso Hold (Freakathlete)","equipment":["bodyweight"]},{"id":"back_ext_reverse_hyper","name":"Reverse Hyperextension","equipment":["bodyweight"]}]},{"id":"overhead_press","name":"Overhead Press","primary_muscles":["shoulders"],"secondary_muscles":["triceps"],"movement_pattern":"push","variants":[{"id":"ohp_barbell_standing","name":"Standing (Barbell)","equipment":["barbell"]},{"id":"ohp_barbell_seated","name":"Seated (Barbell)","equipment":["barbell"]},{"id":"ohp_dumbbell_standing","name":"Standing (Dumbbell)","equipment":["dumbbell"]},{"id":"ohp_dumbbell_seated","name":"Seated (Dumbbell)","equipment":["dumbbell"]},{"id":"ohp_cable","name":"Cable","equipment":["cable"]},{"id":"ohp_machine","name":"Machine","equipment":["machine"]},{"id":"ohp_landmine_kneeling","name":"Kneeling (Landmine)","equipment":["landmine"]},{"id":"ohp_landmine_single","name":"Single Arm (Landmine)","equipment":["landmine"]},{"id":"ohp_landmine_standing","name":"Standing (Landmine)","equipment":["landmine"]},{"id":"ohp_landmine_jammer","name":"Jammer (Landmine)","equipment":["landmine"]},{"id":"ohp_dumbbell_arnold","name":"Arnold Press (Dumbbell)","equipment":["dumbbell"]}]},{"id":"lateral_raise","name":"Lateral Raise","primary_muscles":["shoulders"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"lat_raise_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"lat_raise_dumbbell_seated","name":"Seated (Dumbbell)","equipment":["dumbbell"]},{"id":"lat_raise_cable","name":"Cable","equipment":["cable"]},{"id":"lat_raise_cable_single_arm","name":"Single Arm Cable","equipment":["cable"]},{"id":"lat_raise_machine","name":"Machine","equipment":["machine"]},{"id":"lat_raise_band","name":"Band","equipment":["band"]},{"id":"front_raise_barbell","name":"Front Raise (Barbell)","equipment":["barbell"]},{"id":"front_raise_dumbbell","name":"Front Raise (Dumbbell)","equipment":["dumbbell"]},{"id":"front_raise_plate","name":"Front Raise (Plate)","equipment":["plate"]}]},{"id":"face_pull","name":"Face Pull","primary_muscles":["shoulders"],"secondary_muscles":["back"],"movement_pattern":"pull","variants":[{"id":"face_pull_cable","name":"Cable","equipment":["cable"]},{"id":"face_pull_band","name":"Band","equipment":["band"]}]},{"id":"upright_row","name":"Upright Row","primary_muscles":["shoulders"],"secondary_muscles":["biceps"],"movement_pattern":"pull","variants":[{"id":"upright_row_barbell","name":"Barbell","equipment":["barbell"]},{"id":"upright_row_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"upright_row_cable","name":"Cable","equipment":["cable"]},{"id":"upright_row_dumbbell_single","name":"Single Arm Dumbbell","equipment":["dumbbell"]},{"id":"upright_row_staggered_db_high_pull","name":"Staggered High Pull (Dumbbell)","equipment":["dumbbell"]}]},{"id":"rear_delt_fly","name":"Rear Delt Fly","primary_muscles":["shoulders"],"secondary_muscles":["back"],"movement_pattern":"isolation","variants":[{"id":"rear_delt_cable","name":"Cable","equipment":["cable"]},{"id":"rear_delt_dumbbell_chest_supported","name":"Chest Supported (Dumbbell)","equipment":["dumbbell"]},{"id":"rear_delt_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"rear_delt_machine","name":"Machine","equipment":["machine"]},{"id":"rear_delt_band","name":"Band","equipment":["band"]}]},{"id":"shrug","name":"Shrug","primary_muscles":["shoulders"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"shrug_barbell","name":"Barbell","equipment":["barbell"]},{"id":"shrug_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"shrug_cable","name":"Cable","equipment":["cable"]},{"id":"shrug_trap_bar","name":"Trap Bar","equipment":["trap_bar"]},{"id":"shrug_smith","name":"Smith Machine","equipment":["machine"]}]},{"id":"shoulder_rotation","name":"Shoulder Rotation","primary_muscles":["shoulders"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"shoulder_w_band","name":"W Rotation (Band)","equipment":["band"]},{"id":"band_pullaparts","name":"Pullaparts (Band)","equipment":["band"]},{"id":"sunrise_raises","name":"Sunrise Raises","equipment":["dumbbell"]},{"id":"clock_raises","name":"Clock Raises","equipment":["dumbbell"]},{"id":"jesus_raises","name":"Jesus Raises","equipment":["dumbbell"]}]},{"id":"bicep_curl","name":"Bicep Curl","primary_muscles":["biceps"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"curl_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"curl_dumbbell_incline_seated","name":"Incline Seated (Dumbbell)","equipment":["dumbbell"]},{"id":"curl_dumbbell_concentration","name":"Concentration (Dumbbell)","equipment":["dumbbell"]},{"id":"curl_dumbbell_spider","name":"Spider (Dumbbell)","equipment":["dumbbell"]},{"id":"curl_barbell","name":"Barbell","equipment":["barbell"]},{"id":"curl_barbell_ez","name":"EZ Bar","equipment":["barbell"]},{"id":"curl_barbell_preacher","name":"Preacher (Barbell)","equipment":["barbell"]},{"id":"curl_barbell_spider","name":"Spider (Barbell)","equipment":["barbell"]},{"id":"curl_cable","name":"Cable","equipment":["cable"]},{"id":"curl_cable_rope","name":"Rope (Cable)","equipment":["cable"]},{"id":"curl_cable_high","name":"High Cable (Bar)","equipment":["cable"]},{"id":"curl_cable_single_arm","name":"Single Arm (Cable)","equipment":["cable"]},{"id":"curl_dumbbell_hammer","name":"Hammer (Dumbbell)","equipment":["dumbbell"]},{"id":"curl_cable_hammer","name":"Hammer (Cable)","equipment":["cable"]},{"id":"curl_machine","name":"Machine","equipment":["machine"]},{"id":"curl_dumbbell_preacher","name":"Preacher (Dumbbell)","equipment":["dumbbell"]},{"id":"curl_dumbbell_zottman","name":"Zottman (Dumbbell)","equipment":["dumbbell"]},{"id":"curl_suspension","name":"Suspension Curl","equipment":["suspension"]},{"id":"curl_plate","name":"Plate Curl","equipment":["plate"]}]},{"id":"tricep_extension","name":"Tricep Extension","primary_muscles":["triceps"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"tri_ext_dumbbell_overhead","name":"Overhead (Dumbbell)","equipment":["dumbbell"]},{"id":"tri_ext_barbell_overhead","name":"Overhead (Barbell)","equipment":["barbell"]},{"id":"tri_ext_cable_overhead","name":"Overhead (Cable)","equipment":["cable"]},{"id":"tri_ext_cable_overhead_single","name":"Overhead Single Arm (Cable)","equipment":["cable"]},{"id":"tri_ext_cable_handle","name":"Cable Handle","equipment":["cable"]},{"id":"tri_ext_cable_handleless","name":"Cable Handleless","equipment":["cable"]},{"id":"tri_ext_machine","name":"Machine","equipment":["machine"]},{"id":"tri_ext_band","name":"Band","equipment":["band"]},{"id":"tri_ext_suspension_ring","name":"Ring Extension","equipment":["suspension"]},{"id":"tri_ext_suspension","name":"Suspension Extension","equipment":["suspension"]},{"id":"tri_ext_plate","name":"Plate Extension","equipment":["plate"]},{"id":"tri_ext_dumbbell_single","name":"Single Arm (Dumbbell)","equipment":["dumbbell"]}]},{"id":"tricep_pushdown","name":"Tricep Pushdown","primary_muscles":["triceps"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"tri_push_cable_bar","name":"Bar (Cable)","equipment":["cable"]},{"id":"tri_push_cable_rope","name":"Rope (Cable)","equipment":["cable"]},{"id":"tri_push_cable_reverse","name":"Reverse Grip (Cable)","equipment":["cable"]},{"id":"tri_push_cable_single","name":"Single Arm (Cable)","equipment":["cable"]},{"id":"tri_push_cable_single_handle","name":"Single Arm Handle (Cable)","equipment":["cable"]}]},{"id":"skullcrusher","name":"Skullcrusher","primary_muscles":["triceps"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"skull_barbell","name":"Barbell","equipment":["barbell"]},{"id":"skull_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"skull_cambered","name":"Cambered Close Grip","equipment":["barbell"]}]},{"id":"tricep_kickback","name":"Tricep Kickback","primary_muscles":["triceps"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"kickback_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"kickback_cable","name":"Cable","equipment":["cable"]}]},{"id":"squat","name":"Squat","primary_muscles":["quads"],"secondary_muscles":["glutes","hamstrings"],"movement_pattern":"squat","variants":[{"id":"squat_barbell_back","name":"Back Squat (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_front","name":"Front Squat (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_overhead","name":"Overhead Squat (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_pause","name":"Pause Squat (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_zercher","name":"Zercher Squat (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_cossack","name":"Cossack Squat (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_clean","name":"Squat Clean (Barbell)","equipment":["barbell"]},{"id":"squat_barbell_thruster","name":"Thruster (Barbell)","equipment":["barbell"]},{"id":"squat_landmine","name":"Landmine Squat","equipment":["landmine"]},{"id":"squat_landmine_hack","name":"Landmine Hack Squat","equipment":["landmine"]},{"id":"squat_dumbbell_goblet","name":"Goblet (Dumbbell)","equipment":["dumbbell"]},{"id":"squat_kettlebell_goblet","name":"Goblet (Kettlebell)","equipment":["kettlebell"]},{"id":"squat_cable_goblet","name":"Goblet (Cable)","equipment":["cable"]},{"id":"squat_sissy","name":"Sissy Squat (Weighted)","equipment":["plate"]},{"id":"squat_sissy_cable","name":"Sissy Squat (Cable)","equipment":["cable"]},{"id":"squat_sissy_banded","name":"Sissy Squat (Band)","equipment":["band"]},{"id":"squat_spanish","name":"Spanish Squat","equipment":["band"]},{"id":"squat_belt","name":"Belt Squat","equipment":["machine"]},{"id":"squat_belt_cable","name":"Belt Squat (Cable)","equipment":["cable"]},{"id":"squat_box_pistol","name":"Box Pistol Squat","equipment":["bodyweight"]}]},{"id":"hack_squat","name":"Hack Squat","primary_muscles":["quads"],"secondary_muscles":["glutes"],"movement_pattern":"squat","variants":[{"id":"hack_squat_barbell","name":"Barbell","equipment":["barbell"]},{"id":"hack_squat_machine","name":"Machine","equipment":["machine"]}]},{"id":"leg_press","name":"Leg Press","primary_muscles":["quads"],"secondary_muscles":["glutes","hamstrings"],"movement_pattern":"squat","variants":[{"id":"leg_press_machine","name":"Machine","equipment":["machine"]},{"id":"leg_press_machine_horizontal","name":"Horizontal Machine","equipment":["machine"]},{"id":"leg_press_single_leg","name":"Single Leg Machine","equipment":["machine"]},{"id":"leg_press_calf","name":"Calf Press on Leg Press","equipment":["machine"]}]},{"id":"split_squat","name":"Split Squat / Lunge","primary_muscles":["quads"],"secondary_muscles":["glutes","hamstrings"],"movement_pattern":"squat","variants":[{"id":"split_squat_barbell","name":"Split Squat (Barbell)","equipment":["barbell"]},{"id":"split_squat_dumbbell","name":"Split Squat (Dumbbell)","equipment":["dumbbell"]},{"id":"split_squat_stationary","name":"Stationary Lunge","equipment":["bodyweight"]},{"id":"bulgarian_split_squat_bodyweight","name":"Bulgarian Split Squat (Bodyweight)","equipment":["bodyweight"]},{"id":"bulgarian_split_squat_barbell","name":"Bulgarian Split Squat (Barbell)","equipment":["barbell"]},{"id":"bulgarian_goblet","name":"Goblet Bulgarian Split Squat","equipment":["dumbbell"]},{"id":"lunge_dumbbell","name":"Lunge (Dumbbell)","equipment":["dumbbell"]},{"id":"lunge_barbell","name":"Lunge (Barbell)","equipment":["barbell"]},{"id":"step_up_dumbbell","name":"Step Up (Dumbbell)","equipment":["dumbbell"]}]},{"id":"leg_extension","name":"Leg Extension","primary_muscles":["quads"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"leg_ext_machine","name":"Machine","equipment":["machine"]},{"id":"leg_ext_plate_loaded","name":"Plate-Loaded","equipment":["machine","plate"]},{"id":"leg_ext_machine_iso","name":"Iso Machine","equipment":["machine"]},{"id":"leg_ext_reverse_nordic","name":"Reverse Nordic","equipment":["bodyweight"]}]},{"id":"deadlift","name":"Deadlift","primary_muscles":["hamstrings","glutes"],"secondary_muscles":["back","quads"],"movement_pattern":"hinge","variants":[{"id":"deadlift_barbell","name":"Conventional (Barbell)","equipment":["barbell"]},{"id":"deadlift_trap_bar","name":"Trap Bar","equipment":["trap_bar"]},{"id":"deadlift_landmine","name":"Landmine Deadlift","equipment":["landmine"]},{"id":"deadlift_jefferson_curl","name":"Jefferson Curl (Barbell)","equipment":["barbell"]},{"id":"deadlift_trap_bar_jump","name":"Trap Bar Jump","equipment":["trap_bar"]}]},{"id":"romanian_deadlift","name":"Romanian Deadlift","primary_muscles":["hamstrings","glutes"],"secondary_muscles":["back"],"movement_pattern":"hinge","variants":[{"id":"rdl_barbell","name":"Barbell","equipment":["barbell"]},{"id":"rdl_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"rdl_dumbbell_single_leg","name":"Single Leg (Dumbbell)","equipment":["dumbbell"]},{"id":"rdl_dumbbell_kneeling_single","name":"Kneeling Single Leg (Dumbbell)","equipment":["dumbbell"]},{"id":"rdl_voltra","name":"Voltra RDL","equipment":["voltra"]}]},{"id":"good_morning","name":"Good Morning","primary_muscles":["hamstrings"],"secondary_muscles":["back","glutes"],"movement_pattern":"hinge","variants":[{"id":"good_morning_barbell","name":"Barbell","equipment":["barbell"]},{"id":"good_morning_band","name":"Band","equipment":["band"]}]},{"id":"leg_curl","name":"Leg Curl","primary_muscles":["hamstrings"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"leg_curl_plate_loaded","name":"Plate-Loaded","equipment":["machine","plate"]},{"id":"leg_curl_machine_lying","name":"Lying Machine","equipment":["machine"]},{"id":"leg_curl_machine_iso","name":"Iso Machine","equipment":["machine"]},{"id":"ghd_leg_curl","name":"GHR / Nordic Hamstring Curl (Freakathlete)","equipment":["bodyweight"]},{"id":"nordic_hamstring","name":"Nordic Hamstring Curl","equipment":["bodyweight"]},{"id":"nordic_inclined","name":"Inclined Nordic Curl (Freakathlete)","equipment":["bodyweight"]},{"id":"voltra_ham_curl","name":"Standing Ham Curl (Voltra)","equipment":["voltra"]}]},{"id":"hip_thrust","name":"Hip Thrust","primary_muscles":["glutes"],"secondary_muscles":["hamstrings"],"movement_pattern":"hinge","variants":[{"id":"hip_thrust_barbell","name":"Barbell","equipment":["barbell"]},{"id":"hip_thrust_machine","name":"Machine","equipment":["machine"]}]},{"id":"calf_raise","name":"Calf Raise","primary_muscles":["calves"],"secondary_muscles":[],"movement_pattern":"isolation","variants":[{"id":"calf_seated","name":"Seated Machine","equipment":["machine"]},{"id":"calf_dumbbell_seated","name":"Seated (Dumbbell)","equipment":["dumbbell"]},{"id":"calf_barbell_seated","name":"Seated (Barbell)","equipment":["barbell"]},{"id":"calf_machine_press","name":"Machine Press","equipment":["machine"]},{"id":"calf_standing_machine","name":"Standing Machine","equipment":["machine"]},{"id":"calf_landmine","name":"Landmine Calf Raise","equipment":["landmine"]},{"id":"calf_hanging_landmine","name":"Hanging Landmine Calf Raise","equipment":["landmine"]},{"id":"calf_barbell_standing_single","name":"Single Leg Standing (Barbell)","equipment":["barbell"]},{"id":"calf_belt","name":"Belt Calf Raise","equipment":["machine"]},{"id":"calf_hanging_cable","name":"Hanging Cable Calf Raise","equipment":["cable"]},{"id":"calf_hanging_barbell","name":"Hanging Barbell Calf Raise","equipment":["barbell"]}]},{"id":"crunch","name":"Crunch","primary_muscles":["core"],"secondary_muscles":[],"movement_pattern":"core","variants":[{"id":"crunch_cable","name":"Cable Crunch","equipment":["cable"]},{"id":"crunch_machine","name":"Machine","equipment":["machine"]},{"id":"crunch_bench","name":"Bench Crunch","equipment":["bodyweight"]},{"id":"crunch_db","name":"Dumbbell Crunch","equipment":["dumbbell"]},{"id":"crunch_band","name":"Band Crunch","equipment":["band"]},{"id":"crunch_weighted","name":"Weighted Crunch","equipment":["plate"]},{"id":"crunch_ghd","name":"GHD Crunch (Freakathlete)","equipment":["bodyweight"]},{"id":"crunch_suspension","name":"Suspension Crunch","equipment":["suspension"]},{"id":"crunch_decline_weighted","name":"Decline Weighted","equipment":["bodyweight","plate"]}]},{"id":"leg_raise","name":"Leg Raise / Knee Raise","primary_muscles":["core"],"secondary_muscles":[],"movement_pattern":"core","variants":[{"id":"knee_raise_parallel","name":"Knee Raise (Parallel Bars)","equipment":["bodyweight"]},{"id":"hanging_leg_raise","name":"Hanging Leg Raise","equipment":["bodyweight"]},{"id":"hanging_knee_raise","name":"Hanging Knee Raise","equipment":["bodyweight"]},{"id":"leg_raise_decline_bench","name":"Decline Bench Leg Lifts","equipment":["bodyweight"]},{"id":"captains_chair","name":"Captain's Chair","equipment":["bodyweight"]},{"id":"ghd_leg_lift","name":"GHD Leg Lift (Freakathlete)","equipment":["bodyweight"]},{"id":"lying_leg_raise","name":"Lying Leg Raise","equipment":["bodyweight"]},{"id":"v_up","name":"V Up","equipment":["bodyweight"]},{"id":"jackknife_suspension","name":"Jackknife (Suspension)","equipment":["suspension"]}]},{"id":"ab_wheel","name":"Ab Wheel / Rollout","primary_muscles":["core"],"secondary_muscles":[],"movement_pattern":"core","variants":[{"id":"ab_wheel","name":"Ab Wheel","equipment":["bodyweight"]}]},{"id":"plank","name":"Plank","primary_muscles":["core"],"secondary_muscles":[],"movement_pattern":"core","variants":[{"id":"plank_standard","name":"Standard","equipment":["bodyweight"]},{"id":"plank_side","name":"Side Plank","equipment":["bodyweight"]},{"id":"plank_hollow_rock","name":"Hollow Rock","equipment":["bodyweight"]},{"id":"plank_bird_dog","name":"Bird Dog","equipment":["bodyweight"]},{"id":"plank_mountain_climber","name":"Mountain Climber","equipment":["bodyweight"]},{"id":"plank_v_up_weighted","name":"Weighted V-Ups","equipment":["plate"]}]},{"id":"pallof_press","name":"Pallof Press / Anti-Rotation","primary_muscles":["core"],"secondary_muscles":[],"movement_pattern":"core","variants":[{"id":"pallof_band","name":"Band","equipment":["band"]},{"id":"pallof_cable","name":"Cable","equipment":["cable"]},{"id":"pallof_twist_press","name":"Twist + Press","equipment":["cable","band"]},{"id":"cable_twist_up_down","name":"Cable Twist (Up to Down)","equipment":["cable"]},{"id":"kneeling_landmine_rotation","name":"Kneeling Rotation (Landmine)","equipment":["landmine"]},{"id":"russian_twist_weighted","name":"Weighted Russian Twist","equipment":["plate"]}]},{"id":"side_bend","name":"Side Bend / QL","primary_muscles":["core"],"secondary_muscles":[],"movement_pattern":"core","variants":[{"id":"side_bend_dumbbell","name":"Dumbbell","equipment":["dumbbell"]},{"id":"side_crunch_cable","name":"Side Crunch (Cable)","equipment":["cable"]},{"id":"weighted_ql_bend","name":"Weighted QL Bend","equipment":["dumbbell"]}]},{"id":"farmers_carry","name":"Farmer's Carry","primary_muscles":["core","forearms"],"secondary_muscles":["shoulders"],"movement_pattern":"carry","variants":[{"id":"farmers_carry_dumbbell","name":"Dumbbell","equipment":["dumbbell"]}]},{"id":"rowing_machine","name":"Rowing Machine","primary_muscles":["back"],"secondary_muscles":["quads","core"],"movement_pattern":"pull","variants":[{"id":"rowing_machine_cardio","name":"Rowing Machine","equipment":["machine"]}]}]};

// Build lookup maps
const variantMap = {}; // variantId -> {variant, parent}
const parentMap = {}; // parentId -> parent
EXERCISE_LIBRARY.parents.forEach(p => {
  parentMap[p.id] = p;
  p.variants.forEach(v => {
    variantMap[v.id] = { variant: v, parent: p };
  });
});


// ── Convenience: resolve variantId to {parent, variant, displayName} ──
function getVariantInfo(variantId) {
  const info = variantMap[variantId];
  if (!info) return { parent: null, variant: null, displayName: variantId };
  const displayName = `${info.parent.name}${info.variant.name ? ' — ' + info.variant.name : ''}`;
  return { parent: info.parent, variant: info.variant, displayName };
}

function getVariantDisplayName(variantId) {
  const info = variantMap[variantId];
  if (!info) return variantId;
  return `${info.parent.name} — ${info.variant.name}`;
}
function getParentForVariant(variantId) {
  return variantMap[variantId]?.parent;
}

// ═══════════════════════════════════════════════════════════════
// NEW HIERARCHICAL EXERCISE TAXONOMY
// ═══════════════════════════════════════════════════════════════
// Each "lift" defines: resistance types, main variants (angle/grip/stance),
// and which modifier flags are available.
// The picker flow: Main Lift → Resistance → Main Variant → Modifiers → Confirm

const EXERCISE_HIERARCHY = [
  // ── CHEST ──
  { id:"chest_press", name:"Chest Press", pattern:"push", muscles:["chest"], sec:["triceps","shoulders"],
    resistances:["Barbell","Dumbbell","Voltra","Landmine"],
    variants:["Flat","Incline","Decline"],
    mods:{bands:true,unilateral:true,other:true} },
  { id:"chest_fly", name:"Chest Fly", pattern:"isolation", muscles:["chest"], sec:["shoulders"],
    resistances:["Dumbbell","Voltra"],
    variants:["Flat","Incline","Decline"],
    mods:{bands:true,unilateral:true,other:true} },
  { id:"push_up", name:"Push Up", pattern:"push", muscles:["chest"], sec:["triceps","shoulders"],
    resistances:["BW+"], variants:[], mods:{bands:true,unilateral:false,other:true} },
  { id:"dip", name:"Dip", pattern:"push", muscles:["chest"], sec:["triceps","shoulders"],
    resistances:["BW+"], variants:[], mods:{bands:true,unilateral:false,other:true} },
  // ── BACK ──
  { id:"pull_up", name:"Pull Up", pattern:"pull", muscles:["back"], sec:["biceps"],
    resistances:["BW+"], variants:["Supinated","Pronated","Neutral","Ring"],
    mods:{bands:true,unilateral:false,other:true} },
  { id:"lat_pulldown", name:"Lat Pulldown", pattern:"pull", muscles:["back"], sec:["biceps"],
    resistances:["Voltra"], variants:["Wide","Narrow","Neutral"],
    mods:{bands:false,unilateral:true,other:true} },
  { id:"row", name:"Row", pattern:"pull", muscles:["back"], sec:["biceps","shoulders"],
    resistances:["Barbell","Dumbbell","Voltra","Landmine"],
    variants:["Wide","Narrow","Neutral"],
    mods:{bands:true,unilateral:true,other:true} },
  { id:"suspension_row", name:"Suspension Row", pattern:"pull", muscles:["back"], sec:["biceps"],
    resistances:["BW+"], variants:[], mods:{bands:false,unilateral:true,other:true} },
  { id:"pullover", name:"Pullover", pattern:"pull", muscles:["back"], sec:["chest"],
    resistances:["Barbell","Dumbbell","Voltra"], variants:[],
    mods:{bands:false,unilateral:true,other:true} },
  { id:"straight_arm_pulldown", name:"Pulldown", pattern:"pull", muscles:["back"], sec:[],
    resistances:["Voltra"], variants:[], mods:{bands:false,unilateral:true,other:true} },
  { id:"back_extension", name:"Back Extension", pattern:"hinge", muscles:["hamstrings","glutes"], sec:["back"],
    resistances:["BW+"], variants:[], mods:{bands:false,unilateral:true,other:true} },
  { id:"reverse_hyper", name:"Reverse Hyperextension", pattern:"hinge", muscles:["hamstrings","glutes"], sec:["back"],
    resistances:["BW+"], variants:[], mods:{bands:false,unilateral:true,other:true} },
  // ── SHOULDERS ──
  { id:"overhead_press", name:"Overhead Press", pattern:"push", muscles:["shoulders"], sec:["triceps"],
    resistances:["Barbell","Dumbbell","Voltra","Landmine"],
    variants:["Seated","Standing","Kneeling"],
    mods:{bands:true,unilateral:true,other:true} },
  { id:"shoulder_raise", name:"Shoulder Raise", pattern:"isolation", muscles:["shoulders"], sec:[],
    resistances:["Barbell","Dumbbell","Voltra","Landmine","Plate"],
    variants:["Seated","Standing"],
    mods:{bands:true,unilateral:true,other:true} },
  { id:"face_pull", name:"Face Pull", pattern:"pull", muscles:["shoulders"], sec:["back"],
    resistances:["Voltra"], variants:[], mods:{bands:true,unilateral:true,other:true} },
  { id:"upright_row", name:"Upright Row", pattern:"pull", muscles:["shoulders"], sec:["biceps"],
    resistances:["Barbell","Dumbbell","Voltra"], variants:[],
    mods:{bands:true,unilateral:true,other:true} },
  { id:"rear_delt_fly", name:"Rear Delt Fly", pattern:"isolation", muscles:["shoulders"], sec:["back"],
    resistances:["Dumbbell","Voltra"], variants:[],
    mods:{bands:true,unilateral:true,other:true} },
  { id:"shrug", name:"Shrug", pattern:"isolation", muscles:["shoulders"], sec:[],
    resistances:["Barbell","Dumbbell","Voltra","Trap Bar"], variants:[],
    mods:{bands:true,unilateral:true,other:true} },
  { id:"shoulder_rotation", name:"Shoulder Rotation", pattern:"isolation", muscles:["shoulders"], sec:[],
    resistances:["Dumbbell","Voltra"], variants:[],
    mods:{bands:true,unilateral:false,other:true} },
  // ── ARMS ──
  { id:"bicep_curl", name:"Bicep Curl", pattern:"isolation", muscles:["biceps"], sec:[],
    resistances:["Barbell","Dumbbell","Voltra","Plate"],
    variants:["Standing","Seated","Incline","Preacher"],
    mods:{bands:true,unilateral:true,other:true} },
  { id:"tricep_extension", name:"Tricep Extension", pattern:"isolation", muscles:["triceps"], sec:[],
    resistances:["Barbell","Dumbbell","Voltra"],
    variants:["Seated","Standing","Flat","Incline"],
    mods:{bands:true,unilateral:true,other:true} },
  // ── LEGS ──
  { id:"squat", name:"Squat", pattern:"squat", muscles:["quads"], sec:["glutes","hamstrings"],
    resistances:["Barbell","Dumbbell","Voltra","Landmine"],
    variants:["Back","Front","Zercher","Goblet","Hack","Sissy","Harness","Belt","Cossack"],
    mods:{bands:true,unilateral:false,other:true} },
  { id:"lunge", name:"Lunge", pattern:"squat", muscles:["quads"], sec:["glutes","hamstrings"],
    resistances:["Barbell","Dumbbell","Goblet"],
    variants:["BSS","Walking","Stationary","Forward","Backward","Step-Up"],
    mods:{bands:true,unilateral:false,other:true} },
  { id:"leg_extension", name:"Leg Extension", pattern:"isolation", muscles:["quads"], sec:[],
    resistances:["Voltra"], variants:[], mods:{bands:false,unilateral:false,other:true} },
  { id:"deadlift", name:"Deadlift", pattern:"hinge", muscles:["hamstrings","glutes"], sec:["back","quads"],
    resistances:["Barbell","Dumbbell","Trap Bar"], variants:[],
    mods:{bands:true,unilateral:false,other:true} },
  { id:"rdl", name:"RDL", pattern:"hinge", muscles:["hamstrings","glutes"], sec:["back"],
    resistances:["Barbell","Dumbbell","Voltra"], variants:[],
    mods:{bands:true,unilateral:true,other:true} },
  { id:"good_morning", name:"Good Morning", pattern:"hinge", muscles:["hamstrings"], sec:["back","glutes"],
    resistances:["Barbell","Voltra"], variants:[], mods:{bands:true,unilateral:true,other:true} },
  { id:"jefferson_curl", name:"Jefferson Curl", pattern:"hinge", muscles:["hamstrings"], sec:["back"],
    resistances:["Barbell","Dumbbell","Voltra"], variants:[], mods:{bands:true,unilateral:true,other:true} },
  { id:"ghr", name:"GHR", pattern:"isolation", muscles:["hamstrings"], sec:[],
    resistances:["BW+"], variants:[], mods:{bands:true,unilateral:false,other:true} },
  { id:"nordic_curl", name:"Nordic Curl", pattern:"isolation", muscles:["hamstrings"], sec:[],
    resistances:["BW+"], variants:[], mods:{bands:true,unilateral:false,other:true} },
  { id:"ham_curl", name:"Ham Curl", pattern:"isolation", muscles:["hamstrings"], sec:[],
    resistances:["Voltra"], variants:[], mods:{bands:false,unilateral:false,other:true} },
  { id:"hip_thrust", name:"Hip Thrust", pattern:"hinge", muscles:["glutes"], sec:["hamstrings"],
    resistances:["Barbell","Dumbbell","Voltra"], variants:[],
    mods:{bands:true,unilateral:false,other:true} },
  { id:"reverse_nordic", name:"Reverse Nordic", pattern:"isolation", muscles:["quads"], sec:[],
    resistances:["BW+"], variants:[], mods:{bands:true,unilateral:false,other:true} },
  { id:"calf_raise", name:"Calf Raise", pattern:"isolation", muscles:["calves"], sec:[],
    resistances:["Barbell","Dumbbell","Voltra","Landmine","Belt"],
    variants:["Seated","Standing"], mods:{bands:true,unilateral:true,other:true} },
  // ── CORE ──
  { id:"crunch", name:"Crunch", pattern:"core", muscles:["core"], sec:[],
    resistances:["Voltra","BW+"], variants:[], mods:{bands:false,unilateral:false,other:true} },
  { id:"leg_raise", name:"Leg Raise / Knee Raise", pattern:"core", muscles:["core"], sec:[],
    resistances:["BW+"], variants:[], mods:{bands:false,unilateral:false,other:true} },
  { id:"ab_wheel", name:"Ab Wheel / Rollout", pattern:"core", muscles:["core"], sec:[],
    resistances:["BW+"], variants:[], mods:{bands:false,unilateral:false,other:true} },
  { id:"plank", name:"Plank", pattern:"core", muscles:["core"], sec:[],
    resistances:["BW+"], variants:[], mods:{bands:false,unilateral:false,other:true} },
  { id:"pallof_press", name:"Pallof Press / Anti-Rotation", pattern:"core", muscles:["core"], sec:[],
    resistances:["Voltra"], variants:[], mods:{bands:true,unilateral:false,other:true} },
  { id:"side_bend", name:"Side Bend / QL", pattern:"core", muscles:["core"], sec:[],
    resistances:["Dumbbell","Voltra"], variants:[], mods:{bands:false,unilateral:false,other:true} },
  // ── OTHER ──
  { id:"farmers_carry", name:"Farmer's Carry", pattern:"carry", muscles:["core","forearms"], sec:["shoulders"],
    resistances:["Dumbbell","Trap Bar"], variants:[], mods:{bands:false,unilateral:true,other:true} },
  { id:"rowing_machine", name:"Rowing Machine", pattern:"pull", muscles:["back"], sec:["quads","core"],
    resistances:["Voltra"], variants:[], mods:{bands:false,unilateral:false,other:true} }
];

// Build hierarchy lookup
const hierarchyMap = {};
EXERCISE_HIERARCHY.forEach(h => { hierarchyMap[h.id] = h; });

// Resistance type abbreviation map for display names
const RES_ABBREV = {
  "Barbell":"BB","Dumbbell":"DB","Voltra":"Voltra","Landmine":"LM",
  "BW+":"BW+","Trap Bar":"Trap Bar","Plate":"Plate","Belt":"Belt","Goblet":"Goblet","Cable":"Cable"
};

// ── Generate a deterministic variant ID from picker selections ──
function buildVariantId(parentId, resistance, mainVariant, mods) {
  let parts = [parentId];
  parts.push(resistance.toLowerCase().replace(/[^a-z0-9]/g,'_'));
  if (mainVariant) parts.push(mainVariant.toLowerCase().replace(/[^a-z0-9]/g,'_'));
  if (mods.bands) parts.push('bands');
  if (mods.unilateral) parts.push('uni');
  if (mods.other) parts.push(mods.other.toLowerCase().replace(/[^a-z0-9]/g,'_').slice(0,20));
  return parts.join('__');
}

// ── Generate display name from picker selections ──
function buildExerciseName(parentName, resAbbrev, mainVariant, mods) {
  let parts = [];
  if (mainVariant) parts.push(mainVariant);
  parts.push(resAbbrev);
  parts.push(parentName);
  let name = parts.join(' ');
  const modParts = [];
  if (mods.bands) modParts.push('Bands');
  if (mods.unilateral) modParts.push('Unilateral');
  if (mods.other) modParts.push(mods.other);
  if (modParts.length > 0) name += ' (' + modParts.join(', ') + ')';
  return name;
}

// ── Legacy variant ID → new hierarchy mapping ──
// Maps old variantId to {parentId, resistance, variant, mods:{bands,unilateral,other}}
const LEGACY_VARIANT_MAP = {
  "bench_barbell_flat":{p:"chest_press",r:"Barbell",v:"Flat"},
  "bench_barbell_incline":{p:"chest_press",r:"Barbell",v:"Incline"},
  "bench_barbell_decline":{p:"chest_press",r:"Barbell",v:"Decline"},
  "bench_barbell_close_grip":{p:"chest_press",r:"Barbell",v:"Flat",o:"Close Grip"},
  "bench_barbell_pause":{p:"chest_press",r:"Barbell",v:"Flat",o:"Pause"},
  "bench_barbell_bands":{p:"chest_press",r:"Barbell",v:"Flat",b:1},
  "bench_barbell_guillotine":{p:"chest_press",r:"Barbell",v:"Flat",o:"Guillotine"},
  "bench_dumbbell_flat":{p:"chest_press",r:"Dumbbell",v:"Flat"},
  "bench_dumbbell_incline":{p:"chest_press",r:"Dumbbell",v:"Incline"},
  "bench_dumbbell_decline":{p:"chest_press",r:"Dumbbell",v:"Decline"},
  "bench_dumbbell_single_arm":{p:"chest_press",r:"Dumbbell",v:"Flat",u:1},
  "bench_cable":{p:"chest_press",r:"Voltra",v:"Flat"},
  "bench_dumbbell_isometric":{p:"chest_press",r:"Dumbbell",v:"Flat",o:"Isometric"},
  "bench_dumbbell_incline_squeeze":{p:"chest_press",r:"Dumbbell",v:"Incline",o:"Squeeze"},
  "bench_dumbbell_hex":{p:"chest_press",r:"Dumbbell",v:"Flat",o:"Hex Press"},
  "bench_landmine_crush":{p:"chest_press",r:"Landmine",v:"Flat",o:"Crush Press"},
  "bench_plate_loaded":{p:"chest_press",r:"Voltra",v:"Flat",o:"Plate-Loaded"},
  "fly_dumbbell_flat":{p:"chest_fly",r:"Dumbbell",v:"Flat"},
  "fly_dumbbell_incline":{p:"chest_fly",r:"Dumbbell",v:"Incline"},
  "fly_dumbbell_decline":{p:"chest_fly",r:"Dumbbell",v:"Decline"},
  "fly_cable_crossover":{p:"chest_fly",r:"Voltra",v:"Flat",o:"Crossover"},
  "fly_cable_low":{p:"chest_fly",r:"Voltra",v:"Flat",o:"Low Crossover"},
  "fly_cable_seated":{p:"chest_fly",r:"Voltra",v:"Flat",o:"Seated"},
  "fly_machine_pec_deck":{p:"chest_fly",r:"Voltra",v:"Flat",o:"Pec Deck"},
  "fly_machine":{p:"chest_fly",r:"Voltra",v:"Flat",o:"Machine"},
  "fly_band_flat":{p:"chest_fly",r:"Dumbbell",v:"Flat",b:1,o:"Band"},
  "fly_band_incline":{p:"chest_fly",r:"Dumbbell",v:"Incline",b:1,o:"Band"},
  "fly_band_decline":{p:"chest_fly",r:"Dumbbell",v:"Decline",b:1,o:"Band"},
  "fly_dumbbell_partial_bottom":{p:"chest_fly",r:"Dumbbell",v:"Flat",o:"Partial Bottom"},
  "fly_cable_single_arm":{p:"chest_fly",r:"Voltra",v:"Flat",u:1},
  "fly_judd":{p:"chest_fly",r:"Voltra",v:"Flat",o:"Judd"},
  "fly_butterfly_ext":{p:"chest_fly",r:"Voltra",v:"Flat",o:"Butterfly Ext"},
  "fly_dumbbell_incline_crush":{p:"chest_fly",r:"Dumbbell",v:"Incline",o:"Crush"},
  "pushup_bodyweight":{p:"push_up",r:"BW+"},
  "pushup_weighted":{p:"push_up",r:"BW+",o:"Weighted"},
  "pushup_band":{p:"push_up",r:"BW+",b:1},
  "pushup_clap":{p:"push_up",r:"BW+",o:"Clap"},
  "pushup_inclined_close_grip":{p:"push_up",r:"BW+",o:"Incline Close Grip"},
  "dip_chest_bodyweight":{p:"dip",r:"BW+",o:"Chest"},
  "dip_chest_weighted":{p:"dip",r:"BW+",o:"Chest Weighted"},
  "dip_bench":{p:"dip",r:"BW+",o:"Bench"},
  "dip_ring":{p:"dip",r:"BW+",o:"Ring"},
  "dip_triceps_machine":{p:"dip",r:"BW+",o:"Machine"},
  "dip_triceps_bar":{p:"dip",r:"BW+",o:"Triceps Bar"},
  "pullup_bodyweight":{p:"pull_up",r:"BW+",v:"Pronated"},
  "pullup_weighted":{p:"pull_up",r:"BW+",v:"Pronated",o:"Weighted"},
  "chinup_bodyweight":{p:"pull_up",r:"BW+",v:"Supinated"},
  "chinup_weighted":{p:"pull_up",r:"BW+",v:"Supinated",o:"Weighted"},
  "pullup_pelican":{p:"pull_up",r:"BW+",v:"Supinated",o:"Pelican Curl"},
  "pulldown_cable_wide":{p:"lat_pulldown",r:"Voltra",v:"Wide"},
  "pulldown_cable_close":{p:"lat_pulldown",r:"Voltra",v:"Narrow"},
  "pulldown_cable_single_arm":{p:"lat_pulldown",r:"Voltra",v:"Neutral",u:1},
  "pulldown_cable_reverse_grip":{p:"lat_pulldown",r:"Voltra",v:"Neutral",o:"Reverse Grip"},
  "pulldown_plate_loaded":{p:"lat_pulldown",r:"Voltra",v:"Neutral",o:"Plate-Loaded"},
  "row_barbell_bent_over":{p:"row",r:"Barbell",v:"Neutral",o:"Bent Over"},
  "row_barbell_chest_supported":{p:"row",r:"Barbell",v:"Neutral",o:"Chest Supported"},
  "row_dumbbell_single_arm":{p:"row",r:"Dumbbell",v:"Neutral",u:1},
  "row_dumbbell_bent_over":{p:"row",r:"Dumbbell",v:"Neutral",o:"Bent Over"},
  "row_dumbbell_chest_supported_incline":{p:"row",r:"Dumbbell",v:"Neutral",o:"Chest Supported Incline"},
  "row_cable_bar":{p:"row",r:"Voltra",v:"Wide",o:"Seated Bar"},
  "row_cable_v_grip":{p:"row",r:"Voltra",v:"Narrow",o:"Seated V"},
  "row_cable_single_arm":{p:"row",r:"Voltra",v:"Neutral",u:1},
  "row_cable_high":{p:"row",r:"Voltra",v:"Wide",o:"High"},
  "row_tbar":{p:"row",r:"Barbell",v:"Narrow",o:"T-Bar"},
  "row_landmine_tbar":{p:"row",r:"Landmine",v:"Narrow",o:"T-Bar"},
  "row_landmine_single_arm":{p:"row",r:"Landmine",v:"Neutral",u:1},
  "row_machine_seated":{p:"row",r:"Voltra",v:"Neutral",o:"Seated Machine"},
  "row_machine_iso_lateral":{p:"row",r:"Voltra",v:"Neutral",o:"Iso-Lateral"},
  "row_machine_high_plate":{p:"row",r:"Voltra",v:"Wide",o:"High Row Plate"},
  "row_machine_high":{p:"row",r:"Voltra",v:"Wide",o:"High Row Machine"},
  "row_plate_single_arm":{p:"row",r:"Dumbbell",v:"Neutral",u:1,o:"Plate"},
  "row_inverted":{p:"suspension_row",r:"BW+",o:"Inverted"},
  "row_inverted_weighted":{p:"suspension_row",r:"BW+",o:"Inverted Weighted"},
  "row_suspension_single_arm":{p:"suspension_row",r:"BW+",u:1},
  "row_voltra":{p:"row",r:"Voltra",v:"Neutral"},
  "row_fa":{p:"suspension_row",r:"BW+",o:"FA Row"},
  "row_landmine_combo":{p:"row",r:"Landmine",v:"Neutral",o:"Row+Press"},
  "sal_cable":{p:"straight_arm_pulldown",r:"Voltra"},
  "sal_cable_iso_lateral":{p:"straight_arm_pulldown",r:"Voltra",u:1,o:"Iso-Lateral"},
  "sal_rope":{p:"straight_arm_pulldown",r:"Voltra",o:"Rope"},
  "pullover_dumbbell":{p:"pullover",r:"Dumbbell"},
  "pullover_barbell":{p:"pullover",r:"Barbell"},
  "pullover_machine":{p:"pullover",r:"Voltra",o:"Machine"},
  "back_ext_weighted":{p:"back_extension",r:"BW+",o:"Weighted FA"},
  "back_ext_single_leg":{p:"back_extension",r:"BW+",u:1,o:"FA"},
  "back_ext_iso_hold":{p:"back_extension",r:"BW+",o:"Iso Hold FA"},
  "back_ext_single_leg_iso":{p:"back_extension",r:"BW+",u:1,o:"Iso Hold FA"},
  "back_ext_reverse_hyper":{p:"reverse_hyper",r:"BW+"},
  "ohp_barbell_standing":{p:"overhead_press",r:"Barbell",v:"Standing"},
  "ohp_barbell_seated":{p:"overhead_press",r:"Barbell",v:"Seated"},
  "ohp_dumbbell_standing":{p:"overhead_press",r:"Dumbbell",v:"Standing"},
  "ohp_dumbbell_seated":{p:"overhead_press",r:"Dumbbell",v:"Seated"},
  "ohp_cable":{p:"overhead_press",r:"Voltra",v:"Standing"},
  "ohp_machine":{p:"overhead_press",r:"Voltra",v:"Seated",o:"Machine"},
  "ohp_landmine_kneeling":{p:"overhead_press",r:"Landmine",v:"Kneeling"},
  "ohp_landmine_single":{p:"overhead_press",r:"Landmine",v:"Standing",u:1},
  "ohp_landmine_standing":{p:"overhead_press",r:"Landmine",v:"Standing"},
  "ohp_landmine_jammer":{p:"overhead_press",r:"Landmine",v:"Standing",o:"Jammer"},
  "ohp_dumbbell_arnold":{p:"overhead_press",r:"Dumbbell",v:"Seated",o:"Arnold"},
  "lat_raise_dumbbell":{p:"shoulder_raise",r:"Dumbbell",v:"Standing",o:"Lateral"},
  "lat_raise_dumbbell_seated":{p:"shoulder_raise",r:"Dumbbell",v:"Seated",o:"Lateral"},
  "lat_raise_cable":{p:"shoulder_raise",r:"Voltra",v:"Standing",o:"Lateral"},
  "lat_raise_cable_single_arm":{p:"shoulder_raise",r:"Voltra",v:"Standing",u:1,o:"Lateral"},
  "lat_raise_machine":{p:"shoulder_raise",r:"Voltra",v:"Seated",o:"Lateral Machine"},
  "lat_raise_band":{p:"shoulder_raise",r:"Dumbbell",v:"Standing",b:1,o:"Lateral Band"},
  "front_raise_barbell":{p:"shoulder_raise",r:"Barbell",v:"Standing",o:"Front"},
  "front_raise_dumbbell":{p:"shoulder_raise",r:"Dumbbell",v:"Standing",o:"Front"},
  "front_raise_plate":{p:"shoulder_raise",r:"Plate",v:"Standing",o:"Front"},
  "face_pull_cable":{p:"face_pull",r:"Voltra"},
  "face_pull_band":{p:"face_pull",r:"Voltra",b:1,o:"Band"},
  "upright_row_barbell":{p:"upright_row",r:"Barbell"},
  "upright_row_dumbbell":{p:"upright_row",r:"Dumbbell"},
  "upright_row_cable":{p:"upright_row",r:"Voltra"},
  "upright_row_dumbbell_single":{p:"upright_row",r:"Dumbbell",u:1},
  "upright_row_staggered_db_high_pull":{p:"upright_row",r:"Dumbbell",o:"Staggered High Pull"},
  "rear_delt_cable":{p:"rear_delt_fly",r:"Voltra"},
  "rear_delt_dumbbell_chest_supported":{p:"rear_delt_fly",r:"Dumbbell",o:"Chest Supported"},
  "rear_delt_dumbbell":{p:"rear_delt_fly",r:"Dumbbell"},
  "rear_delt_machine":{p:"rear_delt_fly",r:"Voltra",o:"Machine"},
  "rear_delt_band":{p:"rear_delt_fly",r:"Dumbbell",b:1,o:"Band"},
  "shrug_barbell":{p:"shrug",r:"Barbell"},
  "shrug_dumbbell":{p:"shrug",r:"Dumbbell"},
  "shrug_cable":{p:"shrug",r:"Voltra"},
  "shrug_trap_bar":{p:"shrug",r:"Trap Bar"},
  "shrug_smith":{p:"shrug",r:"Voltra",o:"Smith Machine"},
  "shoulder_w_band":{p:"shoulder_rotation",r:"Dumbbell",o:"W Rotation Band"},
  "band_pullaparts":{p:"shoulder_rotation",r:"Dumbbell",o:"Pullaparts Band"},
  "sunrise_raises":{p:"shoulder_rotation",r:"Dumbbell",o:"Sunrise"},
  "clock_raises":{p:"shoulder_rotation",r:"Dumbbell",o:"Clock"},
  "jesus_raises":{p:"shoulder_rotation",r:"Dumbbell",o:"Jesus"},
  "curl_dumbbell":{p:"bicep_curl",r:"Dumbbell",v:"Standing"},
  "curl_dumbbell_incline_seated":{p:"bicep_curl",r:"Dumbbell",v:"Incline"},
  "curl_dumbbell_concentration":{p:"bicep_curl",r:"Dumbbell",v:"Seated",o:"Concentration"},
  "curl_dumbbell_spider":{p:"bicep_curl",r:"Dumbbell",v:"Incline",o:"Spider"},
  "curl_barbell":{p:"bicep_curl",r:"Barbell",v:"Standing"},
  "curl_barbell_ez":{p:"bicep_curl",r:"Barbell",v:"Standing",o:"EZ Bar"},
  "curl_barbell_preacher":{p:"bicep_curl",r:"Barbell",v:"Preacher"},
  "curl_barbell_spider":{p:"bicep_curl",r:"Barbell",v:"Incline",o:"Spider"},
  "curl_cable":{p:"bicep_curl",r:"Voltra",v:"Standing"},
  "curl_cable_rope":{p:"bicep_curl",r:"Voltra",v:"Standing",o:"Rope"},
  "curl_cable_high":{p:"bicep_curl",r:"Voltra",v:"Standing",o:"High Cable"},
  "curl_cable_single_arm":{p:"bicep_curl",r:"Voltra",v:"Standing",u:1},
  "curl_dumbbell_hammer":{p:"bicep_curl",r:"Dumbbell",v:"Standing",o:"Hammer"},
  "curl_cable_hammer":{p:"bicep_curl",r:"Voltra",v:"Standing",o:"Hammer"},
  "curl_machine":{p:"bicep_curl",r:"Voltra",v:"Seated",o:"Machine"},
  "curl_dumbbell_preacher":{p:"bicep_curl",r:"Dumbbell",v:"Preacher"},
  "curl_dumbbell_zottman":{p:"bicep_curl",r:"Dumbbell",v:"Standing",o:"Zottman"},
  "curl_suspension":{p:"bicep_curl",r:"Voltra",v:"Standing",o:"Suspension"},
  "curl_plate":{p:"bicep_curl",r:"Plate",v:"Standing"},
  "tri_ext_dumbbell_overhead":{p:"tricep_extension",r:"Dumbbell",v:"Standing",o:"Overhead"},
  "tri_ext_barbell_overhead":{p:"tricep_extension",r:"Barbell",v:"Standing",o:"Overhead"},
  "tri_ext_cable_overhead":{p:"tricep_extension",r:"Voltra",v:"Standing",o:"Overhead"},
  "tri_ext_cable_overhead_single":{p:"tricep_extension",r:"Voltra",v:"Standing",u:1,o:"Overhead"},
  "tri_ext_cable_handle":{p:"tricep_extension",r:"Voltra",v:"Standing",o:"Handle"},
  "tri_ext_cable_handleless":{p:"tricep_extension",r:"Voltra",v:"Standing",o:"Handleless"},
  "tri_ext_machine":{p:"tricep_extension",r:"Voltra",v:"Seated",o:"Machine"},
  "tri_ext_band":{p:"tricep_extension",r:"Dumbbell",v:"Standing",b:1,o:"Band"},
  "tri_ext_suspension_ring":{p:"tricep_extension",r:"Voltra",v:"Flat",o:"Ring"},
  "tri_ext_suspension":{p:"tricep_extension",r:"Voltra",v:"Flat",o:"Suspension"},
  "tri_ext_plate":{p:"tricep_extension",r:"Dumbbell",v:"Flat",o:"Plate"},
  "tri_ext_dumbbell_single":{p:"tricep_extension",r:"Dumbbell",v:"Standing",u:1},
  "tri_push_cable_bar":{p:"tricep_extension",r:"Voltra",v:"Standing",o:"Pushdown Bar"},
  "tri_push_cable_rope":{p:"tricep_extension",r:"Voltra",v:"Standing",o:"Pushdown Rope"},
  "tri_push_cable_reverse":{p:"tricep_extension",r:"Voltra",v:"Standing",o:"Pushdown Reverse"},
  "tri_push_cable_single":{p:"tricep_extension",r:"Voltra",v:"Standing",u:1,o:"Pushdown"},
  "tri_push_cable_single_handle":{p:"tricep_extension",r:"Voltra",v:"Standing",u:1,o:"Pushdown Handle"},
  "skull_barbell":{p:"tricep_extension",r:"Barbell",v:"Flat",o:"Skullcrusher"},
  "skull_dumbbell":{p:"tricep_extension",r:"Dumbbell",v:"Flat",o:"Skullcrusher"},
  "skull_cambered":{p:"tricep_extension",r:"Barbell",v:"Flat",o:"Cambered Skullcrusher"},
  "kickback_dumbbell":{p:"tricep_extension",r:"Dumbbell",v:"Standing",o:"Kickback"},
  "kickback_cable":{p:"tricep_extension",r:"Voltra",v:"Standing",o:"Kickback"},
  "squat_barbell_back":{p:"squat",r:"Barbell",v:"Back"},
  "squat_barbell_front":{p:"squat",r:"Barbell",v:"Front"},
  "squat_barbell_overhead":{p:"squat",r:"Barbell",v:"Front",o:"Overhead"},
  "squat_barbell_pause":{p:"squat",r:"Barbell",v:"Back",o:"Pause"},
  "squat_barbell_zercher":{p:"squat",r:"Barbell",v:"Zercher"},
  "squat_barbell_cossack":{p:"squat",r:"Barbell",v:"Cossack"},
  "squat_barbell_clean":{p:"squat",r:"Barbell",v:"Front",o:"Clean"},
  "squat_barbell_thruster":{p:"squat",r:"Barbell",v:"Front",o:"Thruster"},
  "squat_landmine":{p:"squat",r:"Landmine",v:"Goblet"},
  "squat_landmine_hack":{p:"squat",r:"Landmine",v:"Hack"},
  "squat_dumbbell_goblet":{p:"squat",r:"Dumbbell",v:"Goblet"},
  "squat_kettlebell_goblet":{p:"squat",r:"Dumbbell",v:"Goblet",o:"Kettlebell"},
  "squat_cable_goblet":{p:"squat",r:"Voltra",v:"Goblet"},
  "squat_sissy":{p:"squat",r:"Dumbbell",v:"Sissy",o:"Weighted"},
  "squat_sissy_cable":{p:"squat",r:"Voltra",v:"Sissy"},
  "squat_sissy_banded":{p:"squat",r:"Dumbbell",v:"Sissy",b:1},
  "squat_spanish":{p:"squat",r:"Dumbbell",v:"Cossack",b:1,o:"Spanish"},
  "squat_belt":{p:"squat",r:"Barbell",v:"Belt"},
  "squat_belt_cable":{p:"squat",r:"Voltra",v:"Belt"},
  "squat_box_pistol":{p:"squat",r:"Dumbbell",v:"Cossack",o:"Box Pistol"},
  "hack_squat_barbell":{p:"squat",r:"Barbell",v:"Hack"},
  "hack_squat_machine":{p:"squat",r:"Voltra",v:"Hack",o:"Machine"},
  "leg_press_machine":{p:"squat",r:"Voltra",v:"Hack",o:"Leg Press"},
  "leg_press_machine_horizontal":{p:"squat",r:"Voltra",v:"Hack",o:"Leg Press Horizontal"},
  "leg_press_single_leg":{p:"squat",r:"Voltra",v:"Hack",o:"Leg Press Single Leg"},
  "leg_press_calf":{p:"calf_raise",r:"Voltra",v:"Seated",o:"Leg Press"},
  "split_squat_barbell":{p:"lunge",r:"Barbell",v:"Stationary"},
  "split_squat_dumbbell":{p:"lunge",r:"Dumbbell",v:"Stationary"},
  "split_squat_stationary":{p:"lunge",r:"Dumbbell",v:"Stationary",o:"BW"},
  "bulgarian_split_squat_bodyweight":{p:"lunge",r:"Dumbbell",v:"BSS",o:"BW"},
  "bulgarian_split_squat_barbell":{p:"lunge",r:"Barbell",v:"BSS"},
  "bulgarian_goblet":{p:"lunge",r:"Goblet",v:"BSS"},
  "lunge_dumbbell":{p:"lunge",r:"Dumbbell",v:"Walking"},
  "lunge_barbell":{p:"lunge",r:"Barbell",v:"Walking"},
  "step_up_dumbbell":{p:"lunge",r:"Dumbbell",v:"Step-Up"},
  "leg_ext_machine":{p:"leg_extension",r:"Voltra",o:"Machine"},
  "leg_ext_plate_loaded":{p:"leg_extension",r:"Voltra",o:"Plate-Loaded"},
  "leg_ext_machine_iso":{p:"leg_extension",r:"Voltra",o:"Iso Machine"},
  "leg_ext_reverse_nordic":{p:"reverse_nordic",r:"BW+"},
  "deadlift_barbell":{p:"deadlift",r:"Barbell"},
  "deadlift_trap_bar":{p:"deadlift",r:"Trap Bar"},
  "deadlift_landmine":{p:"deadlift",r:"Barbell",o:"Landmine"},
  "deadlift_jefferson_curl":{p:"jefferson_curl",r:"Barbell"},
  "deadlift_trap_bar_jump":{p:"deadlift",r:"Trap Bar",o:"Jump"},
  "rdl_barbell":{p:"rdl",r:"Barbell"},
  "rdl_dumbbell":{p:"rdl",r:"Dumbbell"},
  "rdl_dumbbell_single_leg":{p:"rdl",r:"Dumbbell",u:1},
  "rdl_dumbbell_kneeling_single":{p:"rdl",r:"Dumbbell",u:1,o:"Kneeling"},
  "rdl_voltra":{p:"rdl",r:"Voltra"},
  "good_morning_barbell":{p:"good_morning",r:"Barbell"},
  "good_morning_band":{p:"good_morning",r:"Barbell",b:1,o:"Band"},
  "leg_curl_plate_loaded":{p:"ham_curl",r:"Voltra",o:"Plate-Loaded"},
  "leg_curl_machine_lying":{p:"ham_curl",r:"Voltra",o:"Lying Machine"},
  "leg_curl_machine_iso":{p:"ham_curl",r:"Voltra",o:"Iso Machine"},
  "ghd_leg_curl":{p:"ghr",r:"BW+",o:"FA"},
  "nordic_hamstring":{p:"nordic_curl",r:"BW+"},
  "nordic_inclined":{p:"nordic_curl",r:"BW+",o:"Inclined FA"},
  "voltra_ham_curl":{p:"ham_curl",r:"Voltra",o:"Standing"},
  "hip_thrust_barbell":{p:"hip_thrust",r:"Barbell"},
  "hip_thrust_machine":{p:"hip_thrust",r:"Voltra",o:"Machine"},
  "calf_seated":{p:"calf_raise",r:"Voltra",v:"Seated",o:"Machine"},
  "calf_dumbbell_seated":{p:"calf_raise",r:"Dumbbell",v:"Seated"},
  "calf_barbell_seated":{p:"calf_raise",r:"Barbell",v:"Seated"},
  "calf_machine_press":{p:"calf_raise",r:"Voltra",v:"Seated",o:"Machine Press"},
  "calf_standing_machine":{p:"calf_raise",r:"Voltra",v:"Standing",o:"Machine"},
  "calf_landmine":{p:"calf_raise",r:"Landmine",v:"Standing"},
  "calf_hanging_landmine":{p:"calf_raise",r:"Landmine",v:"Standing",o:"Hanging"},
  "calf_barbell_standing_single":{p:"calf_raise",r:"Barbell",v:"Standing",u:1},
  "calf_belt":{p:"calf_raise",r:"Belt",v:"Standing"},
  "calf_hanging_cable":{p:"calf_raise",r:"Voltra",v:"Standing",o:"Hanging Cable"},
  "calf_hanging_barbell":{p:"calf_raise",r:"Barbell",v:"Standing",o:"Hanging"},
  "crunch_cable":{p:"crunch",r:"Voltra",o:"Cable"},
  "crunch_machine":{p:"crunch",r:"Voltra",o:"Machine"},
  "crunch_bench":{p:"crunch",r:"BW+",o:"Bench"},
  "crunch_db":{p:"crunch",r:"BW+",o:"Dumbbell"},
  "crunch_band":{p:"crunch",r:"BW+",o:"Band"},
  "crunch_weighted":{p:"crunch",r:"BW+",o:"Weighted"},
  "crunch_ghd":{p:"crunch",r:"BW+",o:"GHD FA"},
  "crunch_suspension":{p:"crunch",r:"BW+",o:"Suspension"},
  "crunch_decline_weighted":{p:"crunch",r:"BW+",o:"Decline Weighted"},
  "knee_raise_parallel":{p:"leg_raise",r:"BW+",o:"Knee Raise Parallel"},
  "hanging_leg_raise":{p:"leg_raise",r:"BW+",o:"Hanging"},
  "hanging_knee_raise":{p:"leg_raise",r:"BW+",o:"Hanging Knee"},
  "leg_raise_decline_bench":{p:"leg_raise",r:"BW+",o:"Decline Bench"},
  "captains_chair":{p:"leg_raise",r:"BW+",o:"Captain's Chair"},
  "ghd_leg_lift":{p:"leg_raise",r:"BW+",o:"GHD FA"},
  "lying_leg_raise":{p:"leg_raise",r:"BW+",o:"Lying"},
  "v_up":{p:"leg_raise",r:"BW+",o:"V Up"},
  "jackknife_suspension":{p:"leg_raise",r:"BW+",o:"Jackknife Suspension"},
  "ab_wheel":{p:"ab_wheel",r:"BW+"},
  "plank_standard":{p:"plank",r:"BW+",o:"Standard"},
  "plank_side":{p:"plank",r:"BW+",o:"Side"},
  "plank_hollow_rock":{p:"plank",r:"BW+",o:"Hollow Rock"},
  "plank_bird_dog":{p:"plank",r:"BW+",o:"Bird Dog"},
  "plank_mountain_climber":{p:"plank",r:"BW+",o:"Mountain Climber"},
  "plank_v_up_weighted":{p:"plank",r:"BW+",o:"Weighted V-Ups"},
  "pallof_band":{p:"pallof_press",r:"Voltra",b:1,o:"Band"},
  "pallof_cable":{p:"pallof_press",r:"Voltra"},
  "pallof_twist_press":{p:"pallof_press",r:"Voltra",o:"Twist Press"},
  "cable_twist_up_down":{p:"pallof_press",r:"Voltra",o:"Cable Twist"},
  "kneeling_landmine_rotation":{p:"pallof_press",r:"Voltra",o:"Kneeling LM Rotation"},
  "russian_twist_weighted":{p:"pallof_press",r:"Voltra",o:"Russian Twist"},
  "side_bend_dumbbell":{p:"side_bend",r:"Dumbbell"},
  "side_crunch_cable":{p:"side_bend",r:"Voltra",o:"Side Crunch"},
  "weighted_ql_bend":{p:"side_bend",r:"Dumbbell",o:"QL Bend"},
  "farmers_carry_dumbbell":{p:"farmers_carry",r:"Dumbbell"},
  "rowing_machine_cardio":{p:"rowing_machine",r:"Voltra"}
};

// Build a reverse map: new variant ID → old legacy variant ID
// This lets us preserve history when the same combo was previously logged under the old ID
const legacyReverseMap = {}; // newVariantId → oldVariantId
Object.entries(LEGACY_VARIANT_MAP).forEach(([oldId, spec]) => {
  const mods = { bands: !!spec.b, unilateral: !!spec.u, other: spec.o || '' };
  const newId = buildVariantId(spec.p, spec.r, spec.v || '', mods);
  legacyReverseMap[newId] = oldId;
});

// Resolve a variant ID: if it's a legacy ID, return it directly.
// If it's a new-style ID, check if there's a legacy equivalent.
function resolveVariantId(parentId, resistance, mainVariant, mods) {
  const newId = buildVariantId(parentId, resistance, mainVariant, mods);
  return legacyReverseMap[newId] || newId;
}

// Get a display name for any variantId (legacy or new)
function getHierarchicalDisplayName(variantId) {
  const legacy = LEGACY_VARIANT_MAP[variantId];
  if (legacy) {
    const h = hierarchyMap[legacy.p];
    if (h) {
      const abbrev = RES_ABBREV[legacy.r] || legacy.r;
      const mods = { bands: !!legacy.b, unilateral: !!legacy.u, other: legacy.o || '' };
      return buildExerciseName(h.name, abbrev, legacy.v || '', mods);
    }
  }
  // Try parsing new-style ID
  const parts = variantId.split('__');
  const h = hierarchyMap[parts[0]];
  if (h) {
    // Rebuild from parts
    return getVariantDisplayName(variantId); // fallback to existing
  }
  return getVariantDisplayName(variantId);
}
</script>

<script>
// ═══════════════════════════════════════════════════════════════
// APP STATE
// ═══════════════════════════════════════════════════════════════
let activeSession = null; // current in-progress workout
let sessionTimerInterval = null;
let sessionStartEpoch = null;
let collapsedExercises = new Set(); // track collapsed exercise indices

let editingTemplateId = null;
let pendingPickExerciseCallback = null;
let editingSetContext = null; // {sessionExIndex, setIndex}


// ── Convenience: get sessions sorted newest-first ──
async function getSortedSessions() {
  const sessions = await dbGetAll('sessions');
  return sessions.sort((a, b) => b.startTime - a.startTime);
}

// ═══════════════════════════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════════════════════════
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`screen-${name}`)?.classList.add('active');
  document.querySelector(`[data-screen="${name}"]`)?.classList.add('active');

  if (name === 'home') renderHome();
  if (name === 'templates') renderTemplates();
  if (name === 'library') renderLibrary();
  if (name === 'progress') renderProgress();
  if (name === 'mobility') renderMobility();
}

document.querySelectorAll('.nav-btn').forEach(btn => {
  btn.addEventListener('click', () => showScreen(btn.dataset.screen));
});

// ═══════════════════════════════════════════════════════════════
// TOAST
// ═══════════════════════════════════════════════════════════════
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// ═══════════════════════════════════════════════════════════════
// MODALS
// ═══════════════════════════════════════════════════════════════
function openModal(id) {
  document.getElementById(id)?.classList.add('open');
  document.getElementById('modal-backdrop').classList.add('show');
}
function closeModal(id) {
  document.getElementById(id)?.classList.remove('open');
  // Hide backdrop if no modals are open
  const anyOpen = document.querySelector('.modal-overlay.open');
  if (!anyOpen) document.getElementById('modal-backdrop').classList.remove('show');
}
// Close on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) {
      if (overlay.id === 'modal-pick-exercise') closeExercisePicker();
      else closeModal(overlay.id);
    }
  });
});

// ═══════════════════════════════════════════════════════════════
// HOME SCREEN
// ═══════════════════════════════════════════════════════════════
async function renderHome() {
  const sessions = await getSortedSessions();

  const sub = document.getElementById('home-stats-sub');
  sub.textContent = `${sessions.length} sessions logged`;

  const list = document.getElementById('recent-workouts');
  const recent = sessions.slice(0, 20);

  if (recent.length === 0) {
    list.innerHTML = `<div class="empty-state">
      <div class="empty-state-icon">💪</div>
      <div class="empty-state-title">No workouts yet</div>
      <div class="empty-state-sub">Tap + New to start your first session</div>
    </div>`;
    return;
  }

  const cards = recent.map(s => {
    const date = new Date(s.startTime);
    const dateStr = date.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
    const dur = s.durationMinutes ? `${s.durationMinutes}m` : '';
    const totalSets = s.exercises.reduce((acc, ex) => acc + ex.sets.filter(st => st.completed).length, 0);
    const exList = s.exercises.slice(0,4).map(ex => {
      const name = getVariantDisplayName(ex.variantId);
      const topSet = ex.sets.filter(st => st.completed && st.weight).sort((a,b) => b.weight - a.weight)[0];
      return `<div class="workout-card-exercise">${name}${topSet ? ` <span style="color:var(--text3);font-family:var(--mono);font-size:11px">${topSet.weight}×${topSet.reps}</span>` : ''}</div>`;
    }).join('');
    const more = s.exercises.length > 4 ? `<div style="font-size:11px;color:var(--text3);margin-top:2px">+${s.exercises.length - 4} more</div>` : '';

    return {s, dateStr, dur, totalSets, exList, more};
  });

  // Load bodyweights for session dates
  const bwMap = {};
  await Promise.all(cards.map(async ({s}) => {
    const d = new Date(s.startTime).toISOString().split('T')[0];
    const bw = await dbGet('bodyweight', d);
    if (bw) bwMap[s.id] = bw.weight_lbs;
  }));

  list.innerHTML = cards.map(({s, dateStr, dur, totalSets, exList, more}) => {
    const bwHtml = bwMap[s.id] ? `<div class="workout-meta-item"><span class="workout-meta-val">${bwMap[s.id]}</span> lbs</div>` : '';
    return `<div class="workout-card" onclick="viewWorkoutDetail('${s.id}')">
      <div class="workout-card-header">
        <div class="workout-card-title">${escHtml(s.title)}</div>
        <div class="workout-card-date">${dateStr}</div>
      </div>
      <div class="workout-card-exercises">${exList}${more}</div>
      <div class="workout-card-meta">
        ${dur ? `<div class="workout-meta-item"><span class="workout-meta-val">${dur}</span></div>` : ''}
        <div class="workout-meta-item"><span class="workout-meta-val">${totalSets}</span> sets</div>
        <div class="workout-meta-item"><span class="workout-meta-val">${s.exercises.length}</span> exercises</div>
        ${bwHtml}
      </div>
    </div>`;
  }).join('');
}

document.getElementById('new-workout-btn').addEventListener('click', () => {
  openNewWorkoutModal();
});

async function openNewWorkoutModal() {
  const templates = await dbGetAll('templates');
  const list = document.getElementById('modal-template-list');
  list.innerHTML = templates.map(t => `
    <button class="btn btn-secondary" style="width:100%;text-align:left;justify-content:space-between" onclick="startFromTemplate('${t.id}')">
      <span style="font-size:14px;font-weight:500">${escHtml(t.name)}</span>
      <span style="font-size:12px;color:var(--text3)">${t.exercises.length} exercises</span>
    </button>`).join('');
  if (templates.length === 0) {
    list.innerHTML = `<div style="font-size:13px;color:var(--text3);text-align:center;padding:12px 0">No templates yet</div>`;
  }
  openModal('modal-new-workout');
}

document.getElementById('start-empty-btn').addEventListener('click', () => {
  closeModal('modal-new-workout');
  startSession({title: 'Workout', exercises: []});
});

async function startFromTemplate(templateId) {
  closeModal('modal-new-workout');
  let tmpl = null;
  try { tmpl = await dbGet('templates', templateId); } catch(e) {}
  if (!tmpl) { showToast('Template not found'); return; }
  
  // Build session exercises one at a time so one failure can't block others
  const exercises = [];
  for (const te of (tmpl.exercises || [])) {
    try {
      let lastSets = null;
      try { lastSets = await getLastSetsForVariant(te.variantId); } catch(e) {}
      const defaultSets = te.defaultSets && te.defaultSets.length > 0 ? te.defaultSets : null;
      const rawSets = defaultSets || lastSets || [{weight:0,reps:8},{weight:0,reps:8},{weight:0,reps:8}];
      exercises.push({
        variantId: te.variantId,
        sets: rawSets.map((s,i) => ({
          index: i,
          weight: s.weight || 0,
          reps: s.reps || 8,
          completed: false, completedAt: null, rpe: null, restSeconds: null, notes: ''
        }))
      });
    } catch(e) {
      console.warn('Failed to build exercise', te.variantId, e);
      // Add with default sets so the exercise still shows up
      exercises.push({
        variantId: te.variantId,
        sets: [{index:0,weight:0,reps:8,completed:false,completedAt:null,rpe:null,restSeconds:null,notes:''},
               {index:1,weight:0,reps:8,completed:false,completedAt:null,rpe:null,restSeconds:null,notes:''},
               {index:2,weight:0,reps:8,completed:false,completedAt:null,rpe:null,restSeconds:null,notes:''}]
      });
    }
  }
  startSession({title: tmpl.name, exercises});
}

async function getLastSetsForVariant(variantId) {
  const sessions = await getSortedSessions();
  const sorted = sessions;
  for (const s of sorted) {
    const ex = s.exercises.find(e => e.variantId === variantId);
    if (ex && ex.sets.some(st => st.completed)) {
      return ex.sets.filter(st => st.completed).map(st => ({weight: st.weight, reps: st.reps}));
    }
  }
  return [{weight: 0, reps: 8}, {weight: 0, reps: 8}, {weight: 0, reps: 8}];
}

// ═══════════════════════════════════════════════════════════════
// ACTIVE SESSION
// ═══════════════════════════════════════════════════════════════
function startSession(sessionData) {
  sessionStartEpoch = Date.now();
  collapsedExercises = new Set();
  activeSession = {
    id: uid(),
    title: sessionData.title,
    startTime: sessionStartEpoch,
    endTime: null,
    durationMinutes: null,
    exercises: (sessionData.exercises || []).map(ex => {
      const rawSets = (ex.sets && ex.sets.length > 0) ? ex.sets : [{weight:0,reps:8},{weight:0,reps:8},{weight:0,reps:8}];
      return {
        variantId: ex.variantId,
        sets: rawSets.map((s, i) => ({
          index: i,
          weight: typeof s.weight === 'number' ? s.weight : (parseFloat(s.weight) || 0),
          reps: typeof s.reps === 'number' ? s.reps : (parseInt(s.reps) || 8),
          completed: s.completed || false,
          completedAt: s.completedAt || null,
          rpe: s.rpe || null,
          restSeconds: s.restSeconds || null,
          notes: s.notes || ''
        }))
      };
    })
  };
  renderActiveSession();
  document.getElementById('active-session').classList.add('open');
  startTimer();
}

function startTimer() {
  clearInterval(sessionTimerInterval);
  sessionTimerInterval = setInterval(updateTimer, 1000);
  updateTimer();
}

function updateTimer() {
  if (!sessionStartEpoch) return;
  const elapsed = Math.floor((Date.now() - sessionStartEpoch) / 1000);
  const m = Math.floor(elapsed / 60);
  const s = elapsed % 60;
  document.getElementById('session-timer').textContent = `${m}:${s.toString().padStart(2,'0')}`;
}

function renderActiveSession() {
  if (!activeSession) return;
  document.getElementById('session-title').textContent = activeSession.title;

  // Update notes toggle state
  const notesToggle = document.getElementById('session-notes-toggle');
  const notesInput = document.getElementById('session-notes-input');
  if (notesInput.value.trim()) {
    notesToggle.style.color = 'var(--accent-blue)';
  } else {
    notesToggle.style.color = 'var(--text3)';
  }

  const body = document.getElementById('session-body');
  const exercises = activeSession.exercises;
  const rendered = new Set();
  const items = [];

  const ssColors = ['#a78bfa','#f472b6','#60a5fa','#34d399','#fb923c'];
  const ssColorMap = {};
  let ssColorIdx = 0;

  exercises.forEach((ex, idx) => {
    if (rendered.has(idx)) return;
    if (!ex.supersetId) {
      items.push({type:'solo', idx});
      rendered.add(idx);
    } else {
      const groupIndices = exercises.map((e,i) => e.supersetId === ex.supersetId ? i : -1).filter(i => i >= 0);
      groupIndices.forEach(i => rendered.add(i));
      if (!ssColorMap[ex.supersetId]) {
        ssColorMap[ex.supersetId] = ssColors[ssColorIdx % ssColors.length];
        ssColorIdx++;
      }
      items.push({type:'superset', indices: groupIndices, id: ex.supersetId, color: ssColorMap[ex.supersetId]});
    }
  });

  function renderExBlock(exIdx) {
    const ex = exercises[exIdx];
    const info = variantMap[ex.variantId];
    const parentName = info ? info.parent.name : ex.variantId;
    const variantName = info ? info.variant.name : '';
    const setsHtml = `
      <div class="sets-header">
        <div class="sets-header-cell">#</div>
        <div class="sets-header-cell">LBS</div>
        <div class="sets-header-cell">REPS</div>
        <div class="sets-header-cell"></div>
      </div>
      ${(ex.sets || []).map((set, si) => renderSetRow(exIdx, si, set)).join('')}
    `;
    const ssActive = ex.supersetId ? 'color:var(--accent)' : '';
    const hasNote = !!exerciseNotes[ex.variantId];
    const cueHtml = hasNote ? `<div class="ex-cue">${escHtml(exerciseNotes[ex.variantId])}</div>` : '';
    const totalEx = exercises.length;
    const completedCount = (ex.sets || []).filter(s => s.completed).length;
    const totalSets = (ex.sets || []).length;
    const isCollapsed = collapsedExercises.has(exIdx);
    const summaryText = completedCount > 0
      ? `${completedCount}/${totalSets} sets done` + ((ex.sets || []).filter(s => s.completed && s.weight).length > 0 ? ` · ${(ex.sets || []).filter(s => s.completed && s.weight).sort((a,b) => b.weight - a.weight)[0].weight} lbs top` : '')
      : `${totalSets} sets`;
    return `<div class="ex-block ${isCollapsed ? 'collapsed' : ''}" id="ex-block-${exIdx}">
      <div class="ex-block-header" onclick="toggleExCollapse(${exIdx})">
        <svg class="collapse-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
        <div style="display:flex;flex-direction:column;gap:2px;margin-right:4px;flex-shrink:0" onclick="event.stopPropagation()">
          <button class="reorder-btn" onclick="moveExercise(${exIdx},-1)" ${exIdx===0?'disabled style="opacity:0.3"':''}>
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="18 15 12 9 6 15"/></svg>
          </button>
          <button class="reorder-btn" onclick="moveExercise(${exIdx},1)" ${exIdx===totalEx-1?'disabled style="opacity:0.3"':''}>
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
        </div>
        <div class="ex-block-info">
          <div class="ex-name">${escHtml(parentName)}</div>
          <div class="ex-variant">${escHtml(variantName)}</div>
          <div class="ex-summary">${summaryText}</div>
        </div>
        <div class="ex-block-actions" onclick="event.stopPropagation()">
          <button class="btn btn-ghost btn-sm btn-icon" onclick="openSupersetModal(${exIdx})" title="Superset" style="${ssActive}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
          </button>
          <button class="btn btn-ghost btn-sm btn-icon" onclick="openSwapVariantModal(${exIdx})" title="Swap variant">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 16V4m0 0L3 8m4-4l4 4M17 8v12m0 0l4-4m-4 4l-4-4"/></svg>
          </button>
          <button class="btn btn-ghost btn-sm btn-icon" onclick="openExNotesModal('${ex.variantId}')" title="Notes" style="${hasNote?'color:var(--accent-blue)':''}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </button>
          <button class="btn btn-ghost btn-sm btn-icon" onclick="showExerciseAnalyticsFromSession('${ex.variantId}')" title="History">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          </button>
          <button class="btn btn-ghost btn-sm btn-icon" onclick="removeExFromSession(${exIdx})" title="Remove">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      </div>
      <div class="ex-block-body">
        ${cueHtml}
        ${setsHtml}
        <div class="ex-block-footer">
          <div class="prev-best" id="prev-best-${exIdx}">loading…</div>
          <button class="btn btn-ghost btn-sm" onclick="addSetToExercise(${exIdx})">+ Set</button>
        </div>
      </div>
    </div>`;
  }

  body.innerHTML = items.map(item => {
    if (item.type === 'solo') return renderExBlock(item.idx);
    const blocksHtml = item.indices.map((idx, i) =>
      (i > 0 ? `<div class="superset-connector" data-label="then"></div>` : '') + renderExBlock(idx)
    ).join('');
    return `<div class="superset-group" style="border-left-color:${item.color}">
      <div class="superset-label">
        <div class="superset-label-text">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
          Superset · ${item.indices.length} exercises
        </div>
      </div>
      ${blocksHtml}
    </div>`;
  }).join('');

  activeSession.exercises.forEach((ex, idx) => loadPrevBest(ex.variantId, idx));
  attachSetInputListeners();
}

function renderSetRow(exIdx, si, set) {
  const w = set.weight || '';
  const r = set.reps || '';
  // Show warmup (W) label for first set if not completed, numbered otherwise
  const setLabel = si === 0 && !set.completed ? 'W' : String(si + 1);
  const labelColor = si === 0 && !set.completed ? 'color:var(--accent-pink)' : '';
  return `<div class="set-row ${set.completed ? 'completed' : ''}" id="set-row-${exIdx}-${si}" onclick="focusSetRow(event, ${exIdx}, ${si})">
    <div class="set-num" style="${labelColor}">${setLabel}</div>
    <input class="set-cell-input" type="number" step="0.5" value="${w}" placeholder="0"
      data-ex="${exIdx}" data-set="${si}" data-field="weight"
      inputmode="decimal">
    <input class="set-cell-input" type="number" value="${r}" placeholder="0"
      data-ex="${exIdx}" data-set="${si}" data-field="reps"
      inputmode="numeric">
    <div class="set-check">
      <button class="check-btn ${set.completed ? 'done' : ''}"
        onclick="event.stopPropagation(); toggleSetComplete(${exIdx}, ${si})"
        id="check-${exIdx}-${si}">
        ${set.completed ? `<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>` : ''}
      </button>
    </div>
  </div>
  <div class="set-detail" id="set-detail-${exIdx}-${si}">
    <div class="set-detail-row">
      <button class="btn btn-ghost btn-sm" style="flex:1" onclick="openSetDetailModal(${exIdx},${si})">Notes / RPE / Rest…</button>
    </div>
  </div>`;
}

function toggleExCollapse(exIdx) {
  const block = document.getElementById('ex-block-' + exIdx);
  if (!block) return;
  if (collapsedExercises.has(exIdx)) {
    collapsedExercises.delete(exIdx);
    block.classList.remove('collapsed');
  } else {
    collapsedExercises.add(exIdx);
    block.classList.add('collapsed');
  }
}

function focusSetRow(e, exIdx, si) {
  // If tapped on or near the weight column, focus weight; reps column focuses reps
  const row = document.getElementById('set-row-' + exIdx + '-' + si);
  if (!row) return;
  const rect = row.getBoundingClientRect();
  const relX = e.clientX - rect.left;
  const midX = rect.width / 2;
  const wInput = document.querySelector('input[data-ex="' + exIdx + '"][data-set="' + si + '"][data-field="weight"]');
  const rInput = document.querySelector('input[data-ex="' + exIdx + '"][data-set="' + si + '"][data-field="reps"]');
  // Only focus if the click wasn't directly on an input or check button
  if (e.target.tagName === 'INPUT' || e.target.closest('.set-check')) return;
  if (relX < midX) {
    wInput && wInput.focus();
  } else {
    rInput && rInput.focus();
  }
}

function attachSetInputListeners() {
  document.querySelectorAll('.set-cell-input').forEach(input => {
    // Use 'input' event for real-time saving — 'change' only fires on blur which is unreliable on mobile
    const saveVal = e => {
      const exIdx = parseInt(e.target.dataset.ex);
      const si = parseInt(e.target.dataset.set);
      const field = e.target.dataset.field;
      if (!activeSession) return;
      const raw = e.target.value;
      const val = field === 'reps' ? (parseInt(raw) || 0) : (parseFloat(raw) || 0);
      activeSession.exercises[exIdx].sets[si][field] = val;
    };
    input.addEventListener('input', saveVal);
    input.addEventListener('change', saveVal);
    // Long press on set row -> open detail
    input.addEventListener('contextmenu', e => {
      e.preventDefault();
      const exIdx = parseInt(e.target.dataset.ex);
      const si = parseInt(e.target.dataset.set);
      openSetDetailModal(exIdx, si);
    });
  });
}

function toggleSetComplete(exIdx, si) {
  if (!activeSession) return;
  const set = activeSession.exercises[exIdx].sets[si];

  // Read current input values before toggling
  const wInput = document.querySelector(`input[data-ex="${exIdx}"][data-set="${si}"][data-field="weight"]`);
  const rInput = document.querySelector(`input[data-ex="${exIdx}"][data-set="${si}"][data-field="reps"]`);
  if (wInput) set.weight = parseFloat(wInput.value) || 0;
  if (rInput) set.reps = parseInt(rInput.value) || 0;

  set.completed = !set.completed;
  set.completedAt = set.completed ? Date.now() : null;

  const row = document.getElementById(`set-row-${exIdx}-${si}`);
  const btn = document.getElementById(`check-${exIdx}-${si}`);
  if (set.completed) {
    row.classList.add('completed');
    btn.classList.add('done');
    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`;
    // Start rest timer
    startRestTimer(restTimerDuration);
    // Check for PR async
    const variantId = activeSession.exercises[exIdx].variantId;
    checkForPR(variantId, set.weight, set.reps).then(isPR => {
      if (isPR) {
        showToast('🏆 New PR!');
        // Add PR badge to set row
        const numEl = row.querySelector('.set-num');
        if (numEl && !numEl.querySelector('.pr-badge')) {
          numEl.insertAdjacentHTML('afterend', '<span class="pr-badge">🏆</span>');
        }
      }
    });
  } else {
    row.classList.remove('completed');
    btn.classList.remove('done');
    btn.innerHTML = '';
    skipRestTimer();
  }
}

function addSetToExercise(exIdx) {
  if (!activeSession) return;
  const ex = activeSession.exercises[exIdx];
  const lastSet = ex.sets[ex.sets.length - 1] || {weight: 0, reps: 8};
  ex.sets.push({
    index: ex.sets.length,
    weight: lastSet.weight,
    reps: lastSet.reps,
    completed: false,
    completedAt: null,
    rpe: null,
    restSeconds: null,
    notes: ''
  });
  // Re-render just the sets area
  renderActiveSession();
}

function removeExFromSession(exIdx) {
  if (!activeSession) return;
  activeSession.exercises.splice(exIdx, 1);
  // Rebuild collapsed set with shifted indices
  const newCollapsed = new Set();
  collapsedExercises.forEach(i => {
    if (i < exIdx) newCollapsed.add(i);
    else if (i > exIdx) newCollapsed.add(i - 1);
  });
  collapsedExercises = newCollapsed;
  renderActiveSession();
}

// ── Superset logic ───────────────────────────────────────────

let supersetTargetIdx = null;

function openSupersetModal(exIdx) {
  supersetTargetIdx = exIdx;
  const ex = activeSession.exercises[exIdx];
  const info = variantMap[ex.variantId];
  const name = info ? info.parent.name : ex.variantId;

  document.getElementById('superset-modal-title').textContent = 'Superset';
  document.getElementById('superset-modal-sub').textContent = name;

  // Show current group if in a superset
  const currentGroup = document.getElementById('superset-current-group');
  const groupList = document.getElementById('superset-group-list');
  if (ex.supersetId) {
    currentGroup.style.display = '';
    const members = activeSession.exercises
      .map((e,i) => ({e,i}))
      .filter(({e}) => e.supersetId === ex.supersetId);
    groupList.innerHTML = members.map(({e,i}) => {
      const mInfo = variantMap[e.variantId];
      const mName = mInfo ? mInfo.parent.name : e.variantId;
      return `<div style="padding:8px 10px;background:var(--bg3);border-radius:var(--r);font-size:13px;display:flex;align-items:center;gap:8px">
        <span style="width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0"></span>
        ${escHtml(mName)}${i === exIdx ? ' <span style="font-size:11px;color:var(--text3)">(this)</span>' : ''}
      </div>`;
    }).join('');
  } else {
    currentGroup.style.display = 'none';
  }

  // Show other exercises to pair with (not already in same group, not self)
  const linkSection = document.getElementById('superset-link-section');
  const exList = document.getElementById('superset-ex-list');
  const others = activeSession.exercises
    .map((e,i) => ({e,i}))
    .filter(({e,i}) => i !== exIdx && e.supersetId !== ex.supersetId);

  if (others.length === 0) {
    linkSection.style.display = 'none';
  } else {
    linkSection.style.display = '';
    document.querySelector('#superset-link-section .input-label').textContent =
      ex.supersetId ? 'Add to this superset…' : 'Pair with…';
    exList.innerHTML = others.map(({e,i}) => {
      const mInfo = variantMap[e.variantId];
      const mName = mInfo ? mInfo.parent.name : e.variantId;
      const mVariant = mInfo ? mInfo.variant.name : '';
      const alreadyInOtherGroup = e.supersetId && e.supersetId !== ex.supersetId;
      return `<div onclick="linkSuperset(${i})"
        style="padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);cursor:pointer;display:flex;align-items:center;gap:10px">
        <div style="flex:1">
          <div style="font-size:13px;font-weight:500">${escHtml(mName)}</div>
          ${mVariant ? `<div style="font-size:11px;color:var(--text3)">${escHtml(mVariant)}</div>` : ''}
          ${alreadyInOtherGroup ? `<div style="font-size:11px;color:var(--accent-pink)">in another superset</div>` : ''}
        </div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
      </div>`;
    }).join('');
  }

  openModal('modal-superset');
}

function linkSuperset(otherIdx) {
  if (supersetTargetIdx === null || !activeSession) return;
  const exA = activeSession.exercises[supersetTargetIdx];
  const exB = activeSession.exercises[otherIdx];

  // Determine the superset ID to use
  const ssId = exA.supersetId || exB.supersetId || ('ss_' + Date.now().toString(36));

  // If exB was in a different superset, migrate its whole group
  if (exB.supersetId && exB.supersetId !== ssId) {
    const oldId = exB.supersetId;
    activeSession.exercises.forEach(e => { if (e.supersetId === oldId) e.supersetId = ssId; });
  }

  exA.supersetId = ssId;
  exB.supersetId = ssId;

  closeModal('modal-superset');
  renderActiveSession();
  showToast('Superset created');
}

document.getElementById('superset-unlink-btn').addEventListener('click', () => {
  if (supersetTargetIdx === null || !activeSession) return;
  const ex = activeSession.exercises[supersetTargetIdx];
  if (!ex.supersetId) return;

  const ssId = ex.supersetId;
  const members = activeSession.exercises.filter(e => e.supersetId === ssId);

  // Remove just this exercise from the group
  ex.supersetId = null;

  // If only 1 left in group, dissolve the group
  const remaining = activeSession.exercises.filter(e => e.supersetId === ssId);
  if (remaining.length <= 1) remaining.forEach(e => e.supersetId = null);

  closeModal('modal-superset');
  renderActiveSession();
  showToast('Removed from superset');
});


async function loadPrevBest(variantId, idx) {
  const el = document.getElementById(`prev-best-${idx}`);
  if (!el) return;
  const sessions = await getSortedSessions();
  const sorted = sessions;
  for (const s of sorted) {
    const ex = s.exercises.find(e => e.variantId === variantId);
    if (ex) {
      const completed = ex.sets.filter(st => st.completed && st.weight);
      if (completed.length > 0) {
        const top = completed.sort((a,b) => b.weight - a.weight)[0];
        const date = new Date(s.startTime).toLocaleDateString('en-US', {month:'short', day:'numeric'});
        el.innerHTML = `Prev: <span>${top.weight}×${top.reps}</span> <span style="color:var(--text3)">${date}</span>`;
        return;
      }
    }
  }
  el.innerHTML = `<span>First time</span>`;
}

// Set detail modal
function openSetDetailModal(exIdx, si) {
  if (!activeSession) return;
  editingSetContext = {exIdx, si};
  const set = activeSession.exercises[exIdx].sets[si];
  const exName = getVariantDisplayName(activeSession.exercises[exIdx].variantId);

  document.getElementById('set-detail-title').textContent = `Set ${si+1} — ${exName.split('—')[0].trim()}`;
  document.getElementById('detail-weight').value = set.weight || '';
  document.getElementById('detail-reps').value = set.reps || '';
  document.getElementById('detail-rpe').value = set.rpe || '';
  document.getElementById('detail-rest').value = set.restSeconds || '';
  document.getElementById('detail-notes').value = set.notes || '';

  const tsEl = document.getElementById('detail-timestamp');
  if (set.completedAt) {
    const dt = new Date(set.completedAt);
    tsEl.textContent = `Completed at ${dt.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', second:'2-digit'})}`;
  } else {
    tsEl.textContent = '';
  }

  openModal('modal-set-detail');
}

document.getElementById('detail-save-btn').addEventListener('click', () => {
  if (!editingSetContext || !activeSession) return;
  const {exIdx, si} = editingSetContext;
  const set = activeSession.exercises[exIdx].sets[si];
  set.weight = parseFloat(document.getElementById('detail-weight').value) || 0;
  set.reps = parseInt(document.getElementById('detail-reps').value) || 0;
  set.rpe = parseFloat(document.getElementById('detail-rpe').value) || null;
  set.restSeconds = parseInt(document.getElementById('detail-rest').value) || null;
  set.notes = document.getElementById('detail-notes').value.trim();

  // Update inline inputs
  const wInput = document.querySelector(`input[data-ex="${exIdx}"][data-set="${si}"][data-field="weight"]`);
  const rInput = document.querySelector(`input[data-ex="${exIdx}"][data-set="${si}"][data-field="reps"]`);
  if (wInput) wInput.value = set.weight || '';
  if (rInput) rInput.value = set.reps || '';

  closeModal('modal-set-detail');
  showToast('Set updated');
});

// Session add exercise
document.getElementById('session-add-ex-btn').addEventListener('click', () => {
  pendingPickExerciseCallback = (variantId) => {
    if (!activeSession) return;
    activeSession.exercises.push({
      variantId,
      sets: [{weight:0, reps:8, completed:false, completedAt:null, rpe:null, restSeconds:null, notes:''},
             {weight:0, reps:8, completed:false, completedAt:null, rpe:null, restSeconds:null, notes:''},
             {weight:0, reps:8, completed:false, completedAt:null, rpe:null, restSeconds:null, notes:''}]
    });
    renderActiveSession();
    closeExercisePicker();
  };
  document.getElementById('pick-ex-title').textContent = 'Add Exercise';
  openExercisePicker();
});

// Session back
document.getElementById('session-back-btn').addEventListener('click', () => {
  // Minimize session - go back to home with banner
  document.getElementById('active-session').classList.remove('open');
  renderHome();
  renderActiveBanner();
});

// Notes toggle
document.getElementById('session-notes-toggle').addEventListener('click', () => {
  const wrap = document.getElementById('session-notes-wrap');
  wrap.classList.toggle('open');
  if (wrap.classList.contains('open')) {
    document.getElementById('session-notes-input').focus();
  }
});

function renderActiveBanner() {
  const banner = document.getElementById('active-banner');
  if (!activeSession) { banner.innerHTML = ''; return; }
  const elapsed = Math.floor((Date.now() - sessionStartEpoch) / 1000);
  const m = Math.floor(elapsed / 60);
  const completedSets = activeSession.exercises.reduce((a, ex) => a + ex.sets.filter(s=>s.completed).length, 0);
  banner.innerHTML = `<div class="session-bar" onclick="document.getElementById('active-session').classList.add('open')">
    <div>
      <div class="session-bar-title">${escHtml(activeSession.title)}</div>
      <div style="font-size:11px;font-family:var(--mono)">${completedSets} sets completed</div>
    </div>
    <div class="session-bar-time">${m}m • Resume →</div>
  </div>`;
}

// Finish session
document.getElementById('session-finish-btn').addEventListener('click', async () => {
  if (!activeSession) return;
  clearInterval(sessionTimerInterval);
  skipRestTimer();
  activeSession.endTime = Date.now();
  activeSession.durationMinutes = Math.round((activeSession.endTime - activeSession.startTime) / 60000);
  activeSession.notes = document.getElementById('session-notes-input').value.trim();

  await dbPut('sessions', activeSession);
  activeSession = null;
  document.getElementById('active-session').classList.remove('open');
  document.getElementById('active-banner').innerHTML = '';
  document.getElementById('session-notes-input').value = '';
  showToast('Workout saved!');
  renderHome();
});

// Session title edit
document.getElementById('session-title').addEventListener('click', () => {
  const newTitle = prompt('Workout name:', activeSession.title);
  if (newTitle?.trim()) {
    activeSession.title = newTitle.trim();
    document.getElementById('session-title').textContent = activeSession.title;
  }
});

// Show exercise detail from session
function showExerciseAnalyticsFromSession(variantId) {
  showExerciseAnalytics(variantId);
}

// ═══════════════════════════════════════════════════════════════
// VIEW WORKOUT DETAIL
// ═══════════════════════════════════════════════════════════════
async function viewWorkoutDetail(sessionId) {
  const session = await dbGet('sessions', sessionId);
  if (!session) return;

  // Look up bodyweight for that day
  const sessionDate = new Date(session.startTime).toISOString().split('T')[0];
  const bwEntry = await dbGet('bodyweight', sessionDate);
  const bwStr = bwEntry ? ` · ${bwEntry.weight_lbs} lbs` : '';

  const body = document.getElementById('ex-detail-body');
  const date = new Date(session.startTime).toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric', year:'numeric'});
  document.getElementById('ex-detail-name').textContent = session.title;
  document.getElementById('ex-detail-sub').textContent = `${date} · ${session.durationMinutes || '?'}m${bwStr}`;

  // Show repeat button
  repeatWorkoutSessionId = sessionId;
  document.getElementById('ex-detail-footer').style.display = '';

  const notesHtml = session.notes
    ? `<div style="padding:10px 16px 0;font-size:13px;color:var(--text2);font-style:italic;border-top:1px solid var(--border)">${escHtml(session.notes)}</div>`
    : '';

  const totalSets = session.exercises.reduce((n, ex) => n + ex.sets.filter(s => s.completed).length, 0);
  const totalVol = session.exercises.reduce((n, ex) =>
    n + ex.sets.filter(s => s.completed).reduce((v, s) => v + (s.weight||0)*(s.reps||0), 0), 0);

  body.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0;border-bottom:1px solid var(--border)">
      <div style="padding:12px 14px;border-right:1px solid var(--border)">
        <div style="font-size:10px;color:var(--text3);margin-bottom:2px">Exercises</div>
        <div style="font-family:var(--mono);font-size:18px;font-weight:600">${session.exercises.length}</div>
      </div>
      <div style="padding:12px 14px;border-right:1px solid var(--border)">
        <div style="font-size:10px;color:var(--text3);margin-bottom:2px">Sets</div>
        <div style="font-family:var(--mono);font-size:18px;font-weight:600">${totalSets}</div>
      </div>
      <div style="padding:12px 14px">
        <div style="font-size:10px;color:var(--text3);margin-bottom:2px">Volume</div>
        <div style="font-family:var(--mono);font-size:18px;font-weight:600">${totalVol > 0 ? Math.round(totalVol/1000)+'k' : '—'}</div>
      </div>
    </div>
    ${notesHtml}
    <div style="padding:12px 16px">
    ` + session.exercises.map(ex => {
    const name = getVariantDisplayName(ex.variantId);
    const sets = ex.sets.filter(s => s.completed);
    return `<div style="margin-bottom:14px">
      <div style="font-size:14px;font-weight:500;margin-bottom:6px">${escHtml(name)}</div>
      ${sets.map((s, i) => {
        const rpe = s.rpe ? ` <span style="color:var(--text3)">@${s.rpe}</span>` : '';
        const notes = s.notes ? `<div style="font-size:11px;color:var(--text3);margin-top:2px;padding-left:8px">${escHtml(s.notes)}</div>` : '';
        return `<div style="padding:4px 0;border-bottom:1px solid var(--border)">
          <div style="font-family:var(--mono);font-size:13px">${i+1}. ${s.weight} × ${s.reps}${rpe}</div>
          ${notes}
        </div>`;
      }).join('')}
      ${sets.length === 0 ? '<div style="font-size:12px;color:var(--text3)">No sets completed</div>' : ''}
    </div>`;
  }).join('') + `</div>`;

  openModal('modal-exercise-detail');
}

// ═══════════════════════════════════════════════════════════════
// EXERCISE ANALYTICS
// ═══════════════════════════════════════════════════════════════
async function showExerciseAnalytics(variantId) {
  const info = variantMap[variantId];
  if (!info) return;
  const parentName = info.parent.name;
  const variantName = info.variant.name;

  document.getElementById('ex-detail-name').textContent = parentName;
  document.getElementById('ex-detail-sub').textContent = variantName + ' · ' + info.parent.primary_muscles.join(', ');

  const sessions = await dbGetAll('sessions');
  // Collect all sets for this variant
  const allSets = [];
  sessions.forEach(s => {
    const ex = s.exercises.find(e => e.variantId === variantId);
    if (ex) {
      ex.sets.filter(st => st.completed && st.weight && st.reps).forEach(st => {
        allSets.push({...st, sessionDate: s.startTime, sessionTitle: s.title});
      });
    }
  });

  // Also include sets from active session
  if (activeSession) {
    const ex = activeSession.exercises.find(e => e.variantId === variantId);
    if (ex) ex.sets.filter(st => st.weight && st.reps).forEach(st => allSets.push({...st, sessionDate: Date.now(), sessionTitle: activeSession.title}));
  }

  const topRM = allSets.reduce((best, s) => Math.max(best, epley1RM(s.weight, s.reps)), 0);
  const maxWeight = allSets.reduce((best, s) => Math.max(best, s.weight), 0);

  // Rep-max table
  const repBuckets = [1,2,3,5,8,10,12,15];
  const repMaxes = repBuckets.map(rep => {
    const sets = allSets.filter(s => s.reps === rep);
    if (sets.length === 0) return {rep, weight: null, date: null};
    const best = sets.sort((a,b) => b.weight - a.weight)[0];
    return {rep, weight: best.weight, date: best.sessionDate};
  });

  // History (last 8 sessions with this exercise)
  const sessionMap = {};
  sessions.forEach(s => {
    const ex = s.exercises.find(e => e.variantId === variantId);
    if (ex && ex.sets.some(st => st.completed)) {
      sessionMap[s.id] = {date: s.startTime, sets: ex.sets.filter(st => st.completed)};
    }
  });
  const historyEntries = Object.values(sessionMap).sort((a,b) => b.date - a.date).slice(0, 8);

  // Max weight progression
  const progressByDate = {};
  sessions.forEach(s => {
    const ex = s.exercises.find(e => e.variantId === variantId);
    if (ex) {
      const maxW = Math.max(...ex.sets.filter(st => st.completed && st.weight).map(st => st.weight));
      if (maxW > 0) progressByDate[s.startTime] = maxW;
    }
  });
  const progressData = Object.entries(progressByDate).sort((a,b) => a[0]-b[0]).slice(-30);

  // Volume per session (sets * reps * weight)
  const volumeByDate = {};
  sessions.forEach(s => {
    const ex = s.exercises.find(e => e.variantId === variantId);
    if (ex) {
      const vol = ex.sets.filter(st => st.completed && st.weight && st.reps)
        .reduce((sum, st) => sum + st.weight * st.reps, 0);
      if (vol > 0) volumeByDate[s.startTime] = vol;
    }
  });
  const volumeData = Object.entries(volumeByDate).sort((a,b) => a[0]-b[0]).slice(-30);
  const totalSetCount = allSets.length;

  // Hide repeat button in analytics context
  document.getElementById('ex-detail-footer').style.display = 'none';

  const body = document.getElementById('ex-detail-body');
  body.innerHTML = `
    <div class="analytics-grid">
      <div class="analytics-card">
        <div class="analytics-label">Est. 1RM</div>
        <div class="analytics-value">${topRM > 0 ? Math.round(topRM) : '—'} <span class="analytics-unit">lbs</span></div>
      </div>
      <div class="analytics-card">
        <div class="analytics-label">Max Weight</div>
        <div class="analytics-value">${maxWeight > 0 ? maxWeight : '—'} <span class="analytics-unit">lbs</span></div>
      </div>
      <div class="analytics-card">
        <div class="analytics-label">Total Sets</div>
        <div class="analytics-value">${totalSetCount || '—'}</div>
      </div>
      <div class="analytics-card">
        <div class="analytics-label">Sessions</div>
        <div class="analytics-value">${historyEntries.length || '—'}</div>
      </div>
    </div>

    ${progressData.length >= 2 ? `
    <div class="analytics-card-wide">
      <div class="analytics-label" style="margin-bottom:8px">Max Weight Over Time</div>
      <div class="mini-chart">${renderSparkline(progressData.map(d => d[1]))}</div>
    </div>` : ''}

    ${volumeData.length >= 2 ? `
    <div class="analytics-card-wide">
      <div class="analytics-label" style="margin-bottom:8px">Volume Over Time (lbs)</div>
      <div class="mini-chart">${renderSparkline(volumeData.map(d => d[1]))}</div>
    </div>` : ''}

    <div class="analytics-card-wide" style="padding:14px 0">
      <div class="analytics-label" style="padding:0 14px;margin-bottom:6px">Rep Max Table</div>
      <table class="rep-max-table">
        <thead><tr><th>Reps</th><th>Best Weight</th><th>Date</th></tr></thead>
        <tbody>
          ${repMaxes.filter(r => r.weight).map(r => `
            <tr>
              <td>${r.rep} rep${r.rep > 1?'s':''}</td>
              <td>${r.weight} lbs</td>
              <td>${r.date ? new Date(r.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'2-digit'}) : ''}</td>
            </tr>`).join('')}
          ${repMaxes.every(r => !r.weight) ? '<tr><td colspan="3" style="color:var(--text3);text-align:center">No data yet</td></tr>' : ''}
        </tbody>
      </table>
    </div>

    <div class="analytics-card-wide" style="padding:14px 0">
      <div class="analytics-label" style="padding:0 14px;margin-bottom:6px">Recent History</div>
      ${historyEntries.length === 0 ? '<div style="padding:0 14px;font-size:13px;color:var(--text3)">No history yet</div>' :
      `<table class="history-table">
        <thead><tr><th>Date</th><th>Sets</th></tr></thead>
        <tbody>
          ${historyEntries.map(h => `
            <tr>
              <td>${new Date(h.date).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</td>
              <td><div class="sets-summary">${h.sets.map(s =>
                `<div class="set-line">${s.weight}×${s.reps}${s.rpe ? ` @${s.rpe}` : ''}</div>`
              ).join('')}</div></td>
            </tr>`).join('')}
        </tbody>
      </table>`}
    </div>
  `;

  openModal('modal-exercise-detail');
}

function renderSparkline(values) {
  if (values.length < 2) return '';
  const min = Math.min(...values);
  const max = Math.max(...values);
  const range = max - min || 1;
  const w = 100;
  const h = 70;
  const pad = 4;
  const points = values.map((v, i) => {
    const x = pad + (i / (values.length - 1)) * (w - pad*2);
    const y = h - pad - ((v - min) / range) * (h - pad*2);
    return `${x},${y}`;
  }).join(' ');

  return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
    <defs>
      <linearGradient id="sg" x1="0" x2="0" y1="0" y2="1">
        <stop offset="0%" stop-color="var(--accent)" stop-opacity="0.3"/>
        <stop offset="100%" stop-color="var(--accent)" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <polygon points="${points} ${w-pad},${h-pad} ${pad},${h-pad}" fill="url(#sg)"/>
    <polyline points="${points}" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    <circle cx="${points.split(' ').slice(-1)[0].split(',')[0]}" cy="${points.split(' ').slice(-1)[0].split(',')[1]}" r="3" fill="var(--accent)"/>
  </svg>`;
}

// ═══════════════════════════════════════════════════════════════
// TEMPLATES
// ═══════════════════════════════════════════════════════════════
let templateOrder = []; // ordered list of template IDs

async function renderTemplates() {
  const templates = await dbGetAll('templates');
  const list = document.getElementById('template-list');
  if (templates.length === 0) {
    list.innerHTML = `<div class="empty-state">
      <div class="empty-state-icon">📋</div>
      <div class="empty-state-title">No templates yet</div>
      <div class="empty-state-sub">Create templates to start workouts quickly</div>
    </div>`;
    return;
  }

  // Apply saved order, append any new templates at end
  const savedOrder = JSON.parse(localStorage.getItem('tmpl_order') || '[]');
  const orderedIds = [...savedOrder.filter(id => templates.find(t => t.id === id)),
                     ...templates.filter(t => !savedOrder.includes(t.id)).map(t => t.id)];
  templateOrder = orderedIds;
  const ordered = orderedIds.map(id => templates.find(t => t.id === id)).filter(Boolean);

  list.innerHTML = ordered.map((t, idx) => `
    <div class="template-card" data-tid="${t.id}" data-idx="${idx}">
      <div class="template-card-header">
        <div class="tmpl-drag-handle" title="Drag to reorder" style="cursor:grab;color:var(--text3);padding:4px 6px 4px 0;flex-shrink:0;touch-action:none">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="5" r="1" fill="currentColor"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="9" cy="19" r="1" fill="currentColor"/><circle cx="15" cy="5" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/><circle cx="15" cy="19" r="1" fill="currentColor"/></svg>
        </div>
        <div class="template-name">${escHtml(t.name)}</div>
        <button class="btn btn-ghost btn-sm btn-icon" onclick="openTemplateEditor('${t.id}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
      </div>
      <div class="template-exercises">
        ${t.exercises.slice(0,5).map(ex => `<div class="template-ex">${escHtml(getVariantDisplayName(ex.variantId))}</div>`).join('')}
        ${t.exercises.length > 5 ? `<div style="font-size:11px;color:var(--text3)">+${t.exercises.length-5} more</div>` : ''}
      </div>
      <div class="template-actions">
        <button class="btn btn-primary btn-sm" onclick="startFromTemplate('${t.id}')">Start Workout</button>
      </div>
    </div>`).join('');

  initTemplateDrag();
}

function saveTemplateOrder() {
  localStorage.setItem('tmpl_order', JSON.stringify(templateOrder));
}

function initTemplateDrag() {
  const list = document.getElementById('template-list');
  const cards = [...list.querySelectorAll('.template-card')];
  let dragging = null, startY = 0, startIdx = 0, origTranslate = 0;
  let cardHeights = [];
  let placeholder = null;

  function getIdx(el) { return parseInt(el.dataset.idx); }

  function onPointerDown(e) {
    const handle = e.target.closest('.tmpl-drag-handle');
    if (!handle) return;
    const card = e.target.closest('.template-card');
    if (!card) return;
    e.preventDefault();

    dragging = card;
    startY = e.clientY ?? e.touches?.[0]?.clientY;
    startIdx = getIdx(card);
    cardHeights = [...list.querySelectorAll('.template-card')].map(c => c.getBoundingClientRect().height + 10);

    // Create placeholder
    placeholder = document.createElement('div');
    placeholder.style.cssText = `height:${card.offsetHeight}px;background:var(--bg3);border:1px dashed var(--border2);border-radius:14px;flex-shrink:0`;
    card.after(placeholder);

    card.style.cssText += `;position:fixed;z-index:999;width:${card.offsetWidth}px;left:${card.getBoundingClientRect().left}px;top:${card.getBoundingClientRect().top}px;opacity:0.95;box-shadow:0 8px 30px rgba(0,0,0,0.4);pointer-events:none;transform:scale(1.02)`;
    origTranslate = card.getBoundingClientRect().top;

    document.addEventListener('pointermove', onPointerMove, {passive:false});
    document.addEventListener('pointerup', onPointerUp);
    document.addEventListener('touchmove', e=>e.preventDefault(), {passive:false,once:false});
  }

  function onPointerMove(e) {
    if (!dragging) return;
    e.preventDefault();
    const y = e.clientY ?? e.touches?.[0]?.clientY;
    const dy = y - startY;
    dragging.style.top = (origTranslate + dy) + 'px';

    // Find insertion point
    const siblings = [...list.querySelectorAll('.template-card')];
    const midY = dragging.getBoundingClientRect().top + dragging.offsetHeight / 2;

    for (const sib of siblings) {
      if (sib === dragging) continue;
      const rect = sib.getBoundingClientRect();
      if (midY < rect.top + rect.height / 2) {
        sib.before(placeholder);
        return;
      }
    }
    list.appendChild(placeholder);
  }

  function onPointerUp() {
    document.removeEventListener('pointermove', onPointerMove);
    document.removeEventListener('pointerup', onPointerUp);
    if (!dragging) return;

    // Restore card style
    dragging.style.cssText = dragging.style.cssText
      .replace(/position:fixed[^;]*;/g,'')
      .replace(/z-index:\d+;/g,'')
      .replace(/width:[^;]+;/g,'')
      .replace(/left:[^;]+;/g,'')
      .replace(/top:[^;]+;/g,'')
      .replace(/opacity:[^;]+;/g,'')
      .replace(/box-shadow:[^;]+;/g,'')
      .replace(/pointer-events:[^;]+;/g,'')
      .replace(/transform:[^;]+;/g,'');

    placeholder.replaceWith(dragging);
    placeholder = null;

    // Rebuild order from DOM
    const newOrder = [...list.querySelectorAll('.template-card')].map(c => c.dataset.tid);
    if (JSON.stringify(newOrder) !== JSON.stringify(templateOrder)) {
      templateOrder = newOrder;
      saveTemplateOrder();
    }

    dragging = null;
  }

  // Attach to handles
  list.querySelectorAll('.tmpl-drag-handle').forEach(h => {
    h.addEventListener('pointerdown', onPointerDown);
  });
}

document.getElementById('new-template-btn').addEventListener('click', () => openTemplateEditor(null));

async function openTemplateEditor(templateId) {
  editingTemplateId = templateId;
  const deleteBtn = document.getElementById('tmpl-delete-btn');

  if (templateId) {
    const tmpl = await dbGet('templates', templateId);
    if (!tmpl) return;
    document.getElementById('tmpl-editor-title').textContent = 'Edit Template';
    document.getElementById('tmpl-name-input').value = tmpl.name;
    deleteBtn.style.display = '';
    renderTemplateExercises(tmpl.exercises);
  } else {
    document.getElementById('tmpl-editor-title').textContent = 'New Template';
    document.getElementById('tmpl-name-input').value = '';
    deleteBtn.style.display = 'none';
    renderTemplateExercises([]);
  }
  openModal('modal-template-editor');
}

let tmplExercises = [];
function renderTemplateExercises(exercises) {
  tmplExercises = exercises ? [...exercises] : [];
  const list = document.getElementById('tmpl-exercises-list');
  const n = tmplExercises.length;
  list.innerHTML = tmplExercises.map((ex, i) => `
    <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--bg3);border-radius:var(--r);border:1px solid var(--border)">
      <div style="display:flex;flex-direction:column;gap:2px;flex-shrink:0">
        <button class="reorder-btn" onclick="moveTmplEx(${i},-1)" ${i===0?'disabled style="opacity:0.3"':''}>
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="18 15 12 9 6 15"/></svg>
        </button>
        <button class="reorder-btn" onclick="moveTmplEx(${i},1)" ${i===n-1?'disabled style="opacity:0.3"':''}>
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
      </div>
      <div style="flex:1;font-size:13px">${escHtml(getVariantDisplayName(ex.variantId))}</div>
      <div style="font-family:var(--mono);font-size:11px;color:var(--text3)">${(ex.defaultSets||[]).length} sets</div>
      <button class="btn btn-ghost btn-sm btn-icon" onclick="removeTemplateEx(${i})">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>`).join('');
}

function moveTmplEx(i, dir) {
  const j = i + dir;
  if (j < 0 || j >= tmplExercises.length) return;
  [tmplExercises[i], tmplExercises[j]] = [tmplExercises[j], tmplExercises[i]];
  renderTemplateExercises(tmplExercises);
}

function removeTemplateEx(i) {
  tmplExercises.splice(i, 1);
  renderTemplateExercises(tmplExercises);
}

document.getElementById('tmpl-add-ex-btn').addEventListener('click', () => {
  pendingPickExerciseCallback = (variantId) => {
    tmplExercises.push({variantId, defaultSets: [{weight:0,reps:8},{weight:0,reps:8},{weight:0,reps:8}]});
    renderTemplateExercises(tmplExercises);
    closeExercisePicker();
  };
  document.getElementById('pick-ex-title').textContent = 'Add to Template';
  openExercisePicker();
});

document.getElementById('tmpl-save-btn').addEventListener('click', async () => {
  const name = document.getElementById('tmpl-name-input').value.trim();
  if (!name) { showToast('Enter a template name'); return; }
  const tmpl = {
    id: editingTemplateId || uid(),
    name,
    exercises: tmplExercises
  };
  await dbPut('templates', tmpl);
  closeModal('modal-template-editor');
  showToast('Template saved');
  renderTemplates();
});

document.getElementById('tmpl-delete-btn').addEventListener('click', async () => {
  if (!editingTemplateId) return;
  if (!confirm('Delete this template?')) return;
  await dbDelete('templates', editingTemplateId);
  closeModal('modal-template-editor');
  showToast('Template deleted');
  renderTemplates();
});

// ═══════════════════════════════════════════════════════════════
// EXERCISE PICKER MODAL
// ═══════════════════════════════════════════════════════════════
let pickerMuscleFilter = '';

function openExercisePicker() {
  pickerMuscleFilter = '';
  pickerState = { step: 'lift', liftId: null, resistance: null, variant: null, mods: {bands:false,unilateral:false,other:''}, customName: '' };
  document.getElementById('pick-ex-search').value = '';
  document.getElementById('pick-ex-search').style.display = '';
  document.getElementById('pick-ex-filters').style.display = '';
  document.getElementById('pick-ex-steps').style.display = 'none';
  document.getElementById('pick-ex-back').style.display = 'none';
  document.getElementById('pick-ex-footer').style.display = 'none';
  renderPickerFilters();
  renderPickerStep();
  const overlay = document.getElementById('modal-pick-exercise');
  overlay.classList.add('open', 'elevated');
  document.getElementById('modal-backdrop').classList.add('show');
}

function closeExercisePicker() {
  const overlay = document.getElementById('modal-pick-exercise');
  overlay.classList.remove('open', 'elevated');
  const anyOpen = document.querySelector('.modal-overlay.open');
  if (!anyOpen) document.getElementById('modal-backdrop').classList.remove('show');
}

let pickerState = { step: 'lift', liftId: null, resistance: null, variant: null, mods: {bands:false,unilateral:false,other:''}, customName: '' };

function renderPickerFilters() {
  const container = document.getElementById('pick-ex-filters');
  const muscles = ['all', ...EXERCISE_LIBRARY.muscle_groups];
  container.innerHTML = muscles.map(m => `
    <button class="filter-pill ${pickerMuscleFilter === (m==='all'?'':m) ? 'active' : ''}"
      onclick="setPickerMuscle('${m === 'all' ? '' : m}')">
      ${m === 'all' ? 'All' : m}
    </button>`).join('');
}

function setPickerMuscle(m) {
  pickerMuscleFilter = m;
  renderPickerFilters();
  renderPickerStep();
}

document.getElementById('pick-ex-search').addEventListener('input', e => {
  renderPickerStep();
});

function renderPickerStep() {
  const step = pickerState.step;
  const list = document.getElementById('pick-ex-list');
  const stepsEl = document.getElementById('pick-ex-steps');
  const backBtn = document.getElementById('pick-ex-back');
  const searchEl = document.getElementById('pick-ex-search');
  const filtersEl = document.getElementById('pick-ex-filters');
  const footerEl = document.getElementById('pick-ex-footer');

  if (step === 'lift') {
    // Step 1: Pick a main lift
    stepsEl.style.display = 'none';
    backBtn.style.display = 'none';
    searchEl.style.display = '';
    filtersEl.style.display = '';
    footerEl.style.display = 'none';
    renderPickerLiftList();
  } else {
    searchEl.style.display = 'none';
    filtersEl.style.display = 'none';
    stepsEl.style.display = 'flex';
    backBtn.style.display = '';
    renderStepIndicator();

    if (step === 'resistance') renderPickerResistance();
    else if (step === 'variant') renderPickerVariant();
    else if (step === 'modifiers') renderPickerModifiers();
  }
}

function renderStepIndicator() {
  const el = document.getElementById('pick-ex-steps');
  const h = hierarchyMap[pickerState.liftId];
  if (!h) return;
  const hasVariants = h.variants.length > 0;
  const steps = [
    { label: h.name, key: 'lift' },
    { label: 'Type', key: 'resistance' },
  ];
  if (hasVariants) steps.push({ label: 'Variant', key: 'variant' });
  steps.push({ label: 'Modifiers', key: 'modifiers' });

  const currentIdx = steps.findIndex(s => s.key === pickerState.step);
  el.innerHTML = steps.map((s, i) => {
    const cls = i < currentIdx ? 'done' : (i === currentIdx ? 'active' : '');
    const arrow = i > 0 ? '<span class="picker-step-arrow">›</span>' : '';
    return `${arrow}<div class="picker-step ${cls}">
      <span class="picker-step-num">${i < currentIdx ? '✓' : i+1}</span>
      <span>${escHtml(s.label)}</span>
    </div>`;
  }).join('');
}

function renderPickerLiftList() {
  const q = (document.getElementById('pick-ex-search').value || '').toLowerCase().trim();
  const list = document.getElementById('pick-ex-list');

  // Group lifts by movement pattern
  const groups = {};
  const patternOrder = ['push','pull','squat','hinge','isolation','core','carry'];

  EXERCISE_HIERARCHY.forEach(h => {
    if (pickerMuscleFilter) {
      if (!h.muscles.includes(pickerMuscleFilter) && !(h.sec||[]).includes(pickerMuscleFilter)) return;
    }
    if (q && !h.name.toLowerCase().includes(q)) return;
    const pat = h.pattern;
    if (!groups[pat]) groups[pat] = [];
    groups[pat].push(h);
  });

  if (Object.keys(groups).length === 0) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3)">No exercises found</div>';
    return;
  }

  let html = '';
  patternOrder.forEach(pat => {
    if (!groups[pat]) return;
    html += `<div class="picker-section-label">${pat}</div>`;
    groups[pat].forEach(h => {
      const muscleTags = h.muscles.map(m => `<span class="tag tag-muscle">${m}</span>`).join('');
      const resTags = h.resistances.map(r => `<span class="tag tag-equipment">${RES_ABBREV[r]||r}</span>`).join(' ');
      html += `<div class="variant-row" onclick="pickerSelectLift('${h.id}')">
        <div class="variant-row-left">
          <div class="variant-name">${escHtml(h.name)}</div>
          <div class="variant-equip-tags">${muscleTags} ${resTags}</div>
        </div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
      </div>`;
    });
  });
  list.innerHTML = html;
}

function pickerSelectLift(liftId) {
  const h = hierarchyMap[liftId];
  if (!h) return;
  pickerState.liftId = liftId;
  pickerState.resistance = null;
  pickerState.variant = null;
  pickerState.mods = {bands:false,unilateral:false,other:''};
  pickerState.customName = '';

  if (h.resistances.length === 1) {
    // Auto-select single resistance
    pickerState.resistance = h.resistances[0];
    if (h.variants.length > 0) {
      pickerState.step = 'variant';
    } else {
      pickerState.step = 'modifiers';
    }
  } else {
    pickerState.step = 'resistance';
  }
  renderPickerStep();
}

function renderPickerResistance() {
  const h = hierarchyMap[pickerState.liftId];
  if (!h) return;
  const list = document.getElementById('pick-ex-list');

  list.innerHTML = `<div class="picker-section-label">Select Resistance Type</div>
    <div class="picker-grid">${h.resistances.map(r => `
      <div class="picker-option" onclick="pickerSelectResistance('${r}')">
        <div class="picker-option-name">${escHtml(r)}</div>
        <div class="picker-option-sub">${RES_ABBREV[r] || r}</div>
      </div>`).join('')}
    </div>`;
}

function pickerSelectResistance(r) {
  pickerState.resistance = r;
  const h = hierarchyMap[pickerState.liftId];
  if (h && h.variants.length > 0) {
    pickerState.step = 'variant';
  } else {
    pickerState.step = 'modifiers';
  }
  renderPickerStep();
}

function renderPickerVariant() {
  const h = hierarchyMap[pickerState.liftId];
  if (!h) return;
  const list = document.getElementById('pick-ex-list');

  list.innerHTML = `<div class="picker-section-label">Select Variant</div>
    <div class="picker-grid">${h.variants.map(v => `
      <div class="picker-option" onclick="pickerSelectVariant('${v}')">
        <div class="picker-option-name">${escHtml(v)}</div>
      </div>`).join('')}
    </div>`;
}

function pickerSelectVariant(v) {
  pickerState.variant = v;
  pickerState.step = 'modifiers';
  renderPickerStep();
}

function renderPickerModifiers() {
  const h = hierarchyMap[pickerState.liftId];
  if (!h) return;
  const list = document.getElementById('pick-ex-list');
  const footerEl = document.getElementById('pick-ex-footer');
  footerEl.style.display = '';

  // Build preview name
  const abbrev = RES_ABBREV[pickerState.resistance] || pickerState.resistance;
  const previewName = buildExerciseName(h.name, abbrev, pickerState.variant || '', pickerState.mods);

  let modsHtml = '<div class="picker-section-label">Modifiers (optional)</div>';

  if (h.mods.bands) {
    modsHtml += `<div class="picker-modifier-row ${pickerState.mods.bands ? 'active' : ''}" onclick="pickerToggleMod('bands')">
      <div class="picker-modifier-check">${pickerState.mods.bands ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}</div>
      <div class="picker-modifier-label">Bands</div>
    </div>`;
  }
  if (h.mods.unilateral) {
    modsHtml += `<div class="picker-modifier-row ${pickerState.mods.unilateral ? 'active' : ''}" onclick="pickerToggleMod('unilateral')">
      <div class="picker-modifier-check">${pickerState.mods.unilateral ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}</div>
      <div class="picker-modifier-label">Unilateral</div>
    </div>`;
  }
  if (h.mods.other) {
    modsHtml += `<div style="margin-top:6px">
      <div class="input-label" style="margin-bottom:4px">Other</div>
      <input id="picker-other-input" type="text" placeholder="e.g. Close Grip, Pause, Machine…" value="${escHtml(pickerState.mods.other)}" oninput="pickerState.mods.other=this.value;updatePickerPreview()">
    </div>`;
  }

  modsHtml += `<div class="picker-preview" id="picker-preview">
    <div class="picker-preview-label">Exercise name</div>
    <div class="picker-preview-name" id="picker-preview-name">${escHtml(previewName)}</div>
    <input class="picker-name-edit" id="picker-custom-name" type="text"
      placeholder="${escHtml(previewName)}" value="${escHtml(pickerState.customName)}"
      oninput="pickerState.customName=this.value">
    <div style="font-size:11px;color:var(--text3);margin-top:4px">Leave blank to use auto-generated name</div>
  </div>`;

  list.innerHTML = modsHtml;
}

function pickerToggleMod(mod) {
  pickerState.mods[mod] = !pickerState.mods[mod];
  renderPickerModifiers();
}

function updatePickerPreview() {
  const h = hierarchyMap[pickerState.liftId];
  if (!h) return;
  const abbrev = RES_ABBREV[pickerState.resistance] || pickerState.resistance;
  const name = buildExerciseName(h.name, abbrev, pickerState.variant || '', pickerState.mods);
  const el = document.getElementById('picker-preview-name');
  if (el) el.textContent = name;
  const input = document.getElementById('picker-custom-name');
  if (input) input.placeholder = name;
}

function pickerGoBack() {
  const h = hierarchyMap[pickerState.liftId];
  if (!h) { pickerState.step = 'lift'; renderPickerStep(); return; }
  const hasVariants = h.variants.length > 0;
  const hasMultiRes = h.resistances.length > 1;

  if (pickerState.step === 'modifiers') {
    if (hasVariants) pickerState.step = 'variant';
    else if (hasMultiRes) pickerState.step = 'resistance';
    else pickerState.step = 'lift';
  } else if (pickerState.step === 'variant') {
    if (hasMultiRes) pickerState.step = 'resistance';
    else pickerState.step = 'lift';
  } else if (pickerState.step === 'resistance') {
    pickerState.step = 'lift';
  } else {
    pickerState.step = 'lift';
  }
  renderPickerStep();
}

// Confirm selection
document.getElementById('pick-ex-confirm').addEventListener('click', () => {
  if (!pickerState.liftId || !pickerState.resistance) return;
  const h = hierarchyMap[pickerState.liftId];
  if (!h) return;
  if (h.variants.length > 0 && !pickerState.variant) return;

  // Resolve to a variant ID (prefer legacy if exists)
  const variantId = resolveVariantId(pickerState.liftId, pickerState.resistance, pickerState.variant || '', pickerState.mods);

  // Check if this variant exists in variantMap, if not create it
  if (!variantMap[variantId]) {
    const abbrev = RES_ABBREV[pickerState.resistance] || pickerState.resistance;
    const displayName = pickerState.customName.trim() || buildExerciseName(h.name, abbrev, pickerState.variant || '', pickerState.mods);
    
    // Find or create parent in old library
    let parent = parentMap[pickerState.liftId] || parentMap['hierarchy_' + pickerState.liftId];
    if (!parent) {
      parent = {
        id: 'hierarchy_' + pickerState.liftId,
        name: h.name,
        primary_muscles: h.muscles,
        secondary_muscles: h.sec || [],
        movement_pattern: h.pattern,
        variants: []
      };
      EXERCISE_LIBRARY.parents.push(parent);
      parentMap[parent.id] = parent;
    }

    const newVariant = { id: variantId, name: displayName, equipment: [pickerState.resistance.toLowerCase().replace(/[^a-z0-9+]/g,'_')] };
    parent.variants.push(newVariant);
    variantMap[variantId] = { variant: newVariant, parent };

    // Persist
    dbPut('custom_variants', { id: variantId, parentId: parent.id, name: displayName, equipment: newVariant.equipment });
  } else if (pickerState.customName.trim()) {
    // User provided custom name, save as override
    const info = variantMap[variantId];
    if (info) {
      info.variant.name = pickerState.customName.trim();
      dbPut('variant_overrides', { id: variantId, name: pickerState.customName.trim(), equipment: info.variant.equipment });
    }
  }

  if (pendingPickExerciseCallback) {
    pendingPickExerciseCallback(variantId);
    pendingPickExerciseCallback = null;
  }
});

function pickExercise(variantId) {
  if (pendingPickExerciseCallback) {
    pendingPickExerciseCallback(variantId);
    pendingPickExerciseCallback = null;
  }
}

// ═══════════════════════════════════════════════════════════════
// LIBRARY SCREEN
// ═══════════════════════════════════════════════════════════════
let libMuscleFilter = '';
let libEquipFilter = '';

function renderLibrary() {
  const countEl = document.getElementById('lib-count-sub');
  const total = EXERCISE_LIBRARY.parents.reduce((a, p) => a + p.variants.length, 0);
  countEl.textContent = `${total} variants · ${EXERCISE_LIBRARY.parents.length} movements`;

  // Build filter pills
  const filtersEl = document.getElementById('lib-filters');
  const muscles = ['all', ...EXERCISE_LIBRARY.muscle_groups];
  filtersEl.innerHTML = muscles.map(m => `
    <button class="filter-pill ${libMuscleFilter === (m==='all'?'':m) ? 'active' : ''}"
      onclick="setLibMuscle('${m === 'all' ? '' : m}')">
      ${m}
    </button>`).join('');

  // Equipment dropdown
  const equipSel = document.getElementById('lib-equip-filter');
  const currentEquipVal = equipSel.value;
  equipSel.innerHTML = '<option value="">All Equipment</option>';
  EXERCISE_LIBRARY.equipment_types.forEach(e => {
    const opt = document.createElement('option');
    opt.value = e; opt.textContent = e;
    equipSel.appendChild(opt);
  });
  if (currentEquipVal) equipSel.value = currentEquipVal;
  const muscleSel = document.getElementById('lib-muscle-filter');
  if (muscleSel.options.length <= 1) {
    EXERCISE_LIBRARY.muscle_groups.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m;
      muscleSel.appendChild(opt);
    });
  }

  renderLibraryList(document.getElementById('lib-search').value);
}

function setLibMuscle(m) {
  libMuscleFilter = m;
  renderLibrary();
}

document.getElementById('lib-search').addEventListener('input', e => renderLibraryList(e.target.value));
document.getElementById('lib-equip-filter').addEventListener('change', e => { libEquipFilter = e.target.value; renderLibraryList(document.getElementById('lib-search').value); });
document.getElementById('lib-muscle-filter').addEventListener('change', e => { libMuscleFilter = e.target.value; renderLibrary(); });

function renderLibraryList(query) {
  const q = query.toLowerCase().trim();
  const list = document.getElementById('library-list');
  let html = '';

  EXERCISE_LIBRARY.parents.forEach(parent => {
    const muscleMatch = !libMuscleFilter || parent.primary_muscles.includes(libMuscleFilter) || parent.secondary_muscles.includes(libMuscleFilter);
    if (!muscleMatch) return;

    const variants = parent.variants.filter(v => {
      if (libEquipFilter && !v.equipment.includes(libEquipFilter)) return false;
      if (q) {
        const name = `${parent.name} ${v.name}`.toLowerCase();
        if (!name.includes(q)) return false;
      }
      return true;
    });
    if (variants.length === 0) return;

    const muscleTags = [...parent.primary_muscles].map(m => `<span class="tag tag-muscle">${m}</span>`).join('');
    html += `<div class="parent-group">
      <div class="parent-label">
        <span>${escHtml(parent.name)}</span>
        <span class="count">${variants.length}v</span>
        <div class="muscle-tags">${muscleTags}</div>
      </div>
      ${variants.map(v => `
        <div class="variant-row" style="cursor:default">
          <div class="variant-row-left" style="cursor:pointer;flex:1" onclick="showExerciseAnalytics('${v.id}')">
            <div class="variant-name">${escHtml(v.name)}</div>
            <div class="variant-equip-tags">${v.equipment.map(e => `<span class="tag tag-equipment">${e}</span>`).join('')}</div>
          </div>
          <button class="btn btn-ghost btn-sm btn-icon" onclick="openVariantEditor('${parent.id}','${v.id}')" title="Edit" style="flex-shrink:0;margin-left:4px">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </button>
        </div>`).join('')}
      <button class="btn btn-ghost btn-sm" onclick="openNewVariantModal('${parent.id}')" style="width:100%;margin-top:4px;margin-bottom:6px;border-style:dashed;color:var(--text3)">+ Add Variant</button>
    </div>`;
  });

  list.innerHTML = html || `<div class="empty-state"><div class="empty-state-title">No results</div></div>`;
}

// ═══════════════════════════════════════════════════════════════
// PROGRESS SCREEN
// ═══════════════════════════════════════════════════════════════
let bwPeriod = '3m';

async function renderProgress() {
  await renderBWChart();
  await renderTopLifts();
}

const BW_PERIODS = {'1m':30,'3m':90,'6m':180,'1y':365,'all':99999};

async function renderBWChart() {
  const entries = await dbGetAll('bodyweight');
  entries.sort((a,b) => a.date.localeCompare(b.date));

  const cutoff = Date.now() - BW_PERIODS[bwPeriod] * 86400000;
  const filtered = entries.filter(e => new Date(e.date).getTime() >= cutoff);
  const display = filtered.length > 0 ? filtered : entries.slice(-30);

  // Stats
  const statsRow = document.getElementById('bw-stats-row');
  if (display.length > 0) {
    const latest = display[display.length - 1];
    const oldest = display[0];
    const change = latest.weight_lbs - oldest.weight_lbs;
    const changeStr = (change >= 0 ? '+' : '') + change.toFixed(1);
    const changeColor = change <= 0 ? 'var(--green)' : 'var(--red)';
    statsRow.innerHTML = `
      <div>
        <div style="font-size:10px;color:var(--text3)">Current</div>
        <div style="font-family:var(--display);font-size:22px;font-weight:600">${latest.weight_lbs} <span style="font-size:13px;font-weight:400;color:var(--text2)">lbs</span></div>
      </div>
      <div>
        <div style="font-size:10px;color:var(--text3)">Change</div>
        <div style="font-family:var(--display);font-size:22px;font-weight:600;color:${changeColor}">${changeStr}</div>
      </div>`;
  } else {
    statsRow.innerHTML = `<div style="color:var(--text3);font-size:13px">No data</div>`;
  }

  // Period pills
  const pillsEl = document.getElementById('bw-period-pills');
  pillsEl.innerHTML = Object.keys(BW_PERIODS).map(p => `
    <button class="period-pill ${bwPeriod === p ? 'active' : ''}" onclick="setBWPeriod('${p}')">${p}</button>`).join('');

  // Chart
  renderBWSVG(display);
}

function setBWPeriod(p) {
  bwPeriod = p;
  renderBWChart();
}

function renderBWSVG(data) {
  const svg = document.getElementById('bw-svg');
  if (!data.length) { svg.innerHTML = ''; return; }

  const W = svg.parentElement.clientWidth || 300;
  const H = 160;
  const pad = {top: 10, right: 10, bottom: 20, left: 35};
  const iW = W - pad.left - pad.right;
  const iH = H - pad.top - pad.bottom;

  const weights = data.map(d => d.weight_lbs);
  const minW = Math.min(...weights) - 2;
  const maxW = Math.max(...weights) + 2;

  const toX = i => pad.left + (i / (data.length - 1)) * iW;
  const toY = w => pad.top + iH - ((w - minW) / (maxW - minW)) * iH;

  const linePoints = data.map((d, i) => `${toX(i)},${toY(d.weight_lbs)}`).join(' ');
  const areaPoints = `${pad.left},${pad.top + iH} ${linePoints} ${pad.left + iW},${pad.top + iH}`;

  // Y axis labels
  const ySteps = 4;
  const yLabels = Array.from({length: ySteps+1}, (_, i) => {
    const val = minW + (i/ySteps) * (maxW - minW);
    const y = toY(val);
    return `<text x="${pad.left - 4}" y="${y + 4}" text-anchor="end" fill="var(--text3)" font-size="9" font-family="DM Mono, monospace">${Math.round(val)}</text>`;
  }).join('');

  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  svg.innerHTML = `
    <defs>
      <linearGradient id="bwg" x1="0" x2="0" y1="0" y2="1">
        <stop offset="0%" stop-color="var(--accent)" stop-opacity="0.25"/>
        <stop offset="100%" stop-color="var(--accent)" stop-opacity="0"/>
      </linearGradient>
    </defs>
    ${yLabels}
    <line x1="${pad.left}" y1="${pad.top}" x2="${pad.left}" y2="${pad.top + iH}" stroke="var(--border)" stroke-width="1"/>
    <polygon points="${areaPoints}" fill="url(#bwg)"/>
    <polyline points="${linePoints}" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    <circle cx="${toX(data.length-1)}" cy="${toY(data[data.length-1].weight_lbs)}" r="4" fill="var(--accent)"/>
  `;
}

async function renderTopLifts() {
  const sessions = await dbGetAll('sessions');
  const best1RM = {};

  sessions.forEach(s => {
    s.exercises.forEach(ex => {
      ex.sets.filter(st => st.completed && st.weight && st.reps).forEach(st => {
        const rm = st.weight * (1 + st.reps / 30);
        if (!best1RM[ex.variantId] || rm > best1RM[ex.variantId].rm) {
          best1RM[ex.variantId] = {rm, weight: st.weight, reps: st.reps, date: s.startTime};
        }
      });
    });
  });

  const sorted = Object.entries(best1RM)
    .sort((a,b) => b[1].rm - a[1].rm)
    .slice(0, 12);

  const list = document.getElementById('top-lifts-list');
  if (sorted.length === 0) {
    list.innerHTML = `<div style="color:var(--text3);font-size:13px;text-align:center;padding:20px 0">Log workouts to see your top lifts</div>`;
    return;
  }

  list.innerHTML = sorted.map(([variantId, data]) => {
    const name = getVariantDisplayName(variantId);
    const date = new Date(data.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'2-digit'});
    return `<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);padding:12px 14px;cursor:pointer;display:flex;align-items:center;gap:12px" onclick="showExerciseAnalytics('${variantId}')">
      <div style="flex:1">
        <div style="font-size:13px;font-weight:600">${escHtml(name)}</div>
        <div style="font-family:var(--mono);font-size:11px;color:var(--text3)">${data.weight}×${data.reps} · ${date}</div>
      </div>
      <div style="text-align:right">
        <div style="font-family:var(--display);font-size:20px;font-weight:600;color:var(--accent)">${Math.round(data.rm)}</div>
        <div style="font-family:var(--mono);font-size:9px;color:var(--text3)">EST 1RM</div>
      </div>
    </div>`;
  }).join('');
}

// Log BW button
document.getElementById('bw-stats-row').addEventListener('click', () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('bw-date-input').value = today;
  document.getElementById('bw-weight-input').value = '';
  openModal('modal-bw-entry');
});

document.getElementById('bw-save-btn').addEventListener('click', async () => {
  const date = document.getElementById('bw-date-input').value;
  const weight = parseFloat(document.getElementById('bw-weight-input').value);
  if (!date || !weight) { showToast('Enter date and weight'); return; }
  await dbPut('bodyweight', {date, weight_lbs: weight});
  closeModal('modal-bw-entry');
  showToast('Weight logged');
  renderBWChart();
});

// Add BW button
const bwBtn = document.createElement('button');
bwBtn.className = 'btn btn-secondary btn-sm';
bwBtn.textContent = '+ Log Weight';
bwBtn.style.cssText = 'position:absolute;top:16px;right:16px';
bwBtn.addEventListener('click', () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('bw-date-input').value = today;
  document.getElementById('bw-weight-input').value = '';
  openModal('modal-bw-entry');
});
document.querySelector('.bw-chart-wrap').style.position = 'relative';
document.querySelector('.bw-chart-wrap').appendChild(bwBtn);

// ═══════════════════════════════════════════════════════════════
// SEED DATA
// ═══════════════════════════════════════════════════════════════
async function seedBWData() {
  const existing = await dbGetAll('bodyweight');
  if (existing.length > 0) return; // already seeded

  // Show loading toast
  showToast('Importing 8 years of bodyweight data…');

  // Fetch BW data
  const bwData = await fetch('bw_data.json').then(r => r.json()).catch(() => null);
  if (bwData && Array.isArray(bwData)) {
    const tx = db.transaction('bodyweight', 'readwrite');
    const store = tx.objectStore('bodyweight');
    bwData.forEach(entry => store.put(entry));
    await new Promise(res => { tx.oncomplete = res; });
    showToast(`Imported ${bwData.length} bodyweight entries`);
  }
}

async function seedDefaultTemplates() {
  const existing = await dbGetAll('templates');
  if (existing.length > 0) return;

  const templates = [
    {
      id: uid(),
      name: 'Push',
      exercises: [
        {variantId: 'bench_barbell_flat', defaultSets: [{weight:225,reps:5},{weight:225,reps:5},{weight:225,reps:5},{weight:225,reps:5},{weight:225,reps:5}]},
        {variantId: 'ohp_landmine_standing', defaultSets: [{weight:90,reps:10},{weight:90,reps:10},{weight:90,reps:10}]},
        {variantId: 'dip_chest_weighted', defaultSets: [{weight:45,reps:10},{weight:45,reps:10},{weight:45,reps:10}]},
        {variantId: 'lat_raise_dumbbell', defaultSets: [{weight:25,reps:15},{weight:25,reps:15},{weight:25,reps:15},{weight:25,reps:15}]},
        {variantId: 'tri_push_cable_rope', defaultSets: [{weight:50,reps:12},{weight:50,reps:12},{weight:50,reps:12}]},
      ]
    },
    {
      id: uid(),
      name: 'Pull',
      exercises: [
        {variantId: 'pulldown_cable_close', defaultSets: [{weight:125,reps:12},{weight:160,reps:12},{weight:160,reps:12},{weight:160,reps:12}]},
        {variantId: 'row_barbell_bent_over', defaultSets: [{weight:185,reps:8},{weight:185,reps:8},{weight:185,reps:8},{weight:185,reps:8}]},
        {variantId: 'pullup_weighted', defaultSets: [{weight:25,reps:8},{weight:25,reps:8},{weight:25,reps:8}]},
        {variantId: 'face_pull_cable', defaultSets: [{weight:40,reps:15},{weight:40,reps:15},{weight:40,reps:15}]},
        {variantId: 'curl_dumbbell', defaultSets: [{weight:40,reps:12},{weight:40,reps:12},{weight:40,reps:12}]},
      ]
    },
    {
      id: uid(),
      name: 'Legs',
      exercises: [
        {variantId: 'squat_barbell_back', defaultSets: [{weight:225,reps:8},{weight:275,reps:5},{weight:315,reps:3},{weight:315,reps:3},{weight:315,reps:3}]},
        {variantId: 'rdl_barbell', defaultSets: [{weight:225,reps:8},{weight:225,reps:8},{weight:225,reps:8}]},
        {variantId: 'leg_press_machine', defaultSets: [{weight:270,reps:12},{weight:270,reps:12},{weight:270,reps:12}]},
        {variantId: 'leg_ext_plate_loaded', defaultSets: [{weight:90,reps:15},{weight:90,reps:15},{weight:90,reps:15}]},
        {variantId: 'calf_landmine', defaultSets: [{weight:90,reps:15},{weight:90,reps:15},{weight:90,reps:15}]},
      ]
    },
    {
      id: uid(),
      name: 'Full Body',
      exercises: [
        {variantId: 'squat_barbell_back', defaultSets: [{weight:225,reps:5},{weight:275,reps:5},{weight:275,reps:5}]},
        {variantId: 'bench_barbell_flat', defaultSets: [{weight:185,reps:8},{weight:185,reps:8},{weight:185,reps:8}]},
        {variantId: 'pullup_weighted', defaultSets: [{weight:25,reps:8},{weight:25,reps:8},{weight:25,reps:8}]},
        {variantId: 'rdl_barbell', defaultSets: [{weight:185,reps:10},{weight:185,reps:10},{weight:185,reps:10}]},
        {variantId: 'ohp_landmine_standing', defaultSets: [{weight:80,reps:10},{weight:80,reps:10},{weight:80,reps:10}]},
        {variantId: 'crunch_cable', defaultSets: [{weight:70,reps:15},{weight:70,reps:15},{weight:70,reps:15}]},
      ]
    }
  ];

  for (const t of templates) await dbPut('templates', t);
}

// ═══════════════════════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════════════════════
function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ═══════════════════════════════════════════════════════════════
// MOBILITY CHECKLIST
// ═══════════════════════════════════════════════════════════════
let mobilityExercises = []; // persisted in IDB store 'mobility_exercises'
let mobilityChecks = {}; // {exerciseId: bool} — reset daily, stored in 'mobility_checks'

function todayStr() { return new Date().toISOString().split('T')[0]; }

async function loadMobility() {
  const exList = await dbGetAll('mobility_exercises');
  mobilityExercises = exList.sort((a,b) => (a.order||0) - (b.order||0));
  const checkData = await dbGet('mobility_checks', todayStr());
  mobilityChecks = checkData ? checkData.checks : {};
}

async function saveMobilityChecks() {
  await dbPut('mobility_checks', {date: todayStr(), checks: mobilityChecks});
}

async function renderMobility() {
  await loadMobility();
  const subEl = document.getElementById('mobility-date-sub');
  const today = new Date();
  subEl.textContent = today.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric'});

  const list = document.getElementById('mobility-list');
  const completedCount = mobilityExercises.filter(ex => mobilityChecks[ex.id]).length;

  if (mobilityExercises.length === 0) {
    list.innerHTML = `<div class="empty-state">
      <div class="empty-state-icon" style="font-size:36px">🧘</div>
      <div class="empty-state-title">No Mobility Exercises</div>
      <div class="empty-state-sub">Tap + Add to build your daily mobility checklist</div>
    </div>`;
    return;
  }

  const allDone = completedCount === mobilityExercises.length;
  list.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 0 10px">
      <div style="font-family:var(--mono);font-size:12px;color:var(--text3)">${completedCount}/${mobilityExercises.length} complete</div>
      ${allDone ? `<div style="font-size:12px;color:var(--accent);font-weight:600">✓ All done!</div>` : ''}
    </div>
    <div style="height:4px;background:var(--bg3);border-radius:99px;margin-bottom:14px;overflow:hidden">
      <div style="height:100%;width:${mobilityExercises.length ? (completedCount/mobilityExercises.length*100) : 0}%;background:var(--gradient);border-radius:99px;transition:width .3s"></div>
    </div>
    ${mobilityExercises.map(ex => {
      const done = !!mobilityChecks[ex.id];
      return `<div style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--bg2);border:1px solid ${done ? 'var(--accent)' : 'var(--border)'};border-radius:var(--r2);transition:all .15s;${done ? 'opacity:0.7' : ''}">
        <button style="width:26px;height:26px;border-radius:50%;border:2px solid ${done ? 'transparent' : 'var(--border2)'};background:${done ? 'var(--gradient)' : 'transparent'};cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s"
          onclick="toggleMobilityCheck('${ex.id}')">
          ${done ? `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>` : ''}
        </button>
        <div style="flex:1;min-width:0">
          <div style="font-size:15px;font-weight:500;${done ? 'text-decoration:line-through;color:var(--text3)' : ''}">${escHtml(ex.name)}</div>
          ${ex.notes ? `<div style="font-size:12px;color:var(--text3);margin-top:2px">${escHtml(ex.notes)}</div>` : ''}
        </div>
        <button class="btn btn-ghost btn-sm btn-icon" onclick="openMobilityEdit('${ex.id}')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
      </div>`;
    }).join('')}`;
}

async function toggleMobilityCheck(exId) {
  mobilityChecks[exId] = !mobilityChecks[exId];
  await saveMobilityChecks();
  renderMobility();
}

let editingMobilityId = null;

function openMobilityAdd() {
  editingMobilityId = null;
  document.getElementById('mobility-modal-title').textContent = 'Add Mobility Exercise';
  document.getElementById('mobility-name-input').value = '';
  document.getElementById('mobility-notes-input').value = '';
  document.getElementById('mobility-delete-btn').style.display = 'none';
  openModal('modal-mobility-add');
}

function openMobilityEdit(exId) {
  editingMobilityId = exId;
  const ex = mobilityExercises.find(e => e.id === exId);
  if (!ex) return;
  document.getElementById('mobility-modal-title').textContent = 'Edit Exercise';
  document.getElementById('mobility-name-input').value = ex.name;
  document.getElementById('mobility-notes-input').value = ex.notes || '';
  document.getElementById('mobility-delete-btn').style.display = '';
  openModal('modal-mobility-add');
}

document.getElementById('mobility-add-btn').addEventListener('click', openMobilityAdd);
document.getElementById('mobility-reset-btn').addEventListener('click', async () => {
  mobilityChecks = {};
  await saveMobilityChecks();
  renderMobility();
  showToast('Checklist reset');
});

document.getElementById('mobility-save-btn').addEventListener('click', async () => {
  const name = document.getElementById('mobility-name-input').value.trim();
  if (!name) { showToast('Enter an exercise name'); return; }
  const notes = document.getElementById('mobility-notes-input').value.trim();

  if (editingMobilityId) {
    const idx = mobilityExercises.findIndex(e => e.id === editingMobilityId);
    if (idx >= 0) {
      mobilityExercises[idx].name = name;
      mobilityExercises[idx].notes = notes;
      await dbPut('mobility_exercises', mobilityExercises[idx]);
    }
  } else {
    const ex = {id: uid(), name, notes, order: mobilityExercises.length};
    await dbPut('mobility_exercises', ex);
  }
  closeModal('modal-mobility-add');
  await renderMobility();
  showToast(editingMobilityId ? 'Updated' : 'Exercise added');
});

document.getElementById('mobility-delete-btn').addEventListener('click', async () => {
  if (!editingMobilityId) return;
  if (!confirm('Delete this exercise?')) return;
  await dbDelete('mobility_exercises', editingMobilityId);
  delete mobilityChecks[editingMobilityId];
  await saveMobilityChecks();
  closeModal('modal-mobility-add');
  await renderMobility();
  showToast('Deleted');
});

// ═══════════════════════════════════════════════════════════════
// VARIANT EDITOR
// ═══════════════════════════════════════════════════════════════
// We store user edits in IDB 'variant_overrides' store keyed by variantId
// On load, we apply overrides to EXERCISE_LIBRARY data

async function loadVariantOverrides() {
  // Load custom equipment types first
  const customEquip = await dbGetAll('custom_equipment_types');
  customEquip.forEach(ce => {
    if (!EXERCISE_LIBRARY.equipment_types.includes(ce.id)) {
      EXERCISE_LIBRARY.equipment_types.push(ce.id);
    }
  });

  // Load custom parent exercises
  const customParents = await dbGetAll('custom_parents');
  customParents.forEach(cp => {
    if (!parentMap[cp.id]) {
      EXERCISE_LIBRARY.parents.push(cp);
      parentMap[cp.id] = cp;
      cp.variants.forEach(v => { variantMap[v.id] = {variant: v, parent: cp}; });
    }
  });

  // Load variant overrides
  const overrides = await dbGetAll('variant_overrides');
  overrides.forEach(ov => {
    const info = variantMap[ov.id];
    if (info) {
      info.variant.name = ov.name;
      info.variant.equipment = ov.equipment;
    }
  });
  // Also load custom variants
  const customVariants = await dbGetAll('custom_variants');
  customVariants.forEach(cv => {
    const parent = parentMap[cv.parentId];
    if (parent && !variantMap[cv.id]) {
      parent.variants.push({id: cv.id, name: cv.name, equipment: cv.equipment});
      variantMap[cv.id] = {variant: parent.variants[parent.variants.length-1], parent};
    }
  });
}

let editingVariantId = null;
let editingVariantParentId = null;

function buildEquipCheckboxes(containerId, selectedEquip) {
  const container = document.getElementById(containerId);
  const types = EXERCISE_LIBRARY.equipment_types;
  container.innerHTML = types.map(e => {
    const checked = selectedEquip.includes(e);
    return `<label style="display:flex;align-items:center;gap:6px;padding:6px 10px;background:${checked ? 'rgba(167,139,250,0.15)' : 'var(--bg3)'};border:1px solid ${checked ? 'var(--accent)' : 'var(--border)'};border-radius:var(--r);cursor:pointer;font-size:13px;transition:all .15s">
      <input type="checkbox" name="${containerId}-equip" value="${e}" ${checked ? 'checked' : ''} style="accent-color:var(--accent);width:14px;height:14px">
      ${e}
    </label>`;
  }).join('') + `
    <div id="${containerId}-new-equip-row" style="display:flex;align-items:center;gap:6px;margin-top:2px;width:100%">
      <input id="${containerId}-new-equip-input" type="text" placeholder="+ New type…" style="font-size:12px;padding:5px 8px;border-style:dashed;flex:1;min-width:100px">
      <button class="btn btn-ghost btn-sm" onclick="addNewEquipType('${containerId}')" style="white-space:nowrap;padding:5px 10px;font-size:12px">Add</button>
    </div>`;
  // Live highlight on change
  container.querySelectorAll('input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', () => {
      const label = cb.closest('label');
      if (cb.checked) {
        label.style.background = 'rgba(167,139,250,0.15)';
        label.style.borderColor = 'var(--accent)';
      } else {
        label.style.background = 'var(--bg3)';
        label.style.borderColor = 'var(--border)';
      }
    });
  });
}

async function addNewEquipType(containerId) {
  const input = document.getElementById(`${containerId}-new-equip-input`);
  const val = input.value.trim().toLowerCase().replace(/\s+/g, '_');
  if (!val) return;
  if (EXERCISE_LIBRARY.equipment_types.includes(val)) {
    showToast('Type already exists');
    input.value = '';
    return;
  }
  // Persist and add
  EXERCISE_LIBRARY.equipment_types.push(val);
  await dbPut('custom_equipment_types', {id: val, name: val});
  // Rebuild checkboxes, auto-checking new one
  const selected = getCheckedEquipment(containerId);
  selected.push(val);
  buildEquipCheckboxes(containerId, selected);
  showToast(`Added "${val}"`);
}

function getCheckedEquipment(containerId) {
  return [...document.querySelectorAll(`#${containerId} input[type=checkbox]:checked`)].map(cb => cb.value);
}


function openVariantEditor(parentId, variantId) {
  editingVariantId = variantId;
  editingVariantParentId = parentId;
  const info = variantMap[variantId];
  if (!info) return;

  document.getElementById('variant-editor-title').textContent = 'Edit Variant';
  document.getElementById('variant-editor-parent').textContent = info.parent.name;
  document.getElementById('ve-name').value = info.variant.name;
  buildEquipCheckboxes('ve-equip-checkboxes', info.variant.equipment);

  document.getElementById('ve-analytics-btn').onclick = () => {
    closeModal('modal-variant-editor');
    showExerciseAnalytics(variantId);
  };

  openModal('modal-variant-editor');
}

document.getElementById('ve-save-btn').addEventListener('click', async () => {
  const name = document.getElementById('ve-name').value.trim();
  if (!name) { showToast('Enter a name'); return; }
  const equipment = getCheckedEquipment('ve-equip-checkboxes');

  // Update in-memory
  const info = variantMap[editingVariantId];
  if (info) {
    info.variant.name = name;
    info.variant.equipment = equipment;
  }

  // Persist override
  await dbPut('variant_overrides', {id: editingVariantId, name, equipment});
  closeModal('modal-variant-editor');
  showToast('Variant updated');
  renderLibrary();
});

document.getElementById('ve-delete-btn').addEventListener('click', async () => {
  if (!editingVariantId || !editingVariantParentId) return;
  if (!confirm('Delete this variant? This cannot be undone.')) return;

  const parent = parentMap[editingVariantParentId];
  if (parent) {
    parent.variants = parent.variants.filter(v => v.id !== editingVariantId);
  }
  delete variantMap[editingVariantId];

  await dbDelete('variant_overrides', editingVariantId);
  await dbDelete('custom_variants', editingVariantId);

  closeModal('modal-variant-editor');
  showToast('Variant deleted');
  renderLibrary();
});

let newVariantParentId = null;

function openNewVariantModal(parentId) {
  newVariantParentId = parentId;
  const parent = parentMap[parentId];
  document.getElementById('new-variant-parent-name').textContent = parent ? parent.name : '';
  document.getElementById('nv-name').value = '';
  buildEquipCheckboxes('nv-equip-checkboxes', []);
  openModal('modal-new-variant');
}

document.getElementById('nv-save-btn').addEventListener('click', async () => {
  const name = document.getElementById('nv-name').value.trim();
  if (!name) { showToast('Enter a name'); return; }
  const equipment = getCheckedEquipment('nv-equip-checkboxes');
  if (equipment.length === 0) { showToast('Select at least one equipment type'); return; }

  const parent = parentMap[newVariantParentId];
  if (!parent) return;

  const newId = newVariantParentId + '_custom_' + Date.now().toString(36);
  const newVariant = {id: newId, name, equipment};
  parent.variants.push(newVariant);
  variantMap[newId] = {variant: newVariant, parent};

  // Persist as custom variant
  await dbPut('custom_variants', {id: newId, parentId: newVariantParentId, name, equipment});

  closeModal('modal-new-variant');
  showToast('Variant added');
  renderLibrary();
});

// ── New Parent Exercise ──────────────────────────────────────

function openNewParentModal() {
  // Populate muscle selects
  const pmSel = document.getElementById('np-primary-muscle');
  const mvSel = document.getElementById('np-movement');
  pmSel.innerHTML = '<option value="">Select…</option>' +
    EXERCISE_LIBRARY.muscle_groups.map(m => `<option value="${m}">${m}</option>`).join('');
  mvSel.innerHTML = '<option value="">Select…</option>' +
    EXERCISE_LIBRARY.movement_patterns.map(m => `<option value="${m}">${m}</option>`).join('');

  // Populate secondary muscles checkboxes
  const secContainer = document.getElementById('np-secondary-muscles');
  secContainer.innerHTML = EXERCISE_LIBRARY.muscle_groups.map(m =>
    `<label style="display:flex;align-items:center;gap:5px;padding:4px 8px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);cursor:pointer;font-size:12px;transition:all .15s">
      <input type="checkbox" name="np-sec-muscle" value="${m}" style="accent-color:var(--accent);width:12px;height:12px">
      ${m}
    </label>`
  ).join('');
  secContainer.querySelectorAll('input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', () => {
      const label = cb.closest('label');
      label.style.background = cb.checked ? 'rgba(167,139,250,0.15)' : 'var(--bg3)';
      label.style.borderColor = cb.checked ? 'var(--accent)' : 'var(--border)';
    });
  });

  // Reset fields
  document.getElementById('np-name').value = '';
  document.getElementById('np-variant-name').value = '';
  buildEquipCheckboxes('np-equip-checkboxes', []);

  openModal('modal-new-parent');
}

document.getElementById('new-parent-btn').addEventListener('click', openNewParentModal);

document.getElementById('np-save-btn').addEventListener('click', async () => {
  const name = document.getElementById('np-name').value.trim();
  if (!name) { showToast('Enter an exercise name'); return; }
  const primary = document.getElementById('np-primary-muscle').value;
  if (!primary) { showToast('Select a primary muscle'); return; }
  const movement = document.getElementById('np-movement').value;
  if (!movement) { showToast('Select a movement pattern'); return; }
  const secondary = [...document.querySelectorAll('#np-secondary-muscles input[type=checkbox]:checked')].map(cb => cb.value);
  const variantName = document.getElementById('np-variant-name').value.trim() || name;
  const equipment = getCheckedEquipment('np-equip-checkboxes');

  const parentId = 'custom_' + name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '') + '_' + Date.now().toString(36);
  const variantId = parentId + '_v1';
  const firstVariant = {id: variantId, name: variantName, equipment};
  const newParent = {
    id: parentId,
    name,
    primary_muscles: [primary],
    secondary_muscles: secondary,
    movement_pattern: movement,
    variants: [firstVariant]
  };

  EXERCISE_LIBRARY.parents.push(newParent);
  parentMap[parentId] = newParent;
  variantMap[variantId] = {variant: firstVariant, parent: newParent};

  await dbPut('custom_parents', newParent);

  closeModal('modal-new-parent');
  showToast(`"${name}" added`);
  renderLibrary();
});

// ═══════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════
// ═══════════════════════════════════════════════════════════════
// REST TIMER
// ═══════════════════════════════════════════════════════════════
let restTimerInterval = null;
let restTimerRemaining = 0;
let restTimerDuration = 90; // default 90s, configurable

function startRestTimer(seconds) {
  clearInterval(restTimerInterval);
  restTimerRemaining = seconds || restTimerDuration;
  const bar = document.getElementById('rest-timer-bar');
  const toast = document.getElementById('rest-timer-toast');
  const label = document.getElementById('rest-timer-label');
  bar.style.display = 'block';
  toast.classList.add('show');
  // Animate bar
  bar.style.transition = 'none';
  bar.style.transform = 'scaleX(1)';
  // Slight delay so transition kicks in
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      bar.style.transition = `transform ${restTimerRemaining}s linear`;
      bar.style.transform = 'scaleX(0)';
    });
  });

  function tick() {
    restTimerRemaining--;
    const m = Math.floor(restTimerRemaining / 60);
    const s = restTimerRemaining % 60;
    label.textContent = `${m}:${s.toString().padStart(2,'0')}`;
    if (restTimerRemaining <= 0) {
      clearInterval(restTimerInterval);
      pingRestTimer();
      setTimeout(hideRestTimer, 2000);
    }
  }
  tick();
  restTimerInterval = setInterval(tick, 1000);
}

function skipRestTimer() {
  clearInterval(restTimerInterval);
  hideRestTimer();
}

function hideRestTimer() {
  document.getElementById('rest-timer-bar').style.display = 'none';
  document.getElementById('rest-timer-toast').classList.remove('show');
}

function pingRestTimer() {
  // Web Audio API beep
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    [0, 0.15, 0.3].forEach(t => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.frequency.value = 880;
      gain.gain.setValueAtTime(0.3, ctx.currentTime + t);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + t + 0.12);
      osc.start(ctx.currentTime + t);
      osc.stop(ctx.currentTime + t + 0.15);
    });
  } catch(e) {}
  document.getElementById('rest-timer-label').textContent = 'Go!';
  document.getElementById('rest-timer-toast').style.color = 'var(--green)';
  setTimeout(() => {
    document.getElementById('rest-timer-toast').style.color = '';
  }, 2000);
}

// ═══════════════════════════════════════════════════════════════
// PR DETECTION
// ═══════════════════════════════════════════════════════════════
let prRecords = {}; // variantId -> {weight, e1rm, reps}

async function loadPRRecords() {
  const records = await dbGetAll('pr_records');
  prRecords = {};
  records.forEach(r => { prRecords[r.variantId] = r; });
}

function epley1RM(w, r) { return r === 1 ? w : w * (1 + r / 30); }

async function checkForPR(variantId, weight, reps) {
  if (!weight || !reps) return false;
  const e1rm = epley1RM(weight, reps);
  const existing = prRecords[variantId];
  let isPR = false;

  if (!existing || e1rm > existing.e1rm || weight > existing.weight) {
    isPR = true;
    prRecords[variantId] = { variantId, weight, reps, e1rm, date: Date.now() };
    await dbPut('pr_records', prRecords[variantId]);
  }
  return isPR;
}

// ═══════════════════════════════════════════════════════════════
// EXERCISE NOTES / CUES
// ═══════════════════════════════════════════════════════════════
let exerciseNotes = {}; // variantId -> string
let editingExNotesVariantId = null;

async function loadExerciseNotes() {
  const notes = await dbGetAll('exercise_notes');
  exerciseNotes = {};
  notes.forEach(n => { exerciseNotes[n.variantId] = n.note; });
}

function openExNotesModal(variantId) {
  editingExNotesVariantId = variantId;
  const info = variantMap[variantId];
  document.getElementById('ex-notes-modal-sub').textContent = info ? info.variant.name : variantId;
  document.getElementById('ex-notes-input').value = exerciseNotes[variantId] || '';
  openModal('modal-ex-notes');
}

document.getElementById('ex-notes-save-btn').addEventListener('click', async () => {
  const note = document.getElementById('ex-notes-input').value.trim();
  if (editingExNotesVariantId) {
    if (note) {
      exerciseNotes[editingExNotesVariantId] = note;
      await dbPut('exercise_notes', { variantId: editingExNotesVariantId, note });
    } else {
      delete exerciseNotes[editingExNotesVariantId];
      await dbDelete('exercise_notes', editingExNotesVariantId);
    }
  }
  closeModal('modal-ex-notes');
  renderActiveSession();
});

// ═══════════════════════════════════════════════════════════════
// SWAP VARIANT
// ═══════════════════════════════════════════════════════════════
let swapVariantExIdx = null;

function openSwapVariantModal(exIdx) {
  swapVariantExIdx = exIdx;
  const ex = activeSession.exercises[exIdx];
  const info = variantMap[ex.variantId];
  if (!info) return;

  document.getElementById('swap-variant-parent-name').textContent = info.parent.name;
  const variants = info.parent.variants.filter(v => v.id !== ex.variantId);
  const list = document.getElementById('swap-variant-list');
  list.innerHTML = variants.map(v => `
    <div class="variant-row" onclick="swapVariant('${v.id}')">
      <div class="variant-row-left">
        <div class="variant-name">${escHtml(v.name)}</div>
        <div class="variant-equip-tags">${(v.equipment||[]).map(e => `<span class="tag tag-equipment">${e}</span>`).join('')}</div>
      </div>
    </div>`).join('');

  if (variants.length === 0) {
    list.innerHTML = '<div style="color:var(--text3);font-size:13px;padding:8px 0">No other variants available</div>';
  }
  openModal('modal-swap-variant');
}

function swapVariant(newVariantId) {
  if (swapVariantExIdx === null || !activeSession) return;
  activeSession.exercises[swapVariantExIdx].variantId = newVariantId;
  closeModal('modal-swap-variant');
  renderActiveSession();
  showToast('Variant swapped');
}

// ═══════════════════════════════════════════════════════════════
// REORDER EXERCISES
// ═══════════════════════════════════════════════════════════════
function moveExercise(exIdx, direction) {
  if (!activeSession) return;
  const exs = activeSession.exercises;
  const newIdx = exIdx + direction;
  if (newIdx < 0 || newIdx >= exs.length) return;
  [exs[exIdx], exs[newIdx]] = [exs[newIdx], exs[exIdx]];
  // Swap collapsed state
  const aCollapsed = collapsedExercises.has(exIdx);
  const bCollapsed = collapsedExercises.has(newIdx);
  collapsedExercises.delete(exIdx); collapsedExercises.delete(newIdx);
  if (aCollapsed) collapsedExercises.add(newIdx);
  if (bCollapsed) collapsedExercises.add(exIdx);
  renderActiveSession();
}

// ═══════════════════════════════════════════════════════════════
// REPEAT WORKOUT
// ═══════════════════════════════════════════════════════════════
let repeatWorkoutSessionId = null;

document.getElementById('ex-repeat-btn').addEventListener('click', async () => {
  if (!repeatWorkoutSessionId) return;
  const session = await dbGet('sessions', repeatWorkoutSessionId);
  if (!session) return;

  closeModal('modal-exercise-detail');

  // Build fresh exercises from the session, clearing set completion
  const exercises = session.exercises.map(ex => ({
    variantId: ex.variantId,
    supersetId: ex.supersetId || null,
    sets: ex.sets.map(s => ({
      weight: s.weight || 0,
      reps: s.reps || 0,
      completed: false,
      completedAt: null,
      rpe: null,
      restSeconds: null,
      notes: ''
    }))
  }));

  activeSession = {
    id: uid(),
    title: session.title,
    startTime: Date.now(),
    notes: '',
    exercises
  };

  sessionStartEpoch = activeSession.startTime;
  document.getElementById('active-session').classList.add('open');
  document.getElementById('session-notes-input').value = '';
  clearInterval(sessionTimerInterval);
  sessionTimerInterval = setInterval(updateTimer, 1000);
  renderActiveSession();
  showToast('Repeating workout');
});

// ═══════════════════════════════════════════════════════════════
// EXPORT FOR CLAUDE
// ═══════════════════════════════════════════════════════════════
document.getElementById('export-claude-btn').addEventListener('click', async () => {
  const text = await buildClaudeExport();
  document.getElementById('export-claude-text').value = text;
  openModal('modal-export-claude');
});

document.getElementById('export-copy-btn').addEventListener('click', () => {
  const text = document.getElementById('export-claude-text').value;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('export-copy-btn');
    btn.textContent = '✓ Copied!';
    btn.style.background = 'var(--green)';
    setTimeout(() => {
      btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>Copy to clipboard`;
      btn.style.background = '';
    }, 2000);
  });
});

async function buildClaudeExport() {
  const sessions = await getSortedSessions();
  const bwEntries = await dbGetAll('bodyweight');
  bwEntries.sort((a,b) => a.date.localeCompare(b.date));
  const latestBW = bwEntries.length ? bwEntries[bwEntries.length - 1] : null;

  const lines = [];
  const today = new Date().toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'});

  lines.push(`# IronLog Training Summary`);
  lines.push(`Generated: ${today}`);
  if (latestBW) lines.push(`Bodyweight: ${latestBW.weight_lbs} lbs (${latestBW.date})`);
  lines.push('');

  // ── Recent workouts (last 8) ──
  lines.push(`## Recent Workouts`);
  lines.push('');

  const recent = sessions.slice(0, 8);
  for (const s of recent) {
    const date = new Date(s.startTime).toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
    const dur = s.durationMinutes ? ` · ${s.durationMinutes}m` : '';
    const bwDate = new Date(s.startTime).toISOString().split('T')[0];
    const bw = bwEntries.find(e => e.date === bwDate);
    const bwStr = bw ? ` · ${bw.weight_lbs} lbs` : '';
    lines.push(`### ${s.title} — ${date}${dur}${bwStr}`);
    if (s.notes) lines.push(`*${s.notes}*`);

    for (const ex of s.exercises) {
      const { displayName } = getVariantInfo(ex.variantId);
      const completedSets = ex.sets.filter(st => st.completed && (st.weight || st.reps));
      if (completedSets.length === 0) continue;

      // Format sets: group identical weight×reps as "3×8 @ 185"
      const setStrs = [];
      let i = 0;
      while (i < completedSets.length) {
        const s = completedSets[i];
        let count = 1;
        while (i + count < completedSets.length &&
               completedSets[i + count].weight === s.weight &&
               completedSets[i + count].reps === s.reps) count++;
        const rpeStr = s.rpe ? ` @RPE${s.rpe}` : '';
        if (s.weight) {
          setStrs.push(count > 1 ? `${count}×${s.reps} @ ${s.weight}lbs${rpeStr}` : `${s.weight}×${s.reps}${rpeStr}`);
        } else {
          setStrs.push(count > 1 ? `${count}×${s.reps}${rpeStr}` : `${s.reps} reps${rpeStr}`);
        }
        i += count;
      }

      // Check for PR on this session
      const sessionE1rm = completedSets.reduce((best, st) => Math.max(best, epley1RM(st.weight||0, st.reps||0)), 0);
      const prEntry = prRecords[ex.variantId];
      const isPR = prEntry && Math.abs(prEntry.e1rm - sessionE1rm) < 0.5 && new Date(prEntry.date).toDateString() === new Date(s.startTime).toDateString();

      lines.push(`- **${displayName}**: ${setStrs.join(', ')}${isPR ? ' 🏆' : ''}`);
    }
    lines.push('');
  }

  // ── Top lifts ──
  lines.push(`## Top Lifts (Est. 1RM)`);
  lines.push('');
  const allVariants = Object.keys(prRecords);
  if (allVariants.length === 0) {
    lines.push('No lift records yet.');
  } else {
    const sorted = allVariants
      .map(vid => ({ vid, ...prRecords[vid] }))
      .sort((a,b) => b.e1rm - a.e1rm)
      .slice(0, 12);
    for (const r of sorted) {
      const { displayName } = getVariantInfo(r.vid);
      const date = r.date ? new Date(r.date).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'2-digit'}) : '';
      lines.push(`- **${displayName}**: ~${Math.round(r.e1rm)} lbs (${r.weight}×${r.reps}${date ? ', ' + date : ''})`);
    }
  }
  lines.push('');

  // ── Volume trend (last 4 weeks by muscle group) ──
  lines.push(`## Volume — Last 4 Weeks by Muscle`);
  lines.push('');
  const cutoff4w = Date.now() - 28 * 86400000;
  const last4w = sessions.filter(s => s.startTime >= cutoff4w);
  const muscleVol = {};
  EXERCISE_LIBRARY.muscle_groups.forEach(m => { muscleVol[m] = {sets: 0, vol: 0}; });
  last4w.forEach(s => {
    s.exercises.forEach(ex => {
      const info = variantMap[ex.variantId];
      if (!info) return;
      const done = ex.sets.filter(st => st.completed);
      const vol = done.reduce((sum, st) => sum + (st.weight||0)*(st.reps||0), 0);
      [...info.parent.primary_muscles, ...info.parent.secondary_muscles].forEach(m => {
        if (muscleVol[m]) { muscleVol[m].sets += done.length; muscleVol[m].vol += vol; }
      });
    });
  });
  const muscleLines = EXERCISE_LIBRARY.muscle_groups
    .map(m => ({ m, ...muscleVol[m] }))
    .filter(x => x.sets > 0)
    .sort((a,b) => b.sets - a.sets);
  if (muscleLines.length === 0) {
    lines.push('No data in last 4 weeks.');
  } else {
    muscleLines.forEach(x => {
      lines.push(`- **${x.m}**: ${x.sets} sets, ${Math.round(x.vol/1000)}k lbs volume`);
    });
  }
  lines.push('');

  // ── Templates ──
  const templates = await dbGetAll('templates');
  if (templates.length > 0) {
    lines.push(`## Templates`);
    lines.push('');
    templates.forEach(t => {
      const exNames = t.exercises.map(e => getVariantInfo(e.variantId).displayName).join(', ');
      lines.push(`- **${t.name}**: ${exNames}`);
    });
    lines.push('');
  }

  lines.push(`---`);
  lines.push(`*Paste this into Claude and ask: "Based on my recent training, help me plan today's workout."*`);

  return lines.join('\n');
}

async function migrateToSupabase() {
  const migrationKey = 'supabase_migrated_v1';
  if (localStorage.getItem(migrationKey)) return;
  try {
    // Check if Supabase already has data
    const existingSessions = await sbGetAll('sessions');
    if (existingSessions.length === 0) {
      // Migrate sessions from IndexedDB
      const localSessions = await idbGetAll('sessions');
      for (const s of localSessions) await sbPut('sessions', s);
    }
    const existingTemplates = await sbGetAll('templates');
    if (existingTemplates.length === 0) {
      const localTemplates = await idbGetAll('templates');
      for (const t of localTemplates) await sbPut('templates', t);
    }
    localStorage.setItem(migrationKey, '1');
    console.log('Migrated local data to Supabase');
  } catch(e) {
    console.warn('Migration failed, will retry next load:', e);
  }
}

async function init() {
  await openDB();
  migrateToSupabase().catch(e => console.warn('Migration skipped:', e));
  await Promise.allSettled([
    loadVariantOverrides(),
    loadPRRecords(),
    loadExerciseNotes(),
  ]);
  await seedBWData().catch(e => console.warn('seedBW skipped:', e));
  await seedDefaultTemplates().catch(e => console.warn('seedTemplates skipped:', e));

  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = '';

  renderHome();
}

init().catch(e => {
  console.error('Init failed:', e);
  // Show app anyway so user isn't stuck on loading screen
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = '';
  renderHome();
});





// Register service worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  });
}
</script>
</body>
</html>
